{% extends 'base.html' %}

{% block title %}Dashboard · ATTSYS · SIGNAL LOCK{% endblock %}

{% block extra_css %}
<style>
    /* ---------------------------------------------------------------
       DASHBOARD — WHITE MAIN, DARK BLUE ACCENTS — WOW EFFECTS
       Radio frequency, oscilloscope, transmission ripples
       FIXED: Create Event button visible · NO FEEDBACK/RATING ELEMENTS
    --------------------------------------------------------------- */
    
    /* ===== SIGNAL STRENGTH BARS (animated) ===== */
    .signal-strength {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 4px;
        height: 40px;
    }
    .signal-strength .bar {
        width: 6px;
        background: var(--dark-blue, #1a2b4c);
        height: 10px;
        animation: signalPulse 1.2s infinite alternate;
        opacity: 0.7;
        border-radius: 2px;
    }
    .signal-strength .bar:nth-child(1) { height: 16px; animation-delay: 0s; }
    .signal-strength .bar:nth-child(2) { height: 24px; animation-delay: 0.2s; }
    .signal-strength .bar:nth-child(3) { height: 32px; animation-delay: 0.4s; }
    .signal-strength .bar:nth-child(4) { height: 28px; animation-delay: 0.1s; }
    .signal-strength .bar:nth-child(5) { height: 20px; animation-delay: 0.3s; }
    @keyframes signalPulse {
        0% { opacity: 0.3; height: 12px; }
        100% { opacity: 1; height: 36px; }
    }

    /* ===== STAT RINGS (oscilloscope style) ===== */
    .stat-ring-progress {
        fill: none;
        stroke-width: 3;
        stroke-linecap: round;
        stroke-dasharray: 251.2;
        stroke-dashoffset: 251.2;
        transition: stroke-dashoffset 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        stroke: var(--dark-blue, #1a2b4c);
    }
    .stat-ring-bg {
        fill: none;
        stroke: rgba(26,43,76,0.08);
        stroke-width: 3;
    }

    /* ===== PROGRESS BAR ===== */
    .progress-container {
        width: 100%;
        height: 6px;
        background: rgba(26,43,76,0.08);
        border-radius: 999px;
        overflow: hidden;
        position: relative;
    }
    .progress-fill {
        height: 100%;
        background: var(--dark-blue, #1a2b4c);
        border-radius: 999px;
        transition: width 1s ease;
        max-width: 100%;
        width: 0%;
    }
    
    /* ===== SCAN PROGRESS (WOW effect) ===== */
    .scan-progress {
        position: relative;
        overflow: hidden;
        background: rgba(26,43,76,0.08);
        border-radius: 999px;
        height: 6px;
    }
    .scan-progress .progress-fill {
        position: relative;
        overflow: hidden;
    }
    .scan-progress .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: -20%;
        width: 40%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: scanSweep 2s ease-in-out infinite;
    }
    @keyframes scanSweep {
        0% { left: -40%; }
        100% { left: 140%; }
    }

    /* ===== TRANSMISSION RIPPLES ===== */
    .transmission-ripple {
        position: relative;
    }
    .transmission-ripple::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        border: 1px solid var(--dark-blue, #1a2b4c);
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
        animation: ripple 2s ease-out infinite;
        pointer-events: none;
    }
    @keyframes ripple {
        0% {
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0.5;
            border-width: 1px;
        }
        100% {
            transform: translate(-50%, -50%) scale(1.8);
            opacity: 0;
            border-width: 0.5px;
        }
    }

    /* ===== FREQUENCY GLITCH ===== */
    .glitch-text {
        animation: glitch 3s infinite;
    }
    @keyframes glitch {
        0%, 100% { text-shadow: 0 0 0 rgba(26,43,76,0.3); }
        25% { text-shadow: -1px 0 0 rgba(26,43,76,0.3), 1px 0 0 rgba(26,43,76,0.2); }
        75% { text-shadow: 1px 0 0 rgba(26,43,76,0.3), -1px 0 0 rgba(26,43,76,0.2); }
    }

    /* ===== DATA ROW HOVER ===== */
    .data-row {
        border-bottom: 1px solid rgba(26,43,76,0.05);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .data-row:hover {
        background: rgba(26,43,76,0.02);
        transform: translateX(4px);
    }

    /* ===== REVEAL ANIMATION ===== */
    .reveal {
        opacity: 0;
        transform: translateY(16px);
        transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .reveal.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* ===== CARD HOVER LIFT ===== */
    .card-lift {
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .card-lift:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 32px -8px rgba(26,43,76,0.15);
    }

    /* ===== BUTTON DARK BLUE — PROMINENT, HIGH CONTRAST ===== */
    .btn-dark-blue {
        background: var(--dark-blue, #1a2b4c);
        color: white;
        border: 1px solid var(--gray-700);
        box-shadow: var(--neu-raised-sm);
        transition: all 0.2s ease;
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    .btn-dark-blue:hover {
        background: var(--dark-blue-light, #2c3e5e);
        transform: translateY(-3px);
        box-shadow: 0 16px 24px -8px rgba(26,43,76,0.25);
        color: white;
    }
    .btn-dark-blue:active {
        transform: translateY(1px);
        box-shadow: var(--neu-inset-flat);
    }

    /* ===== NEW EVENT BUTTON — DARK BLUE ===== */
    .btn-new-event {
        background: #1a2b4c !important;
        color: white !important;
        border: 1px solid #404040 !important;
        box-shadow: 0 8px 20px -6px rgba(26,43,76,0.3) !important;
        padding: 0.75rem 1.8rem !important;
        border-radius: 40px !important;
        font-weight: 700 !important;
        letter-spacing: 0.02em;
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        transition: all 0.25s ease !important;
    }
    .btn-new-event:hover {
        background: #2c3e5e !important;
        transform: translateY(-4px) !important;
        box-shadow: 0 18px 28px -8px rgba(26,43,76,0.4) !important;
    }
    .btn-new-event i {
        font-size: 1.1rem;
    }

    /* ===== EMPTY STATE ACTION BUTTON ===== */
    .btn-create-first {
        background: #1a2b4c !important;
        color: white !important;
        padding: 0.7rem 2rem !important;
        border-radius: 40px !important;
        font-weight: 600;
        display: inline-block;
        margin-top: 1rem;
        border: 1px solid var(--gray-700);
        box-shadow: var(--neu-raised-sm);
    }
    .btn-create-first:hover {
        background: #2c3e5e;
        transform: translateY(-2px);
    }

    /* ===== SCROLLABLE TABLE STYLES ===== */
    .events-table-container {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 0 0 1rem 1rem;
        scrollbar-width: thin;
        scrollbar-color: #cccccc #f5f5f5;
    }
    
    .events-table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .events-table-container::-webkit-scrollbar-track {
        background: #f5f5f5;
        border-radius: 10px;
    }
    
    .events-table-container::-webkit-scrollbar-thumb {
        background: #cccccc;
        border-radius: 10px;
    }
    
    .events-table-container::-webkit-scrollbar-thumb:hover {
        background: #999999;
    }
    
    .sticky-header {
        position: sticky;
        top: 0;
        background: #f5f5f5;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(26,43,76,0.02);
    }
    
    /* ===== TOTAL SIGNALS BADGE ===== */
    .signals-badge {
        background: #1a2b4c;
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.2rem 0.8rem;
        border-radius: 999px;
        letter-spacing: 0.3px;
    }
</style>
{% endblock %}

{% block content %}
<!-- ===== DASHBOARD HEADER — SIGNAL STRENGTH ===== -->
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 reveal">
    <div>
        <div class="inline-flex items-center gap-3 px-4 py-2 neu-inset rounded-full mb-4">
            <div class="signal-strength !h-5">
                <div class="bar !w-1.5"></div>
                <div class="bar !w-1.5"></div>
                <div class="bar !w-1.5"></div>
                <div class="bar !w-1.5"></div>
                <div class="bar !w-1.5"></div>
            </div>
            <span class="text-xs font-mono text-gray-600 tracking-wider">LIVE · DASHBOARD</span>
            <span class="text-xs font-mono bg-[#1a2b4c] text-white px-2 py-0.5 rounded-full">RX</span>
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-[#1a2b4c] tracking-tight glitch-text">
            Welcome back,
            <span class="text-gray-600">{{ user.username }}</span>
        </h1>
        <p class="text-gray-500 text-base max-w-2xl mt-2">
            {% if user.role == 'ADMIN' %}
            System · performance · signal strength · <span class="font-mono">104.7 MHz</span>
            {% elif user.role == 'STAFF' %}
            Monitor events · create new transmissions · real‑time telemetry
            {% else %}
            Monitor events and attendance · real‑time telemetry
            {% endif %}
        </p>
    </div>
    <div class="flex items-center gap-4 mt-4 md:mt-0">
        <!-- ===== VISIBLE, HIGH-CONTRAST CREATE EVENT BUTTON ===== -->
        {% if user.role == 'STAFF' %}
        <a href="{% url 'create_event' %}" 
           class="btn-new-event">
            <i class="bi bi-plus-circle-fill"></i> New Event
            <i class="bi bi-arrow-right-short"></i>
        </a>
        {% endif %}
    </div>
</div>

<!-- ===== STATS GRID — WHITE CARDS, DARK BLUE RINGS ===== -->
<!-- FEEDBACK/RATING CARD COMPLETELY REMOVED - NOW ONLY 3 CARDS FOR NON-ADMIN -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Events -->
    <div class="neu-raised rounded-2xl p-5 card-lift reveal">
        <div class="flex items-start justify-between">
            <div>
                <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">EVENTS</span>
                <div class="text-3xl font-bold text-[#1a2b4c] mt-1 flex items-baseline">
                    <span id="eventCounter">0</span>
                    <span class="text-sm text-gray-400 ml-2 font-mono">TOTAL</span>
                </div>
                <div class="flex items-center gap-2 mt-3">
                    <span class="inline-flex items-center gap-1 text-xs bg-[#1a2b4c]/5 text-gray-700 px-2 py-1 rounded-full border border-[#1a2b4c]/10">
                        <span class="w-1.5 h-1.5 bg-green-600 rounded-full animate-pulse"></span>
                        {{ active_events }} active
                    </span>
                </div>
            </div>
            <div class="w-16 h-16 relative transmission-ripple">
                <svg viewBox="0 0 100 100" class="transform -rotate-90 w-16 h-16">
                    <circle cx="50" cy="50" r="40" class="stat-ring-bg"></circle>
                    <circle cx="50" cy="50" r="40" class="stat-ring-progress" 
                            id="eventRing" stroke-dashoffset="251.2"></circle>
                </svg>
                <i class="bi bi-calendar-week absolute inset-0 flex items-center justify-center text-[#1a2b4c] text-xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-[#1a2b4c]/5 text-xs text-gray-400 flex justify-between">
            <span>ACTIVE RATE</span>
            <span class="text-[#1a2b4c] font-mono" id="activeRate">
                {% if total_events > 0 %}{% widthratio active_events total_events 100 %}{% else %}0{% endif %}%
            </span>
        </div>
    </div>

    <!-- Total Attendees -->
    <div class="neu-raised rounded-2xl p-5 card-lift reveal">
        <div class="flex items-start justify-between">
            <div>
                <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">ATTENDEES</span>
                <div class="text-3xl font-bold text-[#1a2b4c] mt-1">
                    <span id="attendeeCounter">0</span>
                </div>
                <div class="flex items-center gap-2 mt-3">
                    <span class="inline-flex items-center gap-1 text-xs bg-[#1a2b4c]/5 text-gray-700 px-2 py-1 rounded-full border border-[#1a2b4c]/10">
                        <i class="bi bi-arrow-up-short"></i> +{{ today_checkins|default:0 }} today
                    </span>
                </div>
            </div>
            <div class="w-16 h-16 relative transmission-ripple">
                <svg viewBox="0 0 100 100" class="transform -rotate-90 w-16 h-16">
                    <circle cx="50" cy="50" r="40" class="stat-ring-bg"></circle>
                    <circle cx="50" cy="50" r="40" class="stat-ring-progress" 
                            id="attendeeRing" stroke-dashoffset="251.2"></circle>
                </svg>
                <i class="bi bi-people absolute inset-0 flex items-center justify-center text-[#1a2b4c] text-xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-[#1a2b4c]/5 text-xs text-gray-400 flex justify-between">
            <span>DAILY GROWTH</span>
            <span class="text-[#1a2b4c] font-mono">
                {% with growth=today_checkins|default:0 %}
                {% if total_attendees > 0 %}{% widthratio growth total_attendees 100 %}{% else %}0{% endif %}%
                {% endwith %}
            </span>
        </div>
    </div>

    <!-- Staff Card (ADMIN) or Applications Card (STAFF/USER) -->
    {% if user.role == 'ADMIN' %}
    <div class="neu-raised rounded-2xl p-5 card-lift reveal">
        <div class="flex items-start justify-between">
            <div>
                <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">STAFF</span>
                <div class="text-3xl font-bold text-[#1a2b4c] mt-1">
                    <span id="staffCounter">0</span>
                </div>
                <a href="{% url 'manage_staff' %}" class="inline-flex items-center gap-1 text-xs text-gray-500 hover:text-[#1a2b4c] mt-3 group">
                    Manage <i class="bi bi-arrow-right group-hover:translate-x-1 transition"></i>
                </a>
            </div>
            <div class="w-16 h-16 relative transmission-ripple">
                <svg viewBox="0 0 100 100" class="transform -rotate-90 w-16 h-16">
                    <circle cx="50" cy="50" r="40" class="stat-ring-bg"></circle>
                    <circle cx="50" cy="50" r="40" class="stat-ring-progress" 
                            id="staffRing" stroke-dashoffset="75.36"></circle>
                </svg>
                <i class="bi bi-person-badge absolute inset-0 flex items-center justify-center text-[#1a2b4c] text-xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-[#1a2b4c]/5 text-xs text-gray-400 flex justify-between">
            <span>CAPACITY</span>
            <span class="text-[#1a2b4c] font-mono">70%</span>
        </div>
    </div>
    {% else %}
    <div class="neu-raised rounded-2xl p-5 card-lift reveal">
        <div class="flex items-start justify-between">
            <div>
                <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">APPLICATIONS</span>
                <div class="text-3xl font-bold text-[#1a2b4c] mt-1">
                    <span id="applicationCounter">0</span>
                </div>
                <div class="flex items-center gap-2 mt-3">
                    <span class="inline-flex items-center gap-1 text-xs bg-[#1a2b4c]/5 text-gray-700 px-2 py-1 rounded-full border border-[#1a2b4c]/10">
                        <i class="bi bi-file-text"></i> {{ total_applications|default:0 }} submitted
                    </span>
                </div>
            </div>
            <div class="w-16 h-16 relative transmission-ripple">
                <svg viewBox="0 0 100 100" class="transform -rotate-90 w-16 h-16">
                    <circle cx="50" cy="50" r="40" class="stat-ring-bg"></circle>
                    <circle cx="50" cy="50" r="40" class="stat-ring-progress" 
                            id="appRing" stroke-dashoffset="251.2"></circle>
                </svg>
                <i class="bi bi-file-text absolute inset-0 flex items-center justify-center text-[#1a2b4c] text-xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-[#1a2b4c]/5 text-xs text-gray-400 flex justify-between">
            <span>COMPLETION</span>
            <span class="text-[#1a2b4c] font-mono">
                {% if total_attendees > 0 %}{% widthratio total_applications|default:0 total_attendees 100 %}{% else %}0{% endif %}%
            </span>
        </div>
    </div>
    {% endif %}

    <!-- Fourth Card - System Health for Admin, Total Registrations for Others -->
    {% if user.role == 'ADMIN' %}
    <!-- Admin sees fourth card as System Health (replaces rating) -->
    <div class="neu-raised rounded-2xl p-5 card-lift reveal">
        <div class="flex items-start justify-between">
            <div>
                <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">SYSTEM</span>
                <div class="text-3xl font-bold text-[#1a2b4c] mt-1">
                    <span id="systemHealth">98%</span>
                </div>
                <div class="flex items-center gap-1 mt-3">
                    <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                    <span class="text-xs text-gray-600">carrier locked</span>
                </div>
            </div>
            <div class="w-16 h-16 relative transmission-ripple">
                <svg viewBox="0 0 100 100" class="transform -rotate-90 w-16 h-16">
                    <circle cx="50" cy="50" r="40" class="stat-ring-bg"></circle>
                    <circle cx="50" cy="50" r="40" class="stat-ring-progress" 
                            id="systemRing" stroke-dashoffset="25.12"></circle>
                </svg>
                <i class="bi bi-broadcast absolute inset-0 flex items-center justify-center text-[#1a2b4c] text-xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-[#1a2b4c]/5 text-xs text-gray-400 flex justify-between">
            <span>UPTIME</span>
            <span class="text-[#1a2b4c] font-mono">99.9%</span>
        </div>
    </div>
    {% else %}
    <!-- Non-admin sees Total Registrations (DONE + PARTIAL) as fourth card -->
    <div class="neu-raised rounded-2xl p-5 card-lift reveal">
        <div class="flex items-start justify-between">
            <div>
                <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">TOTAL REGISTRATIONS</span>
                <div class="text-3xl font-bold text-[#1a2b4c] mt-1">
                    <span id="totalRegistrations">{{ total_registrations|default:0 }}</span>
                </div>
            </div>
            <div class="w-16 h-16 relative transmission-ripple">
                <svg viewBox="0 0 100 100" class="transform -rotate-90 w-16 h-16">
                    <circle cx="50" cy="50" r="40" class="stat-ring-bg"></circle>
                    <circle cx="50" cy="50" r="40" class="stat-ring-progress" 
                            id="registrationsRing" stroke-dashoffset="188.4"></circle>
                </svg>
                <i class="bi bi-journal-check absolute inset-0 flex items-center justify-center text-[#1a2b4c] text-xl"></i>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-[#1a2b4c]/5 text-xs text-gray-400 flex justify-between">
            <span>REGISTRATION RATE</span>
            <span class="text-[#1a2b4c] font-mono" id="registrationRate">
                {% if total_attendees > 0 %}{% widthratio total_registrations|default:0 total_attendees 100 %}{% else %}0{% endif %}%
            </span>
        </div>
    </div>
    {% endif %}
</div>

<!-- ===== MAIN DASHBOARD GRID ===== -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- RECENT EVENTS TABLE - NOW SHOWS ALL EVENTS WITH SCROLL -->
    <div class="lg:col-span-2">
        <div class="neu-raised rounded-2xl overflow-hidden reveal">
            <div class="p-5 border-b border-[#1a2b4c]/10 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="signal-strength !h-6">
                        <div class="bar !w-1 !h-4"></div>
                        <div class="bar !w-1 !h-6"></div>
                        <div class="bar !w-1 !h-8"></div>
                        <div class="bar !w-1 !h-6"></div>
                        <div class="bar !w-1 !h-4"></div>
                    </div>
                    <h3 class="font-semibold text-[#1a2b4c]">ALL TRANSMISSIONS · EVENTS</h3>
                </div>
                <span class="signals-badge">{{ events|length }} signals</span>
            </div>
            
            <!-- Scrollable Table Container -->
            <div class="events-table-container">
                <table class="w-full text-sm">
                    <thead class="sticky-header text-gray-500 text-xs font-mono">
                        <tr>
                            <th class="px-5 py-3 text-left">EVENT</th>
                            <th class="px-5 py-3 text-left">DATE</th>
                            <th class="px-5 py-3 text-left">ATTENDANCE</th>
                            <th class="px-5 py-3 text-left">STATUS</th>
                            <th class="px-5 py-3 text-left"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr class="data-row" onclick="window.location='{% url 'event_detail' event.id %}'">
                            <td class="px-5 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="neu-flat w-9 h-9 rounded-lg flex items-center justify-center">
                                        <i class="bi bi-calendar-event text-[#1a2b4c]"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-[#1a2b4c]">{{ event.title|truncatechars:25 }}</div>
                                        <div class="text-xs text-gray-400">{{ event.venue|truncatechars:18 }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-5 py-4">
                                <div class="text-[#1a2b4c]">{{ event.date|date:"M d, Y" }}</div>
                                {% if event.start_time %}
                                <div class="text-xs text-gray-400">{{ event.start_time|time:"g:i A" }}</div>
                                {% endif %}
                            </td>
                            <td class="px-5 py-4">
                                <span class="text-[#1a2b4c] font-mono">{{ event.attendees.count }}</span>
                                <span class="text-xs text-gray-400"> checked</span>
                            </td>
                            <td class="px-5 py-4">
                                {% if event.is_active %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs bg-green-50 text-green-700 border border-green-200">
                                    <span class="w-1.5 h-1.5 bg-green-600 rounded-full animate-pulse"></span> ACTIVE
                                </span>
                                {% else %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs bg-[#1a2b4c]/5 text-gray-500 border border-[#1a2b4c]/10">
                                    <span class="w-1.5 h-1.5 bg-gray-300 rounded-full"></span> INACTIVE
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-5 py-4">
                                <i class="bi bi-arrow-up-right-circle text-gray-300 hover:text-[#1a2b4c] transition"></i>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-5 py-12 text-center text-gray-400">
                                <i class="bi bi-wifi-off text-3xl mb-2 block"></i>
                                <span class="font-mono">NO EVENTS FOUND</span>
                                {% if user.role == 'STAFF' %}
                                <div class="mt-6">
                                    <a href="{% url 'create_event' %}" class="btn-create-first">
                                        <i class="bi bi-plus-circle"></i> CREATE FIRST EVENT
                                    </a>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Event count footer -->
            {% if events|length > 0 %}
            <div class="p-3 border-t border-[#1a2b4c]/10 text-center text-xs text-gray-400">
                Showing all {{ events|length }} event{{ events|length|pluralize }} · Last updated {{ now|date:"g:i A" }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- SIDEBAR: TODAY'S OVERVIEW + ACTIVE EVENTS -->
    <div class="space-y-6">
        <!-- Today's Overview -->
        <div class="neu-raised rounded-2xl p-5 reveal">
            <div class="flex items-center gap-2 mb-5">
                <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                <h4 class="font-medium text-[#1a2b4c]">TODAY'S FREQUENCY</h4>
                <span class="text-xs font-mono text-gray-400 ml-auto">{{ now|date:"M d, Y" }}</span>
            </div>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 neu-inset rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-clock-history text-gray-500"></i>
                        <span class="text-sm text-gray-600">Check-ins</span>
                    </div>
                    <span class="text-[#1a2b4c] font-bold text-lg font-mono" id="todayCheckins">{{ today_checkins|default:0 }}</span>
                </div>
                <div class="flex items-center justify-between p-3 neu-inset rounded-xl">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-file-text text-gray-500"></i>
                        <span class="text-sm text-gray-600">Applications</span>
                    </div>
                    <span class="text-[#1a2b4c] font-bold text-lg font-mono">{{ total_applications|default:0 }}</span>
                </div>
                <!-- FEEDBACK ROW REMOVED -->
            </div>
        </div>

        <!-- Active Events Card -->
        <div class="neu-raised rounded-2xl p-5 reveal">
            <div class="flex items-center justify-between mb-4">
                <h4 class="font-medium text-[#1a2b4c] flex items-center gap-2">
                    <i class="bi bi-broadcast"></i> ACTIVE EVENTS
                </h4>
                <span class="bg-[#1a2b4c] text-white px-2 py-1 rounded-full text-xs font-mono">{{ active_events }}</span>
            </div>
            {% if active_events > 0 %}
            <div class="space-y-3 max-h-80 overflow-y-auto pr-1">
                {% for event in events %}
                    {% if event.is_active %}
                    <div onclick="window.location='{% url 'event_detail' event.id %}'" 
                         class="neu-flat p-3 rounded-xl cursor-pointer hover:border-[#1a2b4c]/20 transition-all border border-transparent">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-[#1a2b4c]">{{ event.title|truncatechars:18 }}</span>
                            <span class="text-xs text-gray-500">{{ event.attendees.count }} checked</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-gray-400">{{ event.date|date:"M d, Y" }}</span>
                            {% if event.start_time %}
                            <span class="text-xs text-gray-400">{{ event.start_time|time:"g:i A" }}</span>
                            {% endif %}
                            <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                            <span class="text-xs text-green-600">LIVE</span>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6 text-gray-400">
                <i class="bi bi-pause-circle text-2xl"></i>
                <p class="text-xs mt-1 font-mono">NO ACTIVE TRANSMISSIONS</p>
                {% if user.role == 'STAFF' %}
                <div class="mt-4">
                    <a href="{% url 'create_event' %}" class="text-xs text-[#1a2b4c] underline underline-offset-4 hover:text-[#2c3e5e]">
                        Create one now
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Quick action for STAFF (always visible) -->
        {% if user.role == 'STAFF' %}
        <div class="neu-inset rounded-2xl p-5 reveal">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-[#1a2b4c] flex items-center justify-center">
                    <i class="bi bi-plus-circle text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-[#1a2b4c]">Need to broadcast?</p>
                    <a href="{% url 'create_event' %}" class="text-xs text-gray-600 hover:text-[#1a2b4c] flex items-center gap-1">
                        Create new event <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ===== ADMIN PERFORMANCE METRICS ===== -->
{% if user.role == 'ADMIN' %}
<div class="mt-8 reveal">
    <div class="neu-raised rounded-2xl p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
            <div>
                <h3 class="text-lg font-bold text-[#1a2b4c] flex items-center gap-2">
                    <i class="bi bi-graph-up"></i> SYSTEM PERFORMANCE
                </h3>
                <p class="text-xs text-gray-400 font-mono">CARRIER LOCK · 104.7 MHz</p>
            </div>
            <div class="flex items-center gap-2 bg-[#1a2b4c]/5 p-1 rounded-xl mt-3 md:mt-0">
                <button class="px-4 py-2 rounded-lg text-xs font-medium text-white bg-[#1a2b4c]">7D</button>
                <button class="px-4 py-2 rounded-lg text-xs font-medium text-gray-600 hover:text-[#1a2b4c]">30D</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="neu-inset rounded-xl p-4">
                <div class="text-sm text-gray-500 mb-2">EVENT GROWTH</div>
                <div class="text-2xl font-bold text-[#1a2b4c]">+{{ active_events|default:0 }}</div>
                <div class="mt-3 h-12 flex items-end gap-1">
                    <div class="w-1/6 bg-[#1a2b4c]/80 rounded-t-lg h-6"></div>
                    <div class="w-1/6 bg-[#1a2b4c]/80 rounded-t-lg h-8"></div>
                    <div class="w-1/6 bg-[#1a2b4c]/80 rounded-t-lg h-10"></div>
                    <div class="w-1/6 bg-[#1a2b4c]/80 rounded-t-lg h-7"></div>
                    <div class="w-1/6 bg-[#1a2b4c]/80 rounded-t-lg h-9"></div>
                    <div class="w-1/6 bg-[#1a2b4c]/80 rounded-t-lg h-5"></div>
                </div>
            </div>
            <div class="neu-inset rounded-xl p-4">
                <div class="text-sm text-gray-500 mb-2">ATTENDANCE TREND</div>
                <div class="text-2xl font-bold text-[#1a2b4c]">↑ {{ today_checkins|default:0 }}</div>
                <div class="mt-3 w-full h-12 relative">
                    <svg class="w-full h-full" viewBox="0 0 100 30">
                        <polyline points="0,25 15,18 30,22 45,12 60,15 75,8 90,12 100,5" 
                                  stroke="#1a2b4c" stroke-width="1.2" fill="none"/>
                    </svg>
                </div>
            </div>
            <div class="neu-inset rounded-xl p-4">
                <div class="text-sm text-gray-500 mb-2">SYSTEM UPTIME</div>
                <div class="text-2xl font-bold text-[#1a2b4c]">99.9%</div>
                <p class="text-xs text-gray-400 mt-2 font-mono">carrier stable</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== ACHIEVEMENT / MILESTONE ===== -->
{% if today_checkins and today_checkins > 50 %}
<div class="mt-8 reveal">
    <div class="neu-raised border-l-4 border-green-500 rounded-2xl p-5 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center transmission-ripple">
                <i class="bi bi-trophy-fill text-green-600 text-2xl"></i>
            </div>
            <div>
                <span class="text-xs font-mono text-green-600 uppercase">ATTENDANCE MILESTONE</span>
                <h4 class="text-[#1a2b4c] font-bold">50+ check‑ins today</h4>
                <p class="text-sm text-gray-500">Signal strength critical · transmission locked</p>
            </div>
        </div>
        <button class="px-4 py-2 rounded-lg text-sm border border-[#1a2b4c] text-[#1a2b4c] hover:bg-[#1a2b4c] hover:text-white transition flex items-center gap-2">
            <i class="bi bi-share"></i> SHARE
        </button>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        'use strict';

        // ===== ANIMATED COUNTERS =====
        function animateCounter(el, target, duration = 1800) {
            if (!el) return;
            let stepTime = 16;
            let increment = target / (duration / stepTime);
            let current = 0;
            let timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    el.textContent = target.toLocaleString();
                    clearInterval(timer);
                } else {
                    el.textContent = Math.floor(current).toLocaleString();
                }
            }, stepTime);
        }

        // Set counters
        setTimeout(() => {
            animateCounter(document.getElementById('eventCounter'), {{ total_events|default:0 }});
            animateCounter(document.getElementById('attendeeCounter'), {{ total_attendees|default:0 }});
            {% if user.role == 'ADMIN' %}
            animateCounter(document.getElementById('staffCounter'), {{ total_staff|default:0 }});
            {% else %}
            animateCounter(document.getElementById('applicationCounter'), {{ total_applications|default:0 }});
            // ===== NEW: Animate registration counter =====
            animateCounter(document.getElementById('totalRegistrations'), {{ total_registrations|default:0 }});
            {% endif %}
            
            // Set system health or events today counters
            {% if user.role == 'ADMIN' %}
            let systemEl = document.getElementById('systemHealth');
            if (systemEl) systemEl.textContent = '98%';
            {% else %}
            // Keep events today element for backward compatibility if needed
            let eventsTodayEl = document.getElementById('eventsToday');
            if (eventsTodayEl) eventsTodayEl.textContent = '{{ events_today|default:0 }}';
            {% endif %}
        }, 200);

        // ===== RING PROGRESS =====
        function setRing(ringId, percent) {
            let ring = document.getElementById(ringId);
            if (!ring) return;
            let circumference = 251.2;
            percent = Math.min(percent, 100);
            let offset = circumference - (percent / 100) * circumference;
            ring.style.strokeDashoffset = offset;
        }

        setTimeout(() => {
            {% if total_events > 0 %}
            setRing('eventRing', {% widthratio active_events total_events 100 %});
            {% else %}
            setRing('eventRing', 0);
            {% endif %}
            
            {% if total_attendees > 0 %}
            setRing('attendeeRing', {% widthratio today_checkins total_attendees 100 %});
            {% else %}
            setRing('attendeeRing', 0);
            {% endif %}
            
            {% if user.role == 'ADMIN' %}
            setRing('staffRing', 70);
            setRing('systemRing', 98);
            {% else %}
            {% if total_attendees > 0 %}
            setRing('appRing', {% widthratio total_applications|default:0 total_attendees 100 %});
            {% else %}
            setRing('appRing', 0);
            {% endif %}
            
            // ===== NEW: Registration ring progress =====
            {% if total_attendees > 0 %}
            setRing('registrationsRing', {% widthratio total_registrations|default:0 total_attendees 100 %});
            {% else %}
            setRing('registrationsRing', 0);
            {% endif %}
            {% endif %}
        }, 300);

        // ===== LIVE FREQUENCY SIMULATOR =====
        function updateFrequency() {
            let freqEl = document.getElementById('liveClockFreq');
            if (freqEl) {
                let base = 104.7;
                let variation = (Math.random() * 0.4 - 0.2).toFixed(1);
                let newFreq = (base + parseFloat(variation)).toFixed(1);
                freqEl.innerHTML = `${newFreq} MHz`;
                
                if (Math.random() > 0.7) {
                    freqEl.style.transform = 'skewX(-2deg)';
                    setTimeout(() => { freqEl.style.transform = ''; }, 100);
                }
            }
        }
        setInterval(updateFrequency, 3000);
        updateFrequency();

        // ===== REVEAL ANIMATION =====
        const reveals = document.querySelectorAll('.reveal');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1 });
        reveals.forEach(el => observer.observe(el));

        // ===== FIX: Ensure progress bars never exceed 100% width =====
        document.querySelectorAll('.progress-fill').forEach(bar => {
            let width = bar.style.width;
            if (width && parseInt(width) > 100) {
                bar.style.width = '100%';
            }
        });

        // ===== ADD SCROLL INDICATOR =====
        const tableContainer = document.querySelector('.events-table-container');
        if (tableContainer) {
            tableContainer.addEventListener('scroll', function() {
                if (this.scrollTop > 10) {
                    this.classList.add('scrolled');
                } else {
                    this.classList.remove('scrolled');
                }
            });
        }
    })();
</script>
{% endblock %}