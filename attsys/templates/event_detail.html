<!-- event_detail.html - NEUROMORPHIC EDITION WITH DARK BLUE ACCENTS -->
<!-- COMPLETELY REMOVED: Rating stars, feedback count, satisfaction metrics -->
<!-- ENHANCED: Start/Stop event transitions with sophisticated signal animations -->
<!-- UPDATED: Dark blue accent implementation matching base template -->
{% extends 'base.html' %}

{% block title %}{{ event.title }} · ATTSYS · SIGNAL LOCK{% endblock %}

{% block extra_css %}
<style>
    /* ---------------------------------------------------------------
       EVENT DETAIL — PURE MONOCHROME NEUROMORPHIC WITH DARK BLUE ACCENTS
       ENHANCED: Signal transmission animations, pulse sequences, carrier lock effects
       REGISTRATION MODAL: Deep inset style matching check_in page
       DARK BLUE: Consistent with base template (#1a2b4c)
    --------------------------------------------------------------- */
    
    /* ===== DARK BLUE COLOR VARIABLES (Matching base) ===== */
    :root {
        --dark-blue: #1a2b4c;
        --dark-blue-light: #2c3e5e;
        --dark-blue-dark: #0f1e38;
        --dark-blue-rgb: 26, 43, 76;
    }
    
    /* ===== ENHANCED SIGNAL TRANSMISSION ANIMATIONS ===== */
    @keyframes carrierWave {
        0% { transform: scaleX(0.95); opacity: 0.8; }
        50% { transform: scaleX(1.08); opacity: 1; }
        100% { transform: scaleX(0.95); opacity: 0.8; }
    }
    
    @keyframes dataPulse {
        0% { box-shadow: 0 0 0 0 rgba(26,43,76,0.2); }
        70% { box-shadow: 0 0 0 12px rgba(26,43,76,0); }
        100% { box-shadow: 0 0 0 0 rgba(26,43,76,0); }
    }
    
    @keyframes frequencyShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    @keyframes signalGlow {
        0% { filter: drop-shadow(0 0 2px rgba(26,43,76,0.2)); }
        100% { filter: drop-shadow(0 0 8px rgba(26,43,76,0.4)); }
    }
    
    @keyframes scanVertical {
        0% { top: -10%; opacity: 0; }
        50% { top: 50%; opacity: 0.15; }
        100% { top: 110%; opacity: 0; }
    }
    
    @keyframes transmissionComplete {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* ===== ENHANCED START/STOP BUTTON STATES WITH DARK BLUE ===== */
    .btn-start-event {
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        background: var(--dark-blue) !important;
        color: white !important;
    }
    
    .btn-start-event:hover {
        background: var(--dark-blue-light) !important;
        transform: translateY(-2px);
        box-shadow: 0 12px 20px -12px rgba(26,43,76,0.4);
    }
    
    .btn-start-event:active {
        transform: translateY(2px);
    }
    
    .btn-start-event::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
    }
    
    .btn-start-event:active::before {
        width: 200%;
        height: 200%;
    }
    
    .btn-start-event.active-sending {
        animation: transmissionComplete 0.8s ease;
    }
    
    .btn-start-event::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .btn-start-event:hover::after {
        left: 100%;
    }
    
    /* Active event indicator with enhanced pulse */
    .event-active-indicator {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .event-active-indicator .pulse-ring {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(26,43,76,0.3);
        animation: dataPulse 2s ease-out infinite;
    }
    
    .event-inactive-indicator .pulse-ring {
        background: rgba(239, 68, 68, 0.3);
    }
    
    /* Carrier wave effect for active events */
    .carrier-wave {
        position: relative;
        overflow: hidden;
    }
    
    .carrier-wave::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
            transparent 0%, 
            rgba(26,43,76,0.02) 25%,
            rgba(26,43,76,0.05) 50%,
            rgba(26,43,76,0.02) 75%,
            transparent 100%);
        background-size: 200% 100%;
        animation: frequencyShift 3s ease infinite;
        pointer-events: none;
    }
    
    /* Scan line effect for QR section */
    .scan-line {
        position: relative;
        overflow: hidden;
    }
    
    .scan-line::after {
        content: '';
        position: absolute;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(26,43,76,0.3), 
            transparent);
        animation: scanVertical 2.5s ease-in-out infinite;
        pointer-events: none;
    }
    
    /* ===== SIGNAL STRENGTH METER (ENHANCED) ===== */
    .signal-strength {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 4px;
        height: 40px;
    }
    .signal-strength .bar {
        width: 6px;
        background: var(--dark-blue);
        height: 10px;
        animation: signalPulse 1.2s infinite alternate;
        opacity: 0.7;
        border-radius: 2px;
        transform-origin: bottom;
    }
    .signal-strength .bar:nth-child(1) { height: 16px; animation-delay: 0s; }
    .signal-strength .bar:nth-child(2) { height: 24px; animation-delay: 0.2s; }
    .signal-strength .bar:nth-child(3) { height: 32px; animation-delay: 0.4s; }
    .signal-strength .bar:nth-child(4) { height: 28px; animation-delay: 0.1s; }
    .signal-strength .bar:nth-child(5) { height: 20px; animation-delay: 0.3s; }
    
    /* Active event - stronger signal */
    .signal-strength.active .bar {
        background: var(--dark-blue);
        animation: signalPulseStrong 0.8s infinite alternate;
    }
    
    @keyframes signalPulse {
        0% { opacity: 0.3; height: 12px; }
        100% { opacity: 1; height: 36px; }
    }
    
    @keyframes signalPulseStrong {
        0% { opacity: 0.5; height: 18px; background: var(--dark-blue); }
        100% { opacity: 1; height: 40px; background: var(--dark-blue-dark); box-shadow: 0 0 5px rgba(26,43,76,0.3); }
    }
    
    /* ===== FREQUENCY OSCILLATOR / SCAN PROGRESS ===== */
    .scan-progress {
        position: relative;
        overflow: hidden;
        background: rgba(26,43,76,0.08);
        border-radius: 999px;
        height: 6px;
    }
    .scan-progress .progress-fill {
        position: relative;
        height: 100%;
        background: var(--dark-blue);
        border-radius: 999px;
        transition: width 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-width: 100%;
        width: 0%;
    }
    .scan-progress .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: -20%;
        width: 40%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: scanSweep 2s ease-in-out infinite;
    }
    
    /* ===== ENHANCED CARD LIFT ===== */
    .card-lift {
        transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .card-lift:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 40px -12px rgba(26,43,76,0.2);
    }
    
    /* ===== TRANSMISSION RIPPLES (ENHANCED) ===== */
    .transmission-ripple {
        position: relative;
    }
    .transmission-ripple::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100%;
        height: 100%;
        border: 1px solid var(--dark-blue);
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
        animation: rippleEnhanced 2s ease-out infinite;
        pointer-events: none;
    }
    
    .transmission-ripple.active::before {
        border-color: #22c55e;
        animation: rippleGreen 1.5s ease-out infinite;
    }
    
    .transmission-ripple.inactive::before {
        border-color: #ef4444;
        animation: rippleRed 2s ease-out infinite;
    }
    
    @keyframes rippleEnhanced {
        0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0.6; border-width: 1.5px; }
        100% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; border-width: 0.5px; }
    }
    
    @keyframes rippleGreen {
        0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0.7; border-color: #22c55e; border-width: 2px; }
        100% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; border-color: #22c55e; border-width: 0.5px; }
    }
    
    @keyframes rippleRed {
        0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0.7; border-color: #ef4444; border-width: 2px; }
        100% { transform: translate(-50%, -50%) scale(2.2); opacity: 0; border-color: #ef4444; border-width: 0.5px; }
    }
    
    /* ===== STATUS TRANSITION OVERLAY ===== */
    .status-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26,43,76,0.7);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0.4s ease;
    }
    
    .status-transition-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .transition-content {
        background: var(--white);
        border-radius: 32px;
        padding: 40px;
        max-width: 500px;
        text-align: center;
        box-shadow: var(--neu-raised-deep);
        transform: scale(0.95);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid var(--gray-200);
    }
    
    .status-transition-overlay.active .transition-content {
        transform: scale(1);
    }
    
    .transition-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        animation: iconPulse 2s infinite;
    }
    
    .transition-icon.starting {
        background: rgba(26,43,76,0.1);
        color: var(--dark-blue);
        border: 2px solid var(--dark-blue);
    }
    
    .transition-icon.stopping {
        background: rgba(239, 68, 68, 0.1);
        color: #991b1b;
        border: 2px solid #ef4444;
    }
    
    @keyframes iconPulse {
        0% { box-shadow: 0 0 0 0 rgba(26,43,76,0.2); }
        70% { box-shadow: 0 0 0 20px rgba(26,43,76,0); }
        100% { box-shadow: 0 0 0 0 rgba(26,43,76,0); }
    }
    
    .transition-progress {
        width: 100%;
        height: 6px;
        background: var(--gray-200);
        border-radius: 999px;
        margin: 24px 0 16px;
        overflow: hidden;
    }
    
    .transition-progress-bar {
        height: 100%;
        width: 0%;
        background: var(--dark-blue);
        border-radius: 999px;
        transition: width 2s linear;
    }
    
    .transition-progress-bar.complete {
        background: #22c55e;
    }
    
    .transition-progress-bar.error {
        background: #ef4444;
    }
    
    /* ===== DATA ROW HOVER (ENHANCED) ===== */
    .data-row {
        transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        cursor: pointer;
        border-bottom: 1px solid rgba(26,43,76,0.04);
        position: relative;
    }
    .data-row:hover {
        background: rgba(26,43,76,0.02);
        transform: translateX(6px);
    }
    .data-row::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 0;
        background: var(--dark-blue);
        opacity: 0;
        transition: width 0.2s ease, opacity 0.2s ease;
    }
    .data-row:hover::after {
        width: 3px;
        opacity: 0.3;
    }
    
    /* ===== REVEAL ANIMATION ===== */
    .reveal {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                    transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .reveal.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* ===== FREQUENCY GLITCH ===== */
    .glitch-text {
        animation: glitch 5s infinite;
    }
    @keyframes glitch {
        0%, 95%, 100% { text-shadow: none; }
        96% { text-shadow: -1px 0 0 rgba(26,43,76,0.2), 1px 0 0 rgba(26,43,76,0.2); }
        97% { text-shadow: -1.5px 0.5px 0 rgba(26,43,76,0.15), 1.5px -0.5px 0 rgba(26,43,76,0.15); }
        98% { text-shadow: -1px -0.5px 0 rgba(26,43,76,0.2), 1px 0.5px 0 rgba(26,43,76,0.2); }
    }
    
    /* ===== PROGRESS BAR ===== */
    .progress-container {
        width: 100%;
        height: 6px;
        background: rgba(26,43,76,0.06);
        border-radius: 999px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: var(--dark-blue);
        border-radius: 999px;
        transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        max-width: 100%;
        width: 0%;
    }
    
    /* ===== PAYMENT BADGES ===== */
    .payment-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        line-height: 1;
    }
    .payment-badge::before {
        content: '';
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        display: inline-block;
    }
    .badge-paid {
        background: rgba(34, 197, 94, 0.1);
        color: rgb(21, 128, 61);
    }
    .badge-paid::before {
        background: rgb(34, 197, 94);
        animation: pulse 1.5s infinite;
    }
    .badge-partial {
        background: rgba(234, 179, 8, 0.1);
        color: rgb(161, 98, 7);
    }
    .badge-partial::before {
        background: rgb(234, 179, 8);
        animation: pulse 2s infinite;
    }
    .badge-pending {
        background: rgba(239, 68, 68, 0.1);
        color: rgb(153, 27, 27);
    }
    .badge-pending::before {
        background: rgb(239, 68, 68);
        animation: pulse 2.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    /* ===== QR CODE STYLES ===== */
    .qr-container {
        position: relative;
        display: inline-block;
    }
    .qr-container::after {
        content: '';
        position: absolute;
        top: -6px;
        left: -6px;
        right: -6px;
        bottom: -6px;
        border: 1px solid rgba(26,43,76,0.08);
        border-radius: 16px;
        pointer-events: none;
        transition: border-color 0.3s ease;
    }
    .qr-container:hover::after {
        border-color: rgba(26,43,76,0.2);
    }
    
    /* ===== TOAST NOTIFICATION (ENHANCED) ===== */
    #toast {
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: var(--dark-blue) !important;
        color: var(--white);
        border: 1px solid var(--gray-700);
        box-shadow: 0 12px 28px rgba(26,43,76,0.25);
        z-index: 1000000 !important;
        position: fixed;
        bottom: 24px;
        right: 24px;
        border-radius: 16px;
        padding: 16px 24px;
        transform: translateY(0);
    }
    
    #toast.success-toast {
        border-left: 6px solid #22c55e;
    }
    
    #toast.error-toast {
        border-left: 6px solid #ef4444;
    }
    
    #toast.warning-toast {
        border-left: 6px solid #f59e0b;
    }
    
    /* ===== PRINT STYLES ===== */
    @media print {
        .no-print, nav, footer, .static-noise, .scan-sweep, .frequency-oscillator, .transmission-ripple,
        .status-transition-overlay, .carrier-wave, .scan-line {
            display: none !important;
        }
        body, main, .modal-content, .neu-raised, .neu-inset {
            background: white !important;
            box-shadow: none !important;
            border: 1px solid #ddd !important;
        }
        .print-form {
            width: 100% !important;
            page-break-inside: avoid !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- ===== EVENT DETAIL - ENHANCED SIGNAL THEME WITH DARK BLUE ACCENTS ===== -->
<!-- ENHANCED: Start/Stop transitions with carrier wave animations -->
<!-- DARK BLUE: Consistent with base template (#1a2b4c) -->

<!-- Status Transition Overlay - ENHANCED -->
<div id="statusTransitionOverlay" class="status-transition-overlay">
    <div class="transition-content">
        <div id="transitionIcon" class="transition-icon">
            <i id="transitionIconElement" class="bi bi-broadcast"></i>
        </div>
        <h3 id="transitionTitle" class="text-2xl font-bold text-[#1a2b4c] mb-2">Transmitting Signal</h3>
        <p id="transitionMessage" class="text-gray-600 mb-4">Establishing carrier wave...</p>
        <div class="transition-progress">
            <div id="transitionProgressBar" class="transition-progress-bar" style="width: 0%;"></div>
        </div>
        <div id="transitionStatus" class="text-xs font-mono text-gray-500 mt-2">
            <span id="transitionStep">Initializing transmission</span>
            <span id="transitionTimer" class="ml-2">0%</span>
        </div>
        <div id="transitionComplete" style="display: none;" class="mt-6 pt-4 border-t border-gray-200">
            <span class="inline-flex items-center gap-2 text-sm text-green-600">
                <i class="bi bi-check-circle-fill"></i> Transmission complete
            </span>
        </div>
    </div>
</div>

<div class="transmission-enter">

    <!-- Page Header with Enhanced Signal Strength -->
    <div class="mb-8 reveal">
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
            <!-- Event Title & Enhanced Status - Takes available space but not too wide -->
            <div class="flex-1 min-w-0 lg:max-w-[60%]">
                <div class="inline-flex items-center gap-3 px-4 py-2 neu-inset rounded-full mb-4">
                    <div class="signal-strength {% if event.is_active %}active{% endif %} !h-5">
                        <div class="bar !w-1.5"></div>
                        <div class="bar !w-1.5"></div>
                        <div class="bar !w-1.5"></div>
                        <div class="bar !w-1.5"></div>
                        <div class="bar !w-1.5"></div>
                    </div>
                    <span class="text-xs font-mono text-gray-600 tracking-wider whitespace-nowrap">EVENT · {{ event.date|date:"Y.m.d" }}</span>
                    
                    <!-- ENHANCED: Active status indicator with pulse rings -->
                    <div class="event-active-indicator">
                        <div class="pulse-ring" style="{% if event.is_active %}display: block;{% else %}display: none;{% endif %}"></div>
                        <span id="eventStatusBadge" class="text-xs font-mono whitespace-nowrap {% if event.is_active %}bg-[#1a2b4c] text-white{% else %}bg-gray-100 text-gray-600{% endif %} px-2 py-0.5 rounded-full transition-all duration-500">
                            {{ event.is_active|yesno:'ACTIVE,INACTIVE' }}
                        </span>
                    </div>
                </div>
                
                <!-- Title with truncation for very long titles -->
                <h1 id="eventTitle" class="text-3xl md:text-4xl font-bold text-[#1a2b4c] tracking-tight glitch-text break-words pr-2" title="{{ event.title }}">
                    {{ event.title }}
                </h1>
                
                <div class="flex flex-wrap items-center gap-4 mt-3 text-sm text-gray-500">
                    <span class="flex items-center gap-1.5 whitespace-nowrap">
                        <i class="bi bi-geo-alt-fill text-gray-400"></i>
                        <span class="truncate max-w-[200px] md:max-w-[300px]" title="{{ event.venue }}">{{ event.venue }}</span>
                    </span>
                    <span class="w-1 h-1 bg-gray-300 rounded-full flex-shrink-0"></span>
                    <span class="flex items-center gap-1.5 whitespace-nowrap">
                        <i class="bi bi-calendar3 text-gray-400"></i>
                        {{ event.date|date:"F d, Y" }}
                    </span>
                    <span class="w-1 h-1 bg-gray-300 rounded-full flex-shrink-0"></span>
                    <span class="flex items-center gap-1.5 whitespace-nowrap">
                        <i class="bi bi-clock text-gray-400"></i>
                        {{ event.start_time|time:"g:i A" }} — {{ event.end_time|time:"g:i A" }}
                    </span>
                </div>
            </div>
            
            <!-- ENHANCED: Action Buttons - Fixed width, always on same line on large screens -->
            <div class="flex flex-wrap items-center gap-3 flex-shrink-0 lg:flex-nowrap">
                <a href="{% url 'export_attendees_csv' event.id %}" 
                class="neu-raised-sm px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:text-[#1a2b4c] flex items-center gap-2 bg-white neu-tactile transition-all duration-300 hover:scale-105 whitespace-nowrap">
                    <i class="bi bi-filetype-csv"></i>
                    <span class="hidden sm:inline">Export CSV</span>
                    <span class="sm:hidden">CSV</span>
                </a>
                
                {% if request.user.role == 'STAFF' %}
                <!-- ENHANCED: Start/Stop buttons with sophisticated animations - Only for STAFF -->
                <form id="toggleEventForm" method="post" action="{% url 'toggle_event' event.id %}" class="m-0 hidden">
                    {% csrf_token %}
                </form>
                
                <button id="toggleEventBtn" 
                        onclick="EventManager.toggleEvent()"
                        class="btn-start-event neu-raised-sm px-4 py-2.5 rounded-xl text-sm font-medium flex items-center gap-2 neu-tactile transition-all duration-300 whitespace-nowrap">
                    <span id="toggleBtnIcon" class="flex items-center justify-center">
                        <i id="toggleIcon" class="bi {% if event.is_active %}bi-stop-circle{% else %}bi-play-circle{% endif %} text-lg"></i>
                    </span>
                    <span id="toggleBtnText" class="hidden sm:inline">{% if event.is_active %}Stop Event{% else %}Start Event{% endif %}</span>
                    <span class="sm:hidden">{% if event.is_active %}Stop{% else %}Start{% endif %}</span>
                </button>
                {% endif %}
                
                <a href="{% url 'dashboard' %}" 
                class="neu-raised-sm px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:text-[#1a2b4c] flex items-center gap-2 bg-white neu-tactile transition-all duration-300 hover:scale-105 whitespace-nowrap">
                    <i class="bi bi-arrow-left"></i>
                    <span class="hidden sm:inline">Dashboard</span>
                    <span class="sm:hidden">Back</span>
                </a>
            </div>
        </div>
    </div>

    <!-- ===== QR CODE SECTION - ENHANCED WITH SCAN LINE ===== -->
    {% if event.is_active %}
    <div id="qrSection" class="neu-raised rounded-2xl p-6 mb-8 reveal frequency-oscillator carrier-wave scan-line">
        <div class="flex items-center gap-3 mb-5">
            <div class="signal-strength active !h-6">
                <div class="bar !w-1 !h-4"></div>
                <div class="bar !w-1 !h-6"></div>
                <div class="bar !w-1 !h-8"></div>
                <div class="bar !w-1 !h-6"></div>
                <div class="bar !w-1 !h-4"></div>
            </div>
            <h3 class="font-semibold text-[#1a2b4c]">CHECK-IN FREQUENCY · QR TRANSMISSION</h3>
            <span id="carrierLockStatus" class="text-xs font-mono text-gray-400 ml-auto animate-pulse">CARRIER LOCK · ACTIVE</span>
        </div>
        
        {% if qr_image %}
        <div class="flex flex-col md:flex-row items-start gap-8">
            <!-- QR Code with enhanced hover -->
            <div class="flex-shrink-0">
                <div class="qr-container transition-all duration-300 hover:scale-105">
                    <img src="data:image/png;base64,{{ qr_image }}" 
                         alt="Event Check-in QR Code" 
                         class="w-48 h-48 p-3 bg-white border border-gray-200 rounded-xl cursor-pointer card-lift"
                         id="qrImage"
                         onclick="openQRModal()">
                </div>
                <div class="text-center mt-3">
                    <span id="qrSignalStatus" class="text-xs font-mono text-gray-400 tracking-wider flex items-center justify-center gap-1">
                        <span class="w-1.5 h-1.5 bg-[#1a2b4c] rounded-full animate-pulse"></span>
                        SIGNAL · ACTIVE
                    </span>
                </div>
            </div>
            
            <!-- Event Details & Actions -->
            <div class="flex-1">
                <div class="neu-inset rounded-xl p-5 mb-5">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="bi bi-broadcast text-[#1a2b4c] animate-pulse"></i>
                        <span class="text-sm font-medium text-[#1a2b4c]">TRANSMISSION DETAILS</span>
                    </div>
                    <div class="space-y-2.5">
                        <div class="flex items-start gap-3">
                            <i class="bi bi-megaphone text-gray-400 mt-0.5"></i>
                            <span class="text-sm text-gray-700">{{ event.title }}</span>
                        </div>
                        <div class="flex items-start gap-3">
                            <i class="bi bi-pin-map-fill text-gray-400 mt-0.5"></i>
                            <span class="text-sm text-gray-700">{{ event.venue }}</span>
                        </div>
                        <div class="flex items-start gap-3">
                            <i class="bi bi-calendar-week text-gray-400 mt-0.5"></i>
                            <span class="text-sm text-gray-700">{{ event.date|date:"F d, Y" }} · {{ event.start_time|time:"g:i A" }} – {{ event.end_time|time:"g:i A" }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                    <button onclick="copyToClipboard()"
                            class="neu-raised-sm px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:text-[#1a2b4c] flex items-center gap-2 bg-white neu-tactile transition-all duration-300 hover:scale-105">
                        <i class="bi bi-clipboard"></i>
                        <span>Copy Check-in URL</span>
                    </button>
                    
                    {% if qr_url %}
                    <a href="{% url 'download_qr' event.id %}" 
                       target="_blank"
                       onclick="showDownloadToast()"
                       class="neu-raised-sm px-4 py-2.5 rounded-xl text-sm font-medium bg-[#1a2b4c] text-white hover:bg-[#2c3e5e] flex items-center gap-2 neu-tactile transition-all duration-300 hover:scale-105">
                        <i class="bi bi-download"></i>
                        <span>Download QR</span>
                    </a>
                    {% endif %}
                    
                    <button onclick="openQRModal()"
                            class="neu-raised-sm px-4 py-2.5 rounded-xl text-sm font-medium bg-white text-[#1a2b4c] border border-gray-200 flex items-center gap-2 neu-tactile transition-all duration-300 hover:scale-105">
                        <i class="bi bi-arrows-fullscreen"></i>
                        <span>Projector View</span>
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="neu-inset rounded-xl p-6 bg-red-50 border border-red-200">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <i class="bi bi-exclamation-triangle-fill text-red-600"></i>
                </div>
                <div>
                    <h4 class="font-medium text-red-800 mb-1">QR Code Generation Failed</h4>
                    <p class="text-sm text-red-700">Please try: stop and restart the event, refresh the page, or check console logs.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ===== STATS OVERVIEW - NEUROMORPHIC CARDS WITH DARK BLUE ACCENTS ===== -->
    <!-- COMPLETELY REMOVED: Rating card and Feedback card -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-8">
        <!-- Total Attendees -->
        <div class="neu-raised rounded-2xl p-5 card-lift reveal">
            <div class="flex items-start justify-between">
                <div>
                    <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">ATTENDEES</span>
                    <div id="totalAttendeesStat" class="text-3xl font-bold text-[#1a2b4c] mt-1 transition-all duration-500">{{ total_attendees_count }}</div>
                    <span class="inline-flex items-center gap-1 text-xs bg-[#1a2b4c]/5 text-gray-700 px-2 py-1 rounded-full border border-[#1a2b4c]/10 mt-3">
                        <i class="bi bi-arrow-up-short text-[#1a2b4c]"></i> +{{ today_checkins }} today
                    </span>
                </div>
                <div class="w-12 h-12 rounded-xl neu-inset flex items-center justify-center transmission-ripple {% if event.is_active %}active{% else %}inactive{% endif %}">
                    <i class="bi bi-people-fill text-[#1a2b4c] text-xl"></i>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t border-black/5 text-xs text-gray-400 flex justify-between">
                <span>CHECKED IN</span>
                <span class="text-[#1a2b4c] font-mono">{{ total_attendees_count }} total</span>
            </div>
        </div>

        <!-- REGISTRATION STATS - Add transmission-ripple class -->
        <div class="neu-raised rounded-2xl p-5 card-lift reveal">
            <div class="flex items-start justify-between">
                <div>
                    <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">REGISTRATION</span>
                    <div id="totalRegisteredStat" class="text-3xl font-bold text-[#1a2b4c] mt-1 transition-all duration-500">{{ total_registered|default:0 }}</div>
                    <span class="inline-flex items-center gap-1 text-xs bg-[#1a2b4c]/5 text-gray-700 px-2 py-1 rounded-full border border-[#1a2b4c]/10 mt-3">
                        <i class="bi bi-file-text text-[#1a2b4c]"></i> {{ payment_completed|default:0 }} paid
                    </span>
                </div>
                <!-- Add transmission-ripple class here with conditional active/inactive -->
                <div class="w-12 h-12 rounded-xl neu-inset flex items-center justify-center transmission-ripple {% if event.is_active %}active{% else %}inactive{% endif %}">
                    <i class="bi bi-file-earmark-text text-[#1a2b4c] text-xl"></i>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t border-black/5 text-xs text-gray-400 flex justify-between">
                <span>COMPLETED</span>
                <span class="text-[#1a2b4c] font-mono">{{ payment_completed|default:0 }}</span>
            </div>
        </div>

        <!-- Last Check-in -->
        <div class="neu-raised rounded-2xl p-5 card-lift reveal">
            <div class="flex items-start justify-between">
                <div>
                    <span class="text-xs font-mono text-gray-400 uppercase tracking-wider">LAST SIGNAL</span>
                    <div id="lastCheckinStat" class="text-2xl font-bold text-[#1a2b4c] mt-1 transition-all duration-500">{{ last_checkin_display|default:"—" }}</div>
                    <div id="lastCheckinDateStat" class="text-xs text-gray-400 mt-2">{{ last_checkin_date_display|default:"No check-ins yet" }}</div>
                </div>
                <div class="w-12 h-12 rounded-xl neu-inset flex items-center justify-center transmission-ripple {% if event.is_active %}active{% else %}inactive{% endif %}">
                    <i class="bi bi-broadcast text-[#1a2b4c] text-xl"></i>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t border-black/5 text-xs text-gray-400 flex justify-between">
                <span>FREQUENCY</span>
                <span class="text-[#1a2b4c] font-mono">104.7 MHz</span>
            </div>
            <div class="flex items-center gap-1 mt-2">
                <span id="liveIndicator" class="w-1.5 h-1.5 {% if event.is_active %}bg-[#1a2b4c]{% else %}bg-gray-400{% endif %} rounded-full animate-pulse"></span>
                <span id="liveText" class="text-xs text-gray-500">{% if event.is_active %}LIVE{% else %}OFFLINE{% endif %}</span>
            </div>
        </div>
    </div>

    <!-- ===== REGISTRATION SUMMARY - FINANCIAL METRICS ===== -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 reveal">
        <div class="neu-inset rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-[#1a2b4c]" id="totalRegistered">{{ total_registered|default:0 }}</div>
            <div class="text-xs font-mono text-gray-500 mt-1 uppercase tracking-wider">REGISTERED</div>
        </div>
        <div class="neu-inset rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-[#1a2b4c]" id="totalPreRegFee">RM {{ total_pre_reg_fee|default:"0.00" }}</div>
            <div class="text-xs font-mono text-gray-500 mt-1 uppercase tracking-wider">PRE-REGISTRATION FEE</div>
        </div>
        <div class="neu-inset rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-[#1a2b4c]" id="totalRegFee">RM {{ total_reg_fee|default:"0.00" }}</div>
            <div class="text-xs font-mono text-gray-500 mt-1 uppercase tracking-wider">REGISTRATION FEE</div>
        </div>
        <div class="neu-inset rounded-xl p-4 text-center">
            <div class="text-2xl font-bold text-[#1a2b4c]" id="totalRevenue">RM {{ total_revenue|default:"0.00" }}</div>
            <div class="text-xs font-mono text-gray-500 mt-1 uppercase tracking-wider">TOTAL REVENUE</div>
        </div>
    </div>

    <!-- ===== ATTENDEES TABLE - NEUROMORPHIC DESIGN ===== -->
    <div class="neu-raised rounded-2xl overflow-hidden reveal">
        <!-- Table Header -->
        <div class="px-6 py-5 border-b border-black/10 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="signal-strength !h-6">
                    <div class="bar !w-1 !h-4"></div>
                    <div class="bar !w-1 !h-6"></div>
                    <div class="bar !w-1 !h-8"></div>
                    <div class="bar !w-1 !h-6"></div>
                    <div class="bar !w-1 !h-4"></div>
                </div>
                <h3 class="font-semibold text-[#1a2b4c]">ATTENDEE REGISTER · SIGNAL LOG</h3>
                <span id="attendeeCount" class="text-xs font-mono text-gray-400 bg-[#1a2b4c]/5 px-2 py-1 rounded-full">
                    {{ total_attendees_count }} RECORDS
                </span>
            </div>
            <button onclick="showAllRegistrationStats()"
                    class="neu-raised-sm px-4 py-2 rounded-lg text-sm font-medium bg-[#1a2b4c] text-white hover:bg-[#2c3e5e] flex items-center gap-2 neu-tactile transition-all duration-300 hover:scale-105">
                <i class="bi bi-graph-up"></i>
                <span>Statistics</span>
            </button>
        </div>
        
        <!-- Search and Filter -->
        <div class="px-6 py-4 border-b border-black/10 bg-black/5">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <!-- Search Input - Neuromorphic Style -->
                <div class="flex-1">
                    <div class="relative">
                        <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" 
                               id="attendeeSearch"
                               placeholder="Search by name, email, IC number, referral..."
                               class="w-full pl-10 pr-4 py-3 rounded-xl text-sm text-black placeholder-gray-300 border-0 focus:ring-2 focus:ring-[#1a2b4c] neu-inset bg-transparent">
                    </div>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterAttendees('all')"
                            class="px-4 py-2 text-sm rounded-lg border border-[#1a2b4c]/20 bg-[#1a2b4c] text-white font-medium active-filter transition-all duration-200">
                        All
                    </button>
                    <button onclick="filterAttendees('paid')"
                            class="px-4 py-2 text-sm rounded-lg border border-[#1a2b4c]/20 bg-white text-gray-700 hover:bg-[#1a2b4c]/5 transition-all duration-200">
                        Paid
                    </button>
                    <button onclick="filterAttendees('partial')"
                            class="px-4 py-2 text-sm rounded-lg border border-[#1a2b4c]/20 bg-white text-gray-700 hover:bg-[#1a2b4c]/5 transition-all duration-200">
                        Partial
                    </button>
                    <button onclick="filterAttendees('pending')"
                            class="px-4 py-2 text-sm rounded-lg border border-[#1a2b4c]/20 bg-white text-gray-700 hover:bg-[#1a2b4c]/5 transition-all duration-200">
                        Pending
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Table - Scrollable -->
        <div class="overflow-x-auto table-container">
            <table class="w-full text-sm" id="attendeesTable">
                <thead>
                    <tr class="bg-[#1a2b4c]/5 text-gray-600 text-xs font-mono uppercase tracking-wider">
                        <th class="py-4 px-4 text-left"></th>
                        <th class="py-4 px-4 text-left">ATTENDEE INFO</th>
                        <th class="py-4 px-4 text-left">PROGRAMME</th>
                        <th class="py-4 px-4 text-left">REFERRAL</th>
                        <th class="py-4 px-4 text-left">PAYMENT TYPE</th>
                        <th class="py-4 px-4 text-left">STATUS</th>
                        <th class="py-4 px-4 text-left">AMOUNT</th>
                        <th class="py-4 px-4 text-left">TIME</th>
                        <th class="py-4 px-4 text-left"></th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-black/5">
                    {% if attendees %}
                    {% for attendee in attendees %}
                    <tr data-attendee-id="{{ attendee.id }}" 
                        data-ic-number="{% if attendee.get_ic_number %}{{ attendee.get_ic_number }}{% endif %}"
                        id="attendee-row-{{ attendee.id }}"
                        class="data-row transition-all duration-200">
                        
                        <!-- Serial Number -->
                        <td class="py-4 px-4 text-sm text-gray-500">
                            {{ forloop.counter }}
                        </td>
                        
                        <!-- Attendee Info -->
                        <td class="py-4 px-4">
                            <div class="flex flex-col">
                                <div class="font-medium text-[#1a2b4c] mb-1">{{ attendee.name|upper }}</div>
                                <div class="text-xs text-gray-500 truncate max-w-xs">{{ attendee.email }}</div>
                                {% if attendee.phone_number %}
                                <div class="text-xs text-gray-400 mt-1">{{ attendee.phone_number|upper }}</div>
                                {% endif %}
                                {% if attendee.get_ic_number %}
                                <div class="text-xs text-gray-400 mt-1">IC: {{ attendee.get_ic_number|upper }}</div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Applied Programme -->
                        <td class="py-4 px-4">
                            <div id="applied-programme-cell-{{ attendee.id }}">
                                {% if attendee.has_application %}
                                    {% with app=attendee.application_data %}
                                    {% if app.applied_programme == 'Diploma' or app.applied_programme == 'DIPLOMA' %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">DIPLOMA</span>
                                    {% elif app.applied_programme == 'Pra-Diploma' or app.applied_programme == 'PRA_DIPLOMA' %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">PRA-DIPLOMA</span>
                                    {% elif app.applied_programme == 'TVET' %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">TVET</span>
                                    {% elif app.applied_programme == 'Smart Tahfiz' or app.applied_programme == 'SMART_TAHFIZ' %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">SMART TAHFIZ</span>
                                    {% elif app.applied_programme %}
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{ app.applied_programme|upper }}</span>
                                    {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="text-sm text-gray-400">—</span>
                                {% endif %}
                            </div>
                        </td>

                        <!-- Referral -->
                        <td class="py-4 px-4">
                            <div id="inviting-officer-cell-{{ attendee.id }}" class="text-sm text-[#1a2b4c] truncate max-w-[120px]" title="{{ attendee.application_data.registration_officer|default:'—'|upper }}">
                                {{ attendee.application_data.registration_officer|upper|truncatechars:15|default:"—" }}
                            </div>
                        </td>
                        
                        <!-- Payment Type -->
                        <td class="py-4 px-4">
                            <div id="payment-type-cell-{{ attendee.id }}">
                                {% if attendee.has_registration and attendee.registration.payment_type %}
                                    {% with type=attendee.registration.payment_type %}
                                        {% if type == 'CASH' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">CASH</span>
                                        {% elif type == 'ONLINE_BANKING' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">ONLINE BANKING</span>
                                        {% elif type == 'QR_PAYMENT' %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">QR PAYMENT</span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{ type|upper|default:"—" }}</span>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="text-sm text-gray-400">—</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Payment Status -->
                        <td class="py-4 px-4">
                            <div id="payment-status-cell-{{ attendee.id }}">
                                {% if attendee.has_registration %}
                                    {% with status=attendee.registration.payment_status %}
                                    <span class="payment-badge 
                                        {% if status == 'DONE' %}badge-paid
                                        {% elif status == 'PARTIAL' %}badge-partial
                                        {% elif status == 'PENDING' %}badge-pending
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {% if status == 'DONE' %}COMPLETED
                                        {% elif status == 'PARTIAL' %}PARTIALLY PAID
                                        {% elif status == 'PENDING' %}PENDING
                                        {% else %}{{ status|upper|default:"—" }}{% endif %}
                                    </span>
                                    {% endwith %}
                                {% else %}
                                    <span class="text-sm text-gray-400">—</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Amount -->
                        <td class="py-4 px-4">
                            <div id="payment-amount-cell-{{ attendee.id }}" class="text-sm font-medium text-[#1a2b4c]">
                                {% if attendee.has_registration %}
                                    RM {{ attendee.registration.amount_paid|floatformat:0 }}
                                {% else %}
                                    <span class="text-gray-400">—</span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Time -->
                        <td class="py-4 px-4 text-sm text-gray-500">
                            {{ attendee.attended_at|date:"g:i A" }}
                        </td>
                        
                        <!-- Actions -->
                        <td class="py-4 px-4">
                            <div class="flex items-center gap-1">
                                <button onclick="showAttendeeDetails({{ attendee.id }})"
                                        class="p-2 text-gray-600 hover:text-[#1a2b4c] hover:bg-[#1a2b4c]/5 rounded-lg transition-all duration-200 hover:scale-110"
                                        title="View Details">
                                    <i class="bi bi-eye text-lg"></i>
                                </button>
                                <button onclick="openRegistrationModal({{ attendee.id }})"
                                        class="p-2 {% if attendee.has_registration %}text-yellow-600 hover:bg-yellow-50{% else %}text-[#1a2b4c] hover:bg-[#1a2b4c]/5{% endif %} rounded-lg transition-all duration-200 hover:scale-110"
                                        title="{% if attendee.has_registration %}Update Registration{% else %}Add Registration{% endif %}">
                                    <i class="bi bi-{% if attendee.has_registration %}pencil{% else %}plus-circle{% endif %} text-lg"></i>
                                </button>
                                <button onclick="confirmDeleteAttendee({{ attendee.id }}, '{{ attendee.name|escapejs }}')"
                                        class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 hover:scale-110"
                                        title="Delete Attendee">
                                    <i class="bi bi-trash text-lg"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="9" class="py-12 text-center">
                            <div class="flex flex-col items-center text-gray-400">
                                <i class="bi bi-wifi-off text-4xl mb-3"></i>
                                <span class="text-sm font-mono">NO ATTENDEES DETECTED</span>
                                <span class="text-xs text-gray-400 mt-2">Waiting for first check-in signal...</span>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Table Footer -->
        {% if attendees %}
        <div class="px-6 py-4 border-t border-black/10 flex justify-end">
            <span class="text-xs text-gray-500 font-mono">
                <i class="bi bi-arrow-up-short text-[#1a2b4c]"></i> {{ total_attendees_count }} RECORDS TRANSMITTED
            </span>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-- ===== MODAL CONTAINERS - OUTSIDE MAIN CONTENT BUT INSIDE BASE ===== -->
{% block extra_js %}
<script>
    // ============================================
    // ENHANCED EVENT MANAGER WITH DARK BLUE ACCENTS
    // ============================================
    (function() {
        'use strict';
        
        // ============================================
        // ENHANCED TOAST NOTIFICATION SYSTEM
        // ============================================
        const Toast = {
            show(message, type = 'success', duration = 3000) {
                let toast = document.getElementById('toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = 'fixed bottom-6 right-6 p-4 rounded-xl shadow-lg transform translate-y-24 opacity-0 transition-all duration-500 flex items-center gap-3 z-[1000000]';
                    toast.style.background = '#1a2b4c';
                    toast.style.color = '#ffffff';
                    toast.innerHTML = '<span id="toastMessage"></span>';
                    document.body.appendChild(toast);
                }
                
                const iconMap = {
                    'success': '<i class="bi bi-check-circle-fill text-white"></i>',
                    'error': '<i class="bi bi-exclamation-circle-fill text-white"></i>',
                    'warning': '<i class="bi bi-exclamation-triangle-fill text-white"></i>',
                    'info': '<i class="bi bi-info-circle-fill text-white"></i>'
                };
                
                const colorMap = {
                    'success': '#22c55e',
                    'error': '#ef4444',
                    'warning': '#f59e0b',
                    'info': '#1a2b4c'
                };
                
                toast.innerHTML = `${iconMap[type] || iconMap.info}<span id="toastMessage">${message}</span>`;
                toast.style.borderLeft = `6px solid ${colorMap[type] || colorMap.info}`;
                
                toast.classList.remove('translate-y-24', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
                
                if (window.toastTimeout) clearTimeout(window.toastTimeout);
                window.toastTimeout = setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-24', 'opacity-0');
                }, duration);
            }
        };
        
        // ============================================
        // ENHANCED EVENT MANAGER - SOPHISTICATED TRANSITIONS
        // ============================================
        const EventManager = {
            isTransitioning: false,
            
            async toggleEvent() {
                if (this.isTransitioning) {
                    Toast.show('Transmission in progress...', 'warning');
                    return;
                }
                
                const btn = document.getElementById('toggleEventBtn');
                const btnText = document.getElementById('toggleBtnText');
                const btnIcon = document.getElementById('toggleIcon');
                const btnRipple = document.getElementById('toggleBtnRipple');
                const eventStatusBadge = document.getElementById('eventStatusBadge');
                const liveIndicator = document.getElementById('liveIndicator');
                const liveText = document.getElementById('liveText');
                const qrSection = document.getElementById('qrSection');
                const carrierLock = document.getElementById('carrierLockStatus');
                const qrSignal = document.getElementById('qrSignalStatus');
                
                const isCurrentlyActive = '{{ event.is_active|lower }}' === 'true';
                const action = isCurrentlyActive ? 'stop' : 'start';
                
                // Show transition overlay
                const overlay = document.getElementById('statusTransitionOverlay');
                const transitionIcon = document.getElementById('transitionIcon');
                const transitionIconElement = document.getElementById('transitionIconElement');
                const transitionTitle = document.getElementById('transitionTitle');
                const transitionMessage = document.getElementById('transitionMessage');
                const transitionProgressBar = document.getElementById('transitionProgressBar');
                const transitionStep = document.getElementById('transitionStep');
                const transitionTimer = document.getElementById('transitionTimer');
                const transitionComplete = document.getElementById('transitionComplete');
                
                // Reset overlay
                transitionProgressBar.style.width = '0%';
                transitionComplete.style.display = 'none';
                overlay.classList.add('active');
                
                // Configure based on action
                if (action === 'start') {
                    transitionIcon.className = 'transition-icon starting';
                    transitionIconElement.className = 'bi bi-broadcast';
                    transitionTitle.textContent = 'INITIATING SIGNAL';
                    transitionMessage.textContent = 'Establishing transmission frequency...';
                    transitionStep.textContent = 'ACQUIRING CARRIER';
                    transitionProgressBar.className = 'transition-progress-bar';
                } else {
                    transitionIcon.className = 'transition-icon stopping';
                    transitionIconElement.className = 'bi bi-stop-circle';
                    transitionTitle.textContent = 'TERMINATING SIGNAL';
                    transitionMessage.textContent = 'Closing transmission channel...';
                    transitionStep.textContent = 'SHUTTING DOWN';
                    transitionProgressBar.className = 'transition-progress-bar';
                }
                
                transitionTimer.textContent = '0%';
                
                this.isTransitioning = true;
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                
                // Progress animation
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 1;
                    if (progress <= 100) {
                        transitionProgressBar.style.width = `${progress}%`;
                        transitionTimer.textContent = `${progress}%`;
                        
                        // Update step messages
                        if (action === 'start') {
                            if (progress < 30) transitionStep.textContent = 'ACQUIRING CARRIER';
                            else if (progress < 60) transitionStep.textContent = 'SYNCHRONIZING FREQUENCY';
                            else if (progress < 90) transitionStep.textContent = 'ESTABLISHING CONNECTION';
                            else transitionStep.textContent = 'FINALIZING TRANSMISSION';
                        } else {
                            if (progress < 30) transitionStep.textContent = 'DROPPING CARRIER';
                            else if (progress < 60) transitionStep.textContent = 'CLEARING BUFFER';
                            else if (progress < 90) transitionStep.textContent = 'CLOSING CHANNEL';
                            else transitionStep.textContent = 'TERMINATING LINK';
                        }
                    }
                }, 30);
                
                try {
                    // Submit the form via AJAX for smooth transition
                    const form = document.getElementById('toggleEventForm');
                    const formData = new FormData(form);
                    
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const result = await response.json().catch(() => ({}));
                    
                    // Complete the progress bar
                    clearInterval(progressInterval);
                    progress = 100;
                    transitionProgressBar.style.width = '100%';
                    transitionTimer.textContent = '100%';
                    
                    if (action === 'start') {
                        transitionStep.textContent = 'TRANSMISSION ACTIVE';
                        transitionProgressBar.classList.add('complete');
                        transitionComplete.style.display = 'block';
                        transitionComplete.querySelector('span').innerHTML = '<i class="bi bi-check-circle-fill"></i> Event started successfully';
                        
                        // Show success
                        setTimeout(() => {
                            overlay.classList.remove('active');
                        }, 1500);
                        
                        // Update UI for active state
                        btnText.textContent = 'Stop Event';
                        btnIcon.className = 'bi bi-stop-circle text-lg';
                        if (btnRipple) {
                            btnRipple.className = 'transmission-ripple active';
                        }
                        
                        // Update status badge
                        if (eventStatusBadge) {
                            eventStatusBadge.textContent = 'ACTIVE';
                            eventStatusBadge.className = 'text-xs font-mono bg-[#1a2b4c] text-white px-2 py-0.5 rounded-full';
                        }
                        
                        // Update live indicator
                        if (liveIndicator) {
                            liveIndicator.className = 'w-1.5 h-1.5 bg-[#1a2b4c] rounded-full animate-pulse';
                        }
                        if (liveText) liveText.textContent = 'LIVE';
                        
                        // Show QR section if hidden
                        if (qrSection) {
                            qrSection.style.display = 'block';
                            setTimeout(() => {
                                qrSection.classList.add('carrier-wave', 'scan-line');
                            }, 100);
                        }
                        
                        if (carrierLock) {
                            carrierLock.innerHTML = 'CARRIER LOCK · ACTIVE';
                            carrierLock.classList.add('animate-pulse');
                        }
                        
                        if (qrSignal) {
                            qrSignal.innerHTML = '<span class="w-1.5 h-1.5 bg-[#1a2b4c] rounded-full animate-pulse"></span> SIGNAL · ACTIVE';
                        }
                        
                        // Update signal strength bars
                        document.querySelectorAll('.signal-strength').forEach(el => {
                            el.classList.add('active');
                        });
                        
                        Toast.show('Event started successfully', 'success');
                        
                    } else {
                        transitionStep.textContent = 'TRANSMISSION TERMINATED';
                        transitionProgressBar.classList.add('complete');
                        transitionComplete.style.display = 'block';
                        transitionComplete.querySelector('span').innerHTML = '<i class="bi bi-check-circle-fill"></i> Event stopped successfully';
                        
                        setTimeout(() => {
                            overlay.classList.remove('active');
                        }, 1500);
                        
                        // Update UI for inactive state
                        btnText.textContent = 'Start Event';
                        btnIcon.className = 'bi bi-play-circle text-lg';
                        if (btnRipple) {
                            btnRipple.className = 'transmission-ripple inactive';
                        }
                        
                        // Update status badge
                        if (eventStatusBadge) {
                            eventStatusBadge.textContent = 'INACTIVE';
                            eventStatusBadge.className = 'text-xs font-mono bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full';
                        }
                        
                        // Update live indicator
                        if (liveIndicator) {
                            liveIndicator.className = 'w-1.5 h-1.5 bg-gray-400 rounded-full';
                        }
                        if (liveText) liveText.textContent = 'OFFLINE';
                        
                        // Hide QR section with animation
                        if (qrSection) {
                            qrSection.classList.remove('carrier-wave', 'scan-line');
                            setTimeout(() => {
                                qrSection.style.display = 'none';
                            }, 300);
                        }
                        
                        if (carrierLock) {
                            carrierLock.innerHTML = 'CARRIER LOCK · INACTIVE';
                            carrierLock.classList.remove('animate-pulse');
                        }
                        
                        if (qrSignal) {
                            qrSignal.innerHTML = '<span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span> SIGNAL · INACTIVE';
                        }
                        
                        // Update signal strength bars
                        document.querySelectorAll('.signal-strength').forEach(el => {
                            el.classList.remove('active');
                        });
                        
                        Toast.show('Event stopped successfully', 'warning');
                    }
                    
                    // Force page refresh after transition to ensure all data is consistent
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Toggle event error:', error);
                    
                    clearInterval(progressInterval);
                    transitionProgressBar.style.width = '100%';
                    transitionProgressBar.classList.add('error');
                    transitionStep.textContent = 'TRANSMISSION FAILED';
                    transitionTimer.textContent = 'ERROR';
                    
                    Toast.show(`Failed to ${action} event`, 'error');
                    
                    setTimeout(() => {
                        overlay.classList.remove('active');
                    }, 2000);
                    
                } finally {
                    setTimeout(() => {
                        this.isTransitioning = false;
                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    }, 2000);
                }
            },
            
            // Update statistics with animation
            updateStats(stats) {
                const elements = {
                    'totalAttendeesStat': stats.total_attendees,
                    'totalRegisteredStat': stats.total_registered,
                    'totalPaid': stats.total_paid,
                    'totalPartial': stats.total_partial,
                    'totalRevenue': `RM ${stats.total_revenue}`,
                    'lastCheckinStat': stats.last_checkin_time,
                    'lastCheckinDateStat': stats.last_checkin_date,
                    'attendeeCount': `${stats.total_attendees} RECORDS`
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && value !== undefined) {
                        el.style.transform = 'scale(1.1)';
                        el.style.transition = 'transform 0.3s ease';
                        el.textContent = value;
                        setTimeout(() => {
                            el.style.transform = 'scale(1)';
                        }, 200);
                    }
                });
            }
        };
        
        // ============================================
        // MODAL INJECTOR - ENSURES MODALS ARE AT ROOT LEVEL
        // ============================================
        function injectModals() {
            if (document.getElementById('modalRoot')) return;
            
            const modalRoot = document.createElement('div');
            modalRoot.id = 'modalRoot';
            modalRoot.style.position = 'relative';
            modalRoot.style.zIndex = '999999';
            document.body.appendChild(modalRoot);
            
            // Modal HTML templates with dark blue accents
            const modalHTML = `
                <!-- ===== QR MODAL - PROJECTOR VIEW ===== -->
                <div id="qrModal" class="modal-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; align-items: center; justify-content: center; background-color: rgba(26,43,76,0.5); backdrop-filter: blur(4px); z-index: 999999; margin: 0; padding: 20px; box-sizing: border-box;">
                    <div class="modal-content" style="width: 100%; max-width: 600px; max-height: 90vh; background: var(--white); border: 1px solid var(--gray-200); border-radius: 24px; box-shadow: var(--neu-raised-deep); overflow: hidden; display: flex; flex-direction: column; margin: 0 auto; position: relative;">
                        <div style="position: sticky; top: 0; background: var(--white); z-index: 20; border-bottom: 1px solid var(--gray-200); flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 24px;">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg neu-inset flex items-center justify-center">
                                    <i class="bi bi-qr-code-scan text-[#1a2b4c]"></i>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-[#1a2b4c]">PROJECTOR VIEW</h4>
                                    <p class="text-xs text-gray-500">Display QR code for attendees</p>
                                </div>
                            </div>
                            <button onclick="Modal.close('qrModal')"
                                    class="w-8 h-8 rounded-lg neu-flat flex items-center justify-center text-gray-600 hover:text-[#1a2b4c]">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div style="flex: 1 1 auto; overflow-y: auto; padding: 24px; scrollbar-width: thin; scrollbar-color: var(--gray-300) var(--gray-100);">
                            {% if qr_image %}
                            <div class="flex flex-col items-center justify-center min-h-[400px]">
                                <div class="qr-container mb-8">
                                    <img src="data:image/png;base64,{{ qr_image }}" 
                                         alt="Event QR Code" 
                                         class="w-80 h-80 p-4 bg-white border border-gray-200 rounded-xl">
                                </div>
                                <div class="w-full max-w-2xl mb-8">
                                    <div class="text-xs font-mono text-gray-500 mb-2">CHECK-IN URL</div>
                                    <div class="neu-inset rounded-lg p-4 text-xs break-all font-mono bg-white text-[#1a2b4c]">
                                        {% if qr_url %}
                                            {{ qr_url }}
                                        {% else %}
                                            No URL available
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex gap-4">
                                    <button onclick="QRManager.copyUrl()"
                                            class="neu-raised-sm px-6 py-3 rounded-xl text-sm font-medium bg-[#1a2b4c] text-white hover:bg-[#2c3e5e] flex items-center gap-2 neu-tactile">
                                        <i class="bi bi-clipboard"></i>
                                        Copy URL
                                    </button>
                                    {% if qr_url %}
                                    <a href="{% url 'download_qr' event.id %}" 
                                       target="_blank"
                                       onclick="Toast.show('QR Code download started')"
                                       class="neu-raised-sm px-6 py-3 rounded-xl text-sm font-medium bg-white text-[#1a2b4c] border border-gray-200 flex items-center gap-2 neu-tactile">
                                        <i class="bi bi-download"></i>
                                        Download QR
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <div class="neu-inset rounded-xl p-6 bg-red-50 border border-red-200">
                                <div class="flex items-center gap-3">
                                    <i class="bi bi-exclamation-triangle-fill text-red-600 text-xl"></i>
                                    <span class="text-sm text-red-800">QR Code not available</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- ===== ATTENDEE DETAILS MODAL ===== -->
                <div id="attendeeModal" class="modal-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; align-items: center; justify-content: center; background-color: rgba(26,43,76,0.5); backdrop-filter: blur(4px); z-index: 999999; margin: 0; padding: 20px; box-sizing: border-box;">
                    <div class="modal-content" style="width: 100%; max-width: 1000px; max-height: 90vh; background: var(--white); border: 1px solid var(--gray-200); border-radius: 24px; box-shadow: var(--neu-raised-deep); overflow: hidden; display: flex; flex-direction: column; margin: 0 auto; position: relative;">
                        <div style="position: sticky; top: 0; background: var(--white); z-index: 20; border-bottom: 1px solid var(--gray-200); flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 24px;">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg neu-inset flex items-center justify-center">
                                    <i class="bi bi-person-badge text-[#1a2b4c]"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-[#1a2b4c]">ATTENDEE DETAILS</h4>
                            </div>
                            <button onclick="AttendeeDetails.close()"
                                    class="w-8 h-8 rounded-lg neu-flat flex items-center justify-center text-gray-600 hover:text-[#1a2b4c]">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div id="attendeeModalBody" style="flex: 1 1 auto; overflow-y: auto; padding: 24px; scrollbar-width: thin; scrollbar-color: var(--gray-300) var(--gray-100);">
                            <div class="flex items-center justify-center py-16">
                                <div class="text-center">
                                    <div class="w-12 h-12 border-4 border-[#1a2b4c] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                                    <p class="text-sm text-gray-500">Loading attendee details...</p>
                                </div>
                            </div>
                        </div>
                        <div style="position: sticky; bottom: 0; background: var(--white); z-index: 20; border-top: 1px solid var(--gray-200); flex-shrink: 0; display: flex; align-items: center; justify-content: flex-end; gap: 12px; padding: 24px;">
                            <button onclick="AttendeeDetails.close()"
                                    class="px-4 py-2 rounded-lg text-sm text-gray-600 hover:bg-[#1a2b4c]/5 transition-colors">
                                Close
                            </button>
                            <button onclick="printAttendeeForm()"
                                    id="printAttendeeBtn"
                                    class="px-4 py-2 rounded-lg text-sm bg-[#1a2b4c] text-white hover:bg-[#2c3e5e] transition-colors flex items-center gap-2 hidden">
                                <i class="bi bi-printer"></i> Print Application
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ===== REGISTRATION MODAL - DARK INSET STYLE ===== -->
                <div id="registrationModal" class="modal-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; align-items: center; justify-content: center; background-color: rgba(26,43,76,0.5); backdrop-filter: blur(4px); z-index: 999999; margin: 0; padding: 20px; box-sizing: border-box;">
                    <div class="modal-content" style="width: 100%; max-width: 1100px; max-height: 90vh; background: var(--white); border: 1px solid var(--gray-200); border-radius: 28px; box-shadow: var(--neu-raised-deep); overflow: hidden; display: flex; flex-direction: column; margin: 0 auto; position: relative;">
                        
                        <!-- STICKY HEADER -->
                        <div style="position: sticky; top: 0; background: var(--white); z-index: 20; border-bottom: 1px solid var(--gray-300); flex-shrink: 0; padding: 24px 28px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--neu-raised-deep);">
                            <div class="flex items-center gap-4">
                                <div style="width: 52px; height: 52px; background: var(--gray-100); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: var(--dark-blue); box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    <i class="bi bi-person-plus text-[#1a2b4c]"></i>
                                </div>
                                <div>
                                    <h4 id="modalTitle" class="text-xl font-bold text-[#1a2b4c] tracking-tight" style="letter-spacing: -0.01em;">REGISTRATION FORM</h4>
                                    <div style="font-size: 0.7rem; color: var(--gray-600); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 500; margin-top: 2px;">PAYMENT ENTRY · SIGNAL LOG</div>
                                </div>
                            </div>
                            <button onclick="RegistrationForm.close()"
                                    style="width: 48px; height: 48px; background: var(--gray-100); border: none; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--gray-700); box-shadow: inset 6px 6px 12px rgba(0,0,0,0.15), inset -4px -4px 10px rgba(255,255,255,0.9); transition: all 0.15s ease; cursor: pointer;">
                                <i class="bi bi-x-lg" style="font-size: 1.2rem;"></i>
                            </button>
                        </div>
                        
                        <!-- SCROLLABLE CONTENT -->
                        <div style="flex: 1 1 auto; overflow-y: auto; padding: 28px; background: var(--gray-50); scrollbar-width: thin; scrollbar-color: var(--gray-400) var(--gray-200);">
                            
                            <form id="registrationForm">
                                {% csrf_token %}
                                <input type="hidden" id="attendeeId" name="attendee_id">
                                
                                <!-- Attendee Preview Card -->
                                <div style="background: var(--white); border-radius: 24px; margin-bottom: 28px; padding: 24px; box-shadow: 16px 16px 28px rgba(0,0,0,0.08), -14px -14px 28px rgba(255,255,255,0.9); border: 1px solid var(--gray-200); position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 0; left: -30%; width: 40%; height: 100%; background: linear-gradient(90deg, transparent, rgba(26,43,76,0.04), transparent); animation: modalSweep 3s ease-in-out infinite; pointer-events: none;"></div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                                        <div>
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--gray-700); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">NAME</div>
                                            <div id="previewName" style="font-weight: 700; color: var(--dark-blue); font-size: 1.1rem; border-bottom: 1px solid var(--gray-300); padding-bottom: 6px;">Loading...</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--gray-700); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">EMAIL</div>
                                            <div id="previewEmail" style="font-weight: 500; color: var(--gray-800); font-size: 0.9rem; border-bottom: 1px solid var(--gray-300); padding-bottom: 6px; word-break: break-all;">Loading...</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--gray-700); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">CHECK-IN</div>
                                            <div id="previewCheckInTime" style="font-weight: 600; color: var(--dark-blue); font-size: 0.95rem; border-bottom: 1px solid var(--gray-300); padding-bottom: 6px;">Loading...</div>
                                        </div>
                                    </div>
                                    
                                    <div style="position: absolute; bottom: 12px; right: 20px; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 0.6rem; color: var(--gray-500); letter-spacing: 1px;">SIGNAL</span>
                                        <div style="display: flex; align-items: flex-end; gap: 3px; height: 16px;">
                                            <span style="width: 3px; background: var(--dark-blue); height: 6px; animation: signalPulse 1.2s infinite alternate; border-radius: 1px;"></span>
                                            <span style="width: 3px; background: var(--dark-blue); height: 10px; animation: signalPulse 1.2s infinite alternate; animation-delay: 0.2s; border-radius: 1px;"></span>
                                            <span style="width: 3px; background: var(--dark-blue); height: 14px; animation: signalPulse 1.2s infinite alternate; animation-delay: 0.4s; border-radius: 1px;"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Existing Registration Alert -->
                                <div id="checkoutTimeAlert" style="display: none; background: var(--gray-100); border: none; border-radius: 60px; padding: 16px 24px; margin-bottom: 28px; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.15), inset -4px -4px 10px rgba(255,255,255,0.9);" class="flex items-center gap-3">
                                    <i class="bi bi-clock-history" style="color: var(--dark-blue); font-size: 1.2rem;"></i>
                                    <div>
                                        <div style="font-weight: 700; color: var(--dark-blue); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px;">Updating Existing Registration</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600); margin-top: 2px;">Last updated: <span id="lastUpdatedTime">-</span></div>
                                    </div>
                                </div>
                                
                                <!-- Form Fields - DARK INSET -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div style="margin-bottom: 0;">
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Course Applied *</label>
                                        <input type="text" id="course" name="course" required
                                               placeholder="e.g. Diploma Kejuruteraan"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02); transition: all 0.2s;">
                                    </div>
                                    <div style="margin-bottom: 0;">
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">College/Branch *</label>
                                        <input type="text" id="college" name="college" required
                                               placeholder="e.g. UPKB Kuala Lumpur"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Registration Date *</label>
                                        <input type="date" id="register_date" name="register_date" required
                                               value="{% now 'Y-m-d' %}"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Payment Type</label>
                                        <select id="payment_type" name="payment_type"
                                                style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02); appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%231a2b4c" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>'); background-repeat: no-repeat; background-position: right 20px center; background-size: 16px;">
                                            <option value="">Select Payment Type</option>
                                            <option value="CASH">Cash</option>
                                            <option value="ONLINE_BANKING">Online Banking</option>
                                            <option value="QR_PAYMENT">QR Payment</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Pre-Reg Fee (RM)</label>
                                        <input type="number" id="pre_registration_fee" name="pre_registration_fee" step="0.01" min="0" value="0.00"
                                               oninput="RegistrationForm.updateAmountPaidField()"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Reg Fee (RM) *</label>
                                        <input type="number" id="registration_fee" name="registration_fee" step="0.01" min="0" required value="0.00"
                                               oninput="RegistrationForm.updateAmountPaidField()"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Payment Status *</label>
                                        <select id="payment_status" name="payment_status" required onchange="RegistrationForm.updatePaymentSummary()"
                                                style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02); appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%231a2b4c" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>'); background-repeat: no-repeat; background-position: right 20px center; background-size: 16px;">
                                            <option value="">Select Payment Status</option>
                                            <option value="PENDING">Pending</option>
                                            <option value="PARTIAL">Partially Paid</option>
                                            <option value="DONE">Completed</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Amount Paid (RM) *</label>
                                        <input type="number" id="amount_paid" name="amount_paid" step="0.01" min="0" required value="0.00"
                                               oninput="RegistrationForm.updatePaymentSummary()"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                        <p style="font-size: 0.65rem; color: var(--gray-500); margin-top: 4px; margin-left: 6px;">Amount received</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Closer *</label>
                                        <input type="text" id="closer" name="closer" 
                                               value="{{ request.user.get_full_name|default:request.user.username }}" required
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Referral Number</label>
                                        <input type="text" id="referral_number" name="referral_number"
                                               placeholder="e.g. SES/2024/001"
                                               style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    </div>
                                </div>
                                
                                <!-- PAYMENT SUMMARY CARD -->
                                <div style="background: var(--gray-100); border-radius: 28px; padding: 24px; margin-bottom: 28px; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02);">
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">TOTAL FEE</div>
                                            <div id="totalFeeDisplay" style="font-size: 1.6rem; font-weight: 800; color: var(--dark-blue); line-height: 1.2;">RM 0.00</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">AMOUNT PAID</div>
                                            <div id="displayAmountPaid" style="font-size: 1.6rem; font-weight: 800; color: #166534; line-height: 1.2;">RM 0.00</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">BALANCE</div>
                                            <div id="balanceDisplay" style="font-size: 1.6rem; font-weight: 800; color: var(--dark-blue); line-height: 1.2;">—</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.65rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase;">PAYMENT %</div>
                                            <div id="paymentPercentage" style="font-size: 1.6rem; font-weight: 800; color: var(--dark-blue); line-height: 1.2;">0%</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 12px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="font-size: 0.7rem; font-weight: 600; color: var(--dark-blue);">PAYMENT PROGRESS</span>
                                            <span id="paymentProgressLabel" style="font-size: 0.7rem; font-weight: 700; color: var(--dark-blue);">0%</span>
                                        </div>
                                        <div style="width: 100%; height: 10px; background: var(--gray-100); border-radius: 999px; box-shadow: inset 4px 4px 8px rgba(0,0,0,0.15), inset -2px -2px 6px rgba(255,255,255,0.9); overflow: hidden;">
                                            <div id="paymentProgressBar" class="progress-fill" style="height: 100%; background: linear-gradient(90deg, #1a2b4c, #2c3e5e); border-radius: 999px; width: 0%; transition: width 0.5s ease;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- STAFF REMARKS -->
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 0.7rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 8px; letter-spacing: 0.5px; text-transform: uppercase; margin-left: 6px;">Staff Remarks</label>
                                    <textarea id="remark" name="remark" rows="3"
                                              placeholder="Additional notes / verification details..."
                                              style="width: 100%; padding: 16px 18px; background: var(--gray-100); border: none; border-radius: 22px; font-size: 0.95rem; font-family: 'Inter', sans-serif; color: var(--dark-blue); font-weight: 500; box-shadow: inset 6px 6px 12px rgba(0,0,0,0.2), inset -4px -4px 10px rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.02); resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                                    <span style="display: flex; align-items: center; gap: 6px; font-size: 0.6rem; color: var(--gray-500); letter-spacing: 1px; text-transform: uppercase;">
                                        <span style="display: inline-flex; align-items: flex-end; gap: 2px; height: 12px;">
                                            <span style="width: 2px; background: var(--dark-blue); height: 4px;"></span>
                                            <span style="width: 2px; background: var(--dark-blue); height: 6px;"></span>
                                            <span style="width: 2px; background: var(--dark-blue); height: 8px;"></span>
                                        </span>
                                        TX·LOCK · ENCRYPTED
                                    </span>
                                </div>
                            </form>
                        </div>
                        
                        <!-- STICKY FOOTER -->
                        <div style="position: sticky; bottom: 0; background: var(--white); z-index: 20; border-top: 1px solid var(--gray-300); flex-shrink: 0; padding: 20px 28px; display: flex; align-items: center; justify-content: flex-end; gap: 16px; box-shadow: 0 -8px 20px rgba(0,0,0,0.04);">
                            
                            <button onclick="RegistrationForm.close()"
                                    style="padding: 14px 28px; background: var(--white); border: none; border-radius: 40px; font-size: 0.9rem; font-weight: 600; color: var(--gray-700); letter-spacing: 0.5px; box-shadow: 8px 8px 16px rgba(0,0,0,0.08), -6px -6px 16px rgba(255,255,255,0.9); transition: all 0.15s ease; cursor: pointer; display: flex; align-items: center; gap: 8px; border: 1px solid var(--gray-200);">
                                    <i class="bi bi-x-circle"></i> Cancel
                            </button>
                            
                            <button onclick="RegistrationForm.save()"
                                    id="saveRegistrationBtn"
                                    style="padding: 14px 32px; background: var(--dark-blue); border: none; border-radius: 40px; font-size: 0.9rem; font-weight: 700; color: var(--white); letter-spacing: 1px; box-shadow: 12px 12px 24px rgba(0,0,0,0.15), -8px -8px 20px rgba(255,255,255,0.8); transition: all 0.15s ease; cursor: pointer; display: flex; align-items: center; gap: 10px; border: 1px solid var(--gray-700); position: relative; overflow: hidden;">
                                    <span id="saveBtnText">Save Registration</span>
                                    <span id="saveSpinner" class="hidden" style="display: none;"><i class="bi bi-arrow-repeat spin"></i></span>
                                    <span style="position: absolute; top: 0; left: -30%; width: 30%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: btnScan 3s ease-in-out infinite;"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ===== STATISTICS MODAL - ENHANCED WITH CHARTS (NO AVERAGES) ===== -->
                <div id="statsModal" class="modal-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; align-items: center; justify-content: center; background-color: rgba(26,43,76,0.5); backdrop-filter: blur(4px); z-index: 999999; margin: 0; padding: 20px; box-sizing: border-box;">
                    <div class="modal-content" style="width: 100%; max-width: 1200px; max-height: 90vh; background: var(--white); border: 1px solid var(--gray-200); border-radius: 24px; box-shadow: var(--neu-raised-deep); overflow: hidden; display: flex; flex-direction: column; margin: 0 auto; position: relative;">
                        
                        <!-- STICKY HEADER -->
                        <div style="position: sticky; top: 0; background: var(--white); z-index: 30; border-bottom: 1px solid var(--gray-300); flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 20px 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.02);">
                            <div class="flex items-center gap-4">
                                <div style="width: 48px; height: 48px; background: var(--gray-100); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: inset 4px 4px 8px rgba(0,0,0,0.1), inset -2px -2px 6px rgba(255,255,255,0.8);">
                                    <i class="bi bi-bar-chart-steps text-[#1a2b4c] text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-[#1a2b4c] tracking-tight">REGISTRATION ANALYTICS</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span id="statsEventTitle" class="text-xs font-mono text-gray-600">{{ event.title }}</span>
                                        <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                        <span id="statsEventDate" class="text-xs font-mono text-gray-600">{{ event.date|date:"M d, Y" }}</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="StatisticsManager.close()"
                                    style="width: 44px; height: 44px; background: var(--gray-100); border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: var(--gray-700); box-shadow: inset 4px 4px 8px rgba(0,0,0,0.1), inset -2px -2px 6px rgba(255,255,255,0.8); transition: all 0.2s ease; cursor: pointer;"
                                    onmouseover="this.style.background='var(--gray-200)'"
                                    onmouseout="this.style.background='var(--gray-100)'">
                                <i class="bi bi-x-lg" style="font-size: 1.2rem;"></i>
                            </button>
                        </div>
                        
                        <!-- SCROLLABLE CONTENT - ENHANCED WITH ALL CHARTS (NO AVERAGES) -->
                        <div style="flex: 1 1 auto; overflow-y: auto; padding: 28px; background: var(--gray-50); scrollbar-width: thin; scrollbar-color: var(--gray-400) var(--gray-200);">
                            
                            <!-- ===== SECTION 1: KEY METRICS CARDS ===== -->
                            <div style="margin-bottom: 32px;">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="signal-strength !h-5">
                                        <div class="bar !w-1.5"></div>
                                        <div class="bar !w-1.5"></div>
                                        <div class="bar !w-1.5"></div>
                                        <div class="bar !w-1.5"></div>
                                        <div class="bar !w-1.5"></div>
                                    </div>
                                    <span class="text-xs font-mono text-gray-500 tracking-wider">PERFORMANCE INDICATORS</span>
                                </div>
                                
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-5">
                                    <!-- Total Registered -->
                                    <div class="neu-raised-sm rounded-2xl p-5 bg-white transition-all duration-300 hover:translate-y-[-2px]">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-mono text-gray-500 uppercase tracking-wider">REGISTERED</span>
                                            <div class="w-8 h-8 rounded-xl neu-inset-sm flex items-center justify-center">
                                                <i class="bi bi-people text-[#1a2b4c] text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-[#1a2b4c]" id="statsTotalRegistered">0</div>
                                        <div class="mt-2 text-xs text-gray-400 flex items-center gap-1">
                                            <i class="bi bi-person-check"></i>
                                            <span>Total registrations</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Pre-Registration Fee -->
                                    <div class="neu-raised-sm rounded-2xl p-5 bg-white transition-all duration-300 hover:translate-y-[-2px]">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-mono text-gray-500 uppercase tracking-wider">PRE-REG</span>
                                            <div class="w-8 h-8 rounded-xl neu-inset-sm flex items-center justify-center">
                                                <i class="bi bi-file-text text-[#1a2b4c] text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-[#1a2b4c]" id="statsPreRegAmount">RM 0.00</div>
                                        <div class="mt-2 text-xs text-gray-400 flex items-center gap-1">
                                            <i class="bi bi-arrow-up"></i>
                                            <span>Pre-registration fee total</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Registration Fee -->
                                    <div class="neu-raised-sm rounded-2xl p-5 bg-white transition-all duration-300 hover:translate-y-[-2px]">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-mono text-gray-500 uppercase tracking-wider">REG FEE</span>
                                            <div class="w-8 h-8 rounded-xl neu-inset-sm flex items-center justify-center">
                                                <i class="bi bi-cash text-[#1a2b4c] text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-[#1a2b4c]" id="statsRegAmount">RM 0.00</div>
                                        <div class="mt-2 text-xs text-gray-400 flex items-center gap-1">
                                            <i class="bi bi-arrow-up"></i>
                                            <span>Registration fee total</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Revenue -->
                                    <div class="neu-raised-sm rounded-2xl p-5 bg-white transition-all duration-300 hover:translate-y-[-2px]">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-mono text-gray-500 uppercase tracking-wider">REVENUE</span>
                                            <div class="w-8 h-8 rounded-xl neu-inset-sm flex items-center justify-center">
                                                <i class="bi bi-coin text-[#1a2b4c] text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-[#1a2b4c]" id="statsTotalRevenue">RM 0.00</div>
                                        <div class="mt-2 text-xs text-gray-400 flex items-center gap-1">
                                            <i class="bi bi-graph-up"></i>
                                            <span>Total revenue collected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ===== SECTION 2: PAYMENT STATUS BREAKDOWN ===== -->
                            <div class="neu-raised rounded-2xl p-6 mb-8 bg-white">
                                <div class="flex items-center justify-between mb-6">
                                    <h5 class="font-semibold text-[#1a2b4c] flex items-center gap-2 text-lg">
                                        <i class="bi bi-pie-chart"></i> PAYMENT STATUS BREAKDOWN
                                    </h5>
                                    <span id="paymentStatusSummary" class="text-xs font-mono bg-[#1a2b4c]/5 px-3 py-1.5 rounded-full">
                                        Updated real-time
                                    </span>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <!-- Completed Status -->
                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-2">
                                                <span class="w-3 h-3 bg-green-600 rounded-full animate-pulse"></span>
                                                <span class="text-sm font-medium text-gray-700">COMPLETED</span>
                                            </div>
                                            <span class="text-2xl font-bold text-green-700" id="statsCompletedCount">0</span>
                                        </div>
                                        <div class="progress-container h-3 bg-gray-100 rounded-full overflow-hidden">
                                            <div id="statsCompletedBar" class="progress-fill bg-green-600 h-full rounded-full transition-all duration-700" style="width: 0%;"></div>
                                        </div>
                                        <div class="flex justify-between mt-2">
                                            <span class="text-xs text-gray-500">Fully paid</span>
                                            <span id="completedPercentage" class="text-xs font-mono text-gray-600">0%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Partial Status -->
                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-2">
                                                <span class="w-3 h-3 bg-yellow-600 rounded-full animate-pulse" style="animation-delay: 0.3s;"></span>
                                                <span class="text-sm font-medium text-gray-700">PARTIAL</span>
                                            </div>
                                            <span class="text-2xl font-bold text-yellow-700" id="statsPartialCount">0</span>
                                        </div>
                                        <div class="progress-container h-3 bg-gray-100 rounded-full overflow-hidden">
                                            <div id="statsPartialBar" class="progress-fill bg-yellow-600 h-full rounded-full transition-all duration-700" style="width: 0%;"></div>
                                        </div>
                                        <div class="flex justify-between mt-2">
                                            <span class="text-xs text-gray-500">Partially paid</span>
                                            <span id="partialPercentage" class="text-xs font-mono text-gray-600">0%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Pending Status -->
                                    <div class="relative">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-2">
                                                <span class="w-3 h-3 bg-red-600 rounded-full animate-pulse" style="animation-delay: 0.6s;"></span>
                                                <span class="text-sm font-medium text-gray-700">PENDING</span>
                                            </div>
                                            <span class="text-2xl font-bold text-red-700" id="statsPendingCount">0</span>
                                        </div>
                                        <div class="progress-container h-3 bg-gray-100 rounded-full overflow-hidden">
                                            <div id="statsPendingBar" class="progress-fill bg-red-600 h-full rounded-full transition-all duration-700" style="width: 0%;"></div>
                                        </div>
                                        <div class="flex justify-between mt-2">
                                            <span class="text-xs text-gray-500">Awaiting payment</span>
                                            <span id="pendingPercentage" class="text-xs font-mono text-gray-600">0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary Stats - NO AVERAGES -->
                                <div class="mt-6 pt-6 border-t border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="text-center">
                                        <span class="text-xs text-gray-500">TOTAL TRANSACTIONS</span>
                                        <div class="text-xl font-bold text-[#1a2b4c]" id="statsTotalTransactions">0</div>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-xs text-gray-500">COMPLETION RATE</span>
                                        <div class="text-xl font-bold text-green-600" id="statsCompletionRate">0%</div>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-xs text-gray-500">PARTIAL RATE</span>
                                        <div class="text-xl font-bold text-yellow-600" id="statsPartialRate">0%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ===== SECTION 3: TOP PERFORMERS - CHARTS GRID ===== -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                
                                <!-- TOP CLOSERS CHART -->
                                <div class="neu-raised rounded-2xl p-6 bg-white">
                                    <div class="flex items-center justify-between mb-5">
                                        <h5 class="font-semibold text-[#1a2b4c] flex items-center gap-2">
                                            <i class="bi bi-trophy-fill text-yellow-500"></i> TOP PERFORMING CLOSERS
                                        </h5>
                                        <span class="text-xs font-mono bg-[#1a2b4c]/5 px-2 py-1 rounded-full">Revenue leaders</span>
                                    </div>
                                    
                                    <!-- Chart Container -->
                                    <div id="topClosersChart" class="w-full h-64 relative">
                                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                            <i class="bi bi-bar-chart text-5xl mb-3"></i>
                                            <span class="text-sm font-mono">Loading chart data...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- List View Fallback/Summary -->
                                    <div id="topClosersList" class="mt-5 space-y-2 border-t border-gray-100 pt-4">
                                        <!-- Dynamically populated -->
                                    </div>
                                    
                                    <div class="mt-3 text-right">
                                        <span class="text-xs text-gray-400 flex items-center justify-end gap-1">
                                            <i class="bi bi-arrow-up-short"></i> Sorted by registrations
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- TOP COURSES CHART -->
                                <div class="neu-raised rounded-2xl p-6 bg-white">
                                    <div class="flex items-center justify-between mb-5">
                                        <h5 class="font-semibold text-[#1a2b4c] flex items-center gap-2">
                                            <i class="bi bi-book-fill text-blue-600"></i> MOST POPULAR COURSES
                                        </h5>
                                        <span class="text-xs font-mono bg-[#1a2b4c]/5 px-2 py-1 rounded-full">By enrollment</span>
                                    </div>
                                    
                                    <!-- Chart Container -->
                                    <div id="topCoursesChart" class="w-full h-64 relative">
                                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                            <i class="bi bi-pie-chart text-5xl mb-3"></i>
                                            <span class="text-sm font-mono">Loading chart data...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- List View Fallback/Summary -->
                                    <div id="topCoursesList" class="mt-5 space-y-2 border-t border-gray-100 pt-4">
                                        <!-- Dynamically populated -->
                                    </div>
                                    
                                    <div class="mt-3 text-right">
                                        <span class="text-xs text-gray-400 flex items-center justify-end gap-1">
                                            <i class="bi bi-arrow-up-short"></i> Top 5 courses
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ===== SECTION 5: PAYMENT ANALYSIS ===== -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                
                                <!-- PAYMENT METHODS DISTRIBUTION -->
                                <div class="neu-raised rounded-2xl p-6 bg-white">
                                    <div class="flex items-center justify-between mb-5">
                                        <h5 class="font-semibold text-[#1a2b4c] flex items-center gap-2">
                                            <i class="bi bi-credit-card"></i> PAYMENT METHODS
                                        </h5>
                                        <span class="text-xs font-mono bg-[#1a2b4c]/5 px-2 py-1 rounded-full">Transaction types</span>
                                    </div>
                                    
                                    <!-- Chart Container -->
                                    <div id="paymentTypesChart" class="w-full h-64 relative">
                                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                            <i class="bi bi-pie-chart text-5xl mb-3"></i>
                                            <span class="text-sm font-mono">Loading payment data...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Method Summary -->
                                    <div id="paymentTypesSummary" class="mt-5 space-y-3 border-t border-gray-100 pt-4">
                                        <!-- Dynamically populated -->
                                    </div>
                                </div>
                                
                                <!-- PAYMENT STATUS DISTRIBUTION (DETAILED) -->
                                <div class="neu-raised rounded-2xl p-6 bg-white">
                                    <div class="flex items-center justify-between mb-5">
                                        <h5 class="font-semibold text-[#1a2b4c] flex items-center gap-2">
                                            <i class="bi bi-flag"></i> PAYMENT STATUS
                                        </h5>
                                        <span class="text-xs font-mono bg-[#1a2b4c]/5 px-2 py-1 rounded-full">Distribution</span>
                                    </div>
                                    
                                    <!-- Chart Container -->
                                    <div id="paymentStatusChart" class="w-full h-64 relative">
                                        <div class="flex flex-col items-center justify-center h-full text-gray-400">
                                            <i class="bi bi-pie-chart text-5xl mb-3"></i>
                                            <span class="text-sm font-mono">Loading status data...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Status Summary -->
                                    <div id="paymentStatusSummary" class="mt-5 space-y-3 border-t border-gray-100 pt-4">
                                        <!-- Dynamically populated -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ===== SECTION 6: DETAILED STATISTICS TABLE - NO AVERAGES ===== -->
                            <div class="neu-raised rounded-2xl p-6 bg-white">
                                <div class="flex items-center justify-between mb-5">
                                    <h5 class="font-semibold text-[#1a2b4c] flex items-center gap-2">
                                        <i class="bi bi-table"></i> REGISTRATION SUMMARY
                                    </h5>
                                    <span class="text-xs font-mono bg-[#1a2b4c]/5 px-2 py-1 rounded-full">
                                        <i class="bi bi-database"></i> Live data
                                    </span>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-[#1a2b4c]/5 text-gray-600 text-xs font-mono uppercase">
                                                <th class="py-3 px-4 text-left rounded-l-lg">Metric</th>
                                                <th class="py-3 px-4 text-right">Count</th>
                                                <th class="py-3 px-4 text-right">Amount (RM)</th>
                                                <th class="py-3 px-4 text-right rounded-r-lg">% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100">
                                            <tr>
                                                <td class="py-3 px-4 font-medium text-[#1a2b4c]">Total Registrations</td>
                                                <td class="py-3 px-4 text-right font-bold text-[#1a2b4c]" id="detailTotalReg">0</td>
                                                <td class="py-3 px-4 text-right" id="detailTotalRevenue">0.00</td>
                                                <td class="py-3 px-4 text-right">100%</td>
                                            </tr>
                                            <tr class="bg-green-50/30">
                                                <td class="py-3 px-4 pl-8 text-green-800">├─ Completed</td>
                                                <td class="py-3 px-4 text-right text-green-700" id="detailCompletedCount">0</td>
                                                <td class="py-3 px-4 text-right text-green-700" id="detailCompletedRevenue">0.00</td>
                                                <td class="py-3 px-4 text-right text-green-700" id="detailCompletedPercent">0%</td>
                                            </tr>
                                            <tr class="bg-yellow-50/30">
                                                <td class="py-3 px-4 pl-8 text-yellow-800">├─ Partial</td>
                                                <td class="py-3 px-4 text-right text-yellow-700" id="detailPartialCount">0</td>
                                                <td class="py-3 px-4 text-right text-yellow-700" id="detailPartialRevenue">0.00</td>
                                                <td class="py-3 px-4 text-right text-yellow-700" id="detailPartialPercent">0%</td>
                                            </tr>
                                            <tr class="bg-red-50/30">
                                                <td class="py-3 px-4 pl-8 text-red-800">└─ Pending</td>
                                                <td class="py-3 px-4 text-right text-red-700" id="detailPendingCount">0</td>
                                                <td class="py-3 px-4 text-right text-red-700" id="detailPendingRevenue">0.00</td>
                                                <td class="py-3 px-4 text-right text-red-700" id="detailPendingPercent">0%</td>
                                            </tr>
                                            <tr class="border-t-2 border-gray-200">
                                                <td class="py-3 px-4 font-medium text-[#1a2b4c]">Pre-Registration Fee</td>
                                                <td class="py-3 px-4 text-right">—</td>
                                                <td class="py-3 px-4 text-right font-bold text-[#1a2b4c]" id="detailPreRegTotal">0.00</td>
                                                <td class="py-3 px-4 text-right" id="detailPreRegPercent">0%</td>
                                            </tr>
                                            <tr>
                                                <td class="py-3 px-4 font-medium text-[#1a2b4c]">Registration Fee</td>
                                                <td class="py-3 px-4 text-right">—</td>
                                                <td class="py-3 px-4 text-right font-bold text-[#1a2b4c]" id="detailRegTotal">0.00</td>
                                                <td class="py-3 px-4 text-right" id="detailRegPercent">0%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Last Updated Timestamp -->
                            <div class="flex justify-end items-center gap-2 mt-6 text-xs text-gray-400 font-mono">
                                <i class="bi bi-clock"></i>
                                <span id="statsLastUpdated">Last updated: just now</span>
                                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                <i class="bi bi-database"></i>
                                <span>Event ID: {{ event.id }}</span>
                            </div>
                        </div>
                        
                        <!-- STICKY FOOTER WITH EXPORT ACTIONS -->
                        <div style="position: sticky; bottom: 0; background: var(--white); z-index: 30; border-top: 1px solid var(--gray-300); flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 20px 28px; box-shadow: 0 -4px 12px rgba(0,0,0,0.02);">
                            
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-gray-500 flex items-center gap-2">
                                    <span class="transmission-ripple active" style="position: relative; width: 10px; height: 10px; display: inline-block;"></span>
                                    LIVE DATA
                                </span>
                                <span class="text-xs bg-[#1a2b4c]/5 px-2 py-1 rounded-full font-mono" id="statsRecordCount">
                                    0 records
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <button onclick="StatisticsManager.exportRegistrationCSV()" 
                                        class="px-5 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:text-[#1a2b4c] flex items-center gap-2 bg-white neu-tactile transition-all duration-300 hover:scale-105 border border-gray-200">
                                    <i class="bi bi-filetype-csv"></i>
                                    <span>CSV Export</span>
                                </button>
                                
                                <button onclick="StatisticsManager.exportRegistrationPDF()" 
                                        class="px-5 py-2.5 rounded-xl text-sm font-medium bg-[#1a2b4c] text-white hover:bg-[#2c3e5e] flex items-center gap-2 neu-tactile transition-all duration-300 hover:scale-105">
                                    <i class="bi bi-file-pdf"></i>
                                    <span>PDF Report</span>
                                </button>
                                
                                <button onclick="StatisticsManager.refresh()" 
                                        class="p-2.5 rounded-xl text-gray-600 hover:text-[#1a2b4c] bg-white neu-tactile transition-all duration-300 hover:scale-110 border border-gray-200"
                                        title="Refresh data">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== DELETE CONFIRMATION MODAL ===== -->
                <div id="deleteConfirmModal" class="modal-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; align-items: center; justify-content: center; background-color: rgba(26,43,76,0.5); backdrop-filter: blur(4px); z-index: 999999; margin: 0; padding: 20px; box-sizing: border-box;">
                    <div class="modal-content" style="width: 100%; max-width: 550px; max-height: 90vh; background: var(--white); border: 1px solid var(--gray-200); border-radius: 24px; box-shadow: var(--neu-raised-deep); overflow: hidden; display: flex; flex-direction: column; margin: 0 auto; position: relative;">
                        <div style="background: #dc2626; padding: 24px; color: white; display: flex; align-items: center; gap: 12px;">
                            <i class="bi bi-exclamation-triangle-fill text-xl"></i>
                            <h4 class="text-lg font-semibold">CONFIRM DELETION</h4>
                        </div>
                        <div style="flex: 1 1 auto; padding: 24px; text-align: center;">
                            <div class="mb-4">
                                <i class="bi bi-trash text-red-600 text-5xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-[#1a2b4c] mb-3">Delete this attendee?</h5>
                            <p class="text-gray-600 mb-4" id="deleteAttendeeName">Loading...</p>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-left">
                                <div class="flex items-start gap-2">
                                    <i class="bi bi-exclamation-circle text-red-600 mt-0.5"></i>
                                    <div>
                                        <div class="font-medium text-red-800">Warning</div>
                                        <p class="text-xs text-red-700 mt-1">This action cannot be undone. All associated data will be permanently deleted.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="position: sticky; bottom: 0; background: var(--white); z-index: 20; border-top: 1px solid var(--gray-200); flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 24px;">
                            <button onclick="DeleteManager.close()"
                                    class="px-5 py-2.5 rounded-lg text-sm text-gray-600 hover:bg-[#1a2b4c]/5 transition-colors flex items-center gap-2">
                                Cancel
                            </button>
                            <button onclick="DeleteManager.delete()"
                                    id="confirmDeleteBtn"
                                    class="px-5 py-2.5 rounded-lg text-sm bg-red-600 text-white hover:bg-red-700 transition-colors flex items-center gap-2">
                                <i class="bi bi-trash"></i> Delete Attendee
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modalRoot.innerHTML = modalHTML;
        }
        
        // ============================================
        // ADDITIONAL STYLES FOR ENHANCED ANIMATIONS
        // ============================================
        const style = document.createElement('style');
        style.textContent = `
            /* Keyframe animations - matching check_in page */
            @keyframes modalSweep {
                0% { left: -40%; }
                100% { left: 140%; }
            }
            
            @keyframes signalPulse {
                0% { opacity: 0.3; height: 4px; }
                100% { opacity: 1; height: 14px; }
            }
            
            @keyframes btnScan {
                0% { left: -30%; }
                100% { left: 130%; }
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .spin {
                animation: spin 1s linear infinite;
                display: inline-block;
            }
            
            /* Focus states - matching check_in deep inset */
            #registrationModal input:focus,
            #registrationModal select:focus,
            #registrationModal textarea:focus {
                outline: none !important;
                box-shadow: 
                    inset 8px 8px 16px rgba(0, 0, 0, 0.25),
                    inset -6px -6px 12px rgba(255, 255, 255, 0.95),
                    0 0 0 3px rgba(26,43,76,0.1) !important;
                background: var(--gray-50) !important;
            }
            
            /* Hover lift effect for buttons */
            #registrationModal button:not([disabled]):hover {
                transform: translateY(-2px);
            }
            
            #registrationModal button:active:not([disabled]) {
                transform: translateY(1px);
                box-shadow: inset 4px 4px 8px rgba(0,0,0,0.2), inset -2px -2px 6px rgba(255,255,255,0.8) !important;
            }
            
            /* Custom scrollbar */
            #registrationModal [style*="overflow-y: auto"]::-webkit-scrollbar {
                width: 6px;
            }
            #registrationModal [style*="overflow-y: auto"]::-webkit-scrollbar-track {
                background: var(--gray-200);
                border-radius: 10px;
            }
            #registrationModal [style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
                background: var(--gray-500);
                border-radius: 10px;
            }
            
            /* Pulse animation for active elements */
            .pulse-animation {
                animation: dataPulse 2s ease-out infinite;
            }
        `;
        document.head.appendChild(style);
        
        // Inject modals when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', injectModals);
        } else {
            injectModals();
        }
        
        // ============================================
        // EXPOSE GLOBAL OBJECTS
        // ============================================
        window.Toast = Toast;
        window.EventManager = EventManager;
        
    })();
</script>

<!-- ===== EXISTING SCRIPT FROM ORIGINAL WITH UPDATED PRINT FUNCTION ===== -->
<script>
// ============================================
// GLOBAL CONFIGURATION AND STATE
// ============================================
const CONFIG = {
    LOGO_URL: "/static/images/SES_LOGO_RENEW.png",
    LOGO_URL1: "/static/images/seslogoo.png",
    UPKB_LOGO_URL: "/static/images/upkb.png",
    CSRF_TOKEN: document.querySelector('[name=csrfmiddlewaretoken]')?.value,
    EVENT_ID: {{ event.id }}
};

// State management
const state = {
    currentAttendeeId: null,
    currentAttendeeData: null,
    attendeeToDelete: null,
    searchDebounceTimer: null,
    activeFilter: 'all',
    charts: {}
};

// DOM Element cache
const DOM = {
    qrModal: document.getElementById('qrModal'),
    attendeeModal: document.getElementById('attendeeModal'),
    registrationModal: document.getElementById('registrationModal'),
    statsModal: document.getElementById('statsModal'),
    deleteModal: document.getElementById('deleteConfirmModal'),
    attendeesTable: document.getElementById('attendeesTable'),
    searchInput: document.getElementById('attendeeSearch'),
    toast: document.getElementById('toast'),
    toastMessage: document.getElementById('toastMessage'),
    totalRegistered: document.getElementById('totalRegistered'),
    totalPaid: document.getElementById('totalPaid'),
    totalPartial: document.getElementById('totalPartial'),
    totalRevenue: document.getElementById('totalRevenue'),
    attendeesCount: document.getElementById('attendeesCount')
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function $(selector) { return document.querySelector(selector); }
function $$(selector) { return document.querySelectorAll(selector); }

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toUpperCase(value) {
    if (!value) return '';
    return value.toString().toUpperCase();
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

function formatCurrency(amount) {
    return `RM ${parseFloat(amount || 0).toFixed(2)}`;
}

function formatDateTime(dateString, format = 'time') {
    if (!dateString) return '—';
    const date = new Date(dateString);
    switch(format) {
        case 'time': return date.toLocaleTimeString('en-MY', { hour: '2-digit', minute: '2-digit' });
        case 'date': return date.toLocaleDateString('en-MY', { day: '2-digit', month: 'short', year: 'numeric' });
        case 'datetime': return date.toLocaleString('en-MY', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        default: return date.toLocaleString('en-MY');
    }
}

// ============================================
// MODAL MANAGEMENT SYSTEM
// ============================================
const Modal = {
    open(modalId, options = {}) {
        const modal = document.getElementById(modalId);
        if (!modal) { 
            console.error(`Modal ${modalId} not found`);
            Toast.show(`Modal ${modalId} not found`, 'error');
            return null; 
        }
        
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
        modal.style.display = 'flex';
        if (options.onOpen) setTimeout(options.onOpen, 50);
        return modal;
    },
    
    close(modalId, options = {}) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            if (options.onClose) options.onClose();
        }
    },
    
    closeAll() {
        $$('.modal-container').forEach(modal => {
            modal.style.display = 'none';
        });
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
    }
};

// Modal backdrop click handlers
document.addEventListener('click', (e) => {
    if (e.target.classList && e.target.classList.contains('modal-container')) {
        const modalId = e.target.id;
        Modal.close(modalId);
    }
});

// Escape key handler
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        Modal.closeAll();
    }
});

// ============================================
// API SERVICE
// ============================================
const ApiService = {
    async request(url, options = {}) {
        const defaultOptions = {
            headers: { 
                'X-CSRFToken': CONFIG.CSRF_TOKEN, 
                'Content-Type': 'application/json', 
                ...options.headers 
            }
        };
        try {
            const response = await fetch(url, { ...defaultOptions, ...options });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            return await response.json();
        } catch (error) { 
            console.error('API Request failed:', error); 
            Toast.show(error.message, 'error'); 
            throw error; 
        }
    },
    async getAttendeeDetails(attendeeId) { 
        return this.request(`/attsys/api/attendee/${attendeeId}/details/`); 
    },
    async getAttendeeRegistration(attendeeId) { 
        return this.request(`/attsys/api/attendee/${attendeeId}/registration/`); 
    },
    async deleteAttendee(attendeeId) { 
        return this.request(`/attsys/api/attendee/${attendeeId}/delete/`, { method: 'DELETE' }); 
    },
    async saveRegistration(formData) {
        const options = { 
            method: 'POST', 
            body: formData,
            headers: {
                'X-CSRFToken': CONFIG.CSRF_TOKEN
            }
        };
        return this.request('/attsys/api/registration/save/', options);
    },
    async getRegistrationStats() { 
        return this.request(`/attsys/api/event/${CONFIG.EVENT_ID}/registration-stats/`); 
    },
    async getFullRegistrationStats() { 
        return this.request(`/attsys/api/event/${CONFIG.EVENT_ID}/registration-full-stats/`); 
    }
};

// ============================================
// ATTENDEE TABLE MANAGEMENT
// ============================================
const AttendeeTable = {
    initSearch() {
        if (!DOM.searchInput) return;
        const searchHandler = debounce((searchTerm) => {
            const searchLower = searchTerm.toLowerCase().trim();
            const rows = DOM.attendeesTable.querySelectorAll('tbody tr');
            let visibleCount = 0;
            rows.forEach(row => {
                const attendeeId = row.dataset.attendeeId;
                const icNumber = row.dataset.icNumber || '';
                const name = row.querySelector('.font-medium')?.textContent.toLowerCase() || '';
                const email = row.querySelector('.text-xs.text-gray-500')?.textContent.toLowerCase() || '';
                const referralDiv = document.getElementById(`inviting-officer-cell-${attendeeId}`);
                const referralText = referralDiv?.textContent.toLowerCase() || '';
                const hasMatch = name.includes(searchLower) || email.includes(searchLower) || icNumber.toLowerCase().includes(searchLower) || referralText.includes(searchLower);
                row.classList.toggle('hidden', !hasMatch && searchTerm);
                if (!hasMatch && searchTerm) return;
                visibleCount++;
            });
            if (DOM.attendeesCount) DOM.attendeesCount.textContent = visibleCount;
        }, 300);
        DOM.searchInput.addEventListener('input', (e) => searchHandler(e.target.value));
    },
    initFilters() {
        const filterButtons = $$('#attendeeSearch + div button');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.textContent.toLowerCase();
                AttendeeTable.applyFilter(filterType);
                filterButtons.forEach(b => {
                    b.classList.remove('bg-[#1a2b4c]', 'text-white', 'border-[#1a2b4c]');
                    b.classList.add('border-[#1a2b4c]/20', 'text-gray-700', 'bg-white');
                });
                btn.classList.add('bg-[#1a2b4c]', 'text-white', 'border-[#1a2b4c]');
            });
        });
    },
    applyFilter(filterType) {
        state.activeFilter = filterType;
        const rows = DOM.attendeesTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const attendeeId = row.dataset.attendeeId;
            const statusDiv = document.getElementById(`payment-status-cell-${attendeeId}`);
            if (filterType === 'all') { row.classList.remove('hidden'); return; }
            if (!statusDiv) { row.classList.add('hidden'); return; }
            const statusText = statusDiv.textContent.toLowerCase();
            let shouldShow = false;
            switch(filterType) {
                case 'paid': shouldShow = statusText.includes('paid') || statusText.includes('done'); break;
                case 'partial': shouldShow = statusText.includes('partial'); break;
                case 'pending': shouldShow = statusText.includes('pending'); break;
            }
            row.classList.toggle('hidden', !shouldShow);
        });
    },
    updateRow(attendeeId, registration) {
        const row = document.getElementById(`attendee-row-${attendeeId}`);
        if (!row) return;
        const paymentTypeCell = document.getElementById(`payment-type-cell-${attendeeId}`);
        if (paymentTypeCell && registration.payment_type) {
            const typeMap = { 'CASH': 'bg-blue-100 text-blue-800', 'ONLINE_BANKING': 'bg-teal-100 text-teal-800', 'QR_PAYMENT': 'bg-green-100 text-green-800' };
            paymentTypeCell.innerHTML = `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${typeMap[registration.payment_type] || 'bg-gray-100 text-gray-800'}">${registration.payment_type || '—'}</span>`;
        }
        const statusCell = document.getElementById(`payment-status-cell-${attendeeId}`);
        if (statusCell) {
            const statusMap = { 'DONE': 'badge-paid', 'PARTIAL': 'badge-partial', 'PENDING': 'badge-pending' };
            statusCell.innerHTML = `<span class="payment-badge ${statusMap[registration.payment_status] || ''}">${registration.payment_status || '—'}</span>`;
        }
        const amountCell = document.getElementById(`payment-amount-cell-${attendeeId}`);
        if (amountCell) amountCell.innerHTML = `<div class="text-sm font-medium text-[#1a2b4c]">RM ${parseFloat(registration.amount_paid || 0).toFixed(0)}</div>`;
        const regButton = row.querySelector('[onclick*="openRegistrationModal"]');
        if (regButton) { regButton.className = "p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition-colors"; regButton.innerHTML = '<i class="bi bi-pencil text-lg"></i>'; regButton.title = "Update Registration"; }
    },
    removeRow(attendeeId) {
        const row = document.getElementById(`attendee-row-${attendeeId}`);
        if (row) row.remove();
        if (DOM.attendeesCount) {
            const currentCount = parseInt(DOM.attendeesCount.textContent) || 0;
            DOM.attendeesCount.textContent = Math.max(0, currentCount - 1);
        }
    }
};

// ============================================
// QR CODE MANAGEMENT
// ============================================
const QRManager = {
    copyUrl() {
        const urlElement = document.querySelector('#qrModal .neu-inset.p-4.text-xs.break-all');
        const url = urlElement ? urlElement.textContent.trim() : '{{ qr_url|default:"" }}';
        if (!url || url === 'No URL available') { Toast.show('QR URL is not available', 'error'); return; }
        navigator.clipboard.writeText(url).then(() => Toast.show('URL copied to clipboard')).catch(() => {
            const textArea = document.createElement('textarea'); textArea.value = url; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); Toast.show('URL copied to clipboard');
        });
    },
    openModal() { 
        Modal.open('qrModal'); 
    },
    init() {
        const qrImage = document.getElementById('qrImage');
        if (qrImage) qrImage.addEventListener('click', this.openModal);
    }
};

// ============================================
// ATTENDEE DETAILS MODAL - UPDATED WITH PROPER PRINT BUTTON
// ============================================
const AttendeeDetails = {
    async show(attendeeId) {
        state.currentAttendeeId = attendeeId;
        Modal.open('attendeeModal', { onOpen: () => { this.loadDetails(attendeeId); this.togglePrintButton(false); } });
    },
    close() { Modal.close('attendeeModal'); },
    async loadDetails(attendeeId) {
        const modalBody = document.getElementById('attendeeModalBody');
        modalBody.innerHTML = `<div class="flex items-center justify-center py-16"><div class="text-center"><div class="w-12 h-12 border-4 border-[#1a2b4c] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div><p class="text-sm text-gray-500">Loading complete details...</p></div></div>`;
        try {
            const data = await ApiService.getAttendeeDetails(attendeeId);
            state.currentAttendeeData = data;
            if (data.attendee) { 
                modalBody.innerHTML = this.buildDetailsHTML(data); 
                this.togglePrintButton(!!data.application); 
            } 
            else modalBody.innerHTML = this.buildErrorHTML('No attendee found');
        } catch (error) { modalBody.innerHTML = this.buildErrorHTML('Error loading details'); console.error('Details load error:', error); }
    },
    buildDetailsHTML(data) {
        const attendee = data.attendee, application = data.application;
        let html = `<div class="space-y-6"><div class="bg-white border border-black/10 rounded-xl p-6"><h5 class="text-lg font-semibold text-[#1a2b4c] mb-4 flex items-center gap-2"><i class="bi bi-person-badge"></i> BASIC INFORMATION</h5><div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
        html += `<div><div class="text-xs font-mono text-gray-500 mb-1">FULL NAME</div><div class="font-medium text-[#1a2b4c] text-lg">${escapeHtml(attendee.name)}</div></div>`;
        html += `<div><div class="text-xs font-mono text-gray-500 mb-1">EMAIL</div><div class="font-medium text-[#1a2b4c] break-all">${escapeHtml(attendee.email)}</div></div>`;
        html += `<div><div class="text-xs font-mono text-gray-500 mb-1">PHONE NUMBER</div><div class="font-medium text-[#1a2b4c]">${attendee.phone_number || 'Not provided'}</div></div>`;
        html += `<div><div class="text-xs font-mono text-gray-500 mb-1">CHECKED IN AT</div><div class="font-medium text-[#1a2b4c]">${attendee.attended_at_display || 'N/A'}</div></div>`;
        html += `</div></div>`;
        if (application) html += this.buildApplicationHTML(application);
        else html += this.buildNoApplicationHTML();
        html += '</div>';
        return html;
    },
    buildApplicationHTML(application) {
        return `
            <div class="bg-white border border-black/10 rounded-xl p-6">
                <h5 class="text-lg font-semibold text-[#1a2b4c] mb-4 flex items-center gap-2"><i class="bi bi-file-earmark-text"></i> APPLICATION DETAILS</h5>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div><div class="text-xs font-mono text-gray-500 mb-1">APPLIED PROGRAMME</div><div class="font-medium">${this.getProgrammeBadge(application.applied_programme)}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">ATTENDED WITH</div><div class="font-medium">${this.getAttendedWithBadge(application.attended_with)}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">SPM CREDITS</div><div class="font-medium text-[#1a2b4c]">${application.spm_total_credit || '0'}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">REFERRAL NUMBER</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.registration_officer || 'N/A')}</div></div>
                </div>
            </div>
            <div class="bg-white border border-black/10 rounded-xl p-6">
                <h6 class="text-md font-semibold text-[#1a2b4c] mb-4">PERSONAL DETAILS</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><div class="text-xs font-mono text-gray-500 mb-1">FULL NAME (IC)</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.full_name || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">IC NUMBER</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.ic_no || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">EMAIL</div><div class="font-medium text-[#1a2b4c] break-all">${escapeHtml(application.email || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">PHONE NUMBER</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.phone_no || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">MARITAL STATUS</div><div class="font-medium">${this.getMaritalStatusBadge(application.marriage_status)}</div></div>
                </div>
            </div>
            <div class="bg-white border border-black/10 rounded-xl p-6">
                <h6 class="text-md font-semibold text-[#1a2b4c] mb-4">ADDRESS DETAILS</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><div class="text-xs font-mono text-gray-500 mb-1">ADDRESS</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.address1 || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">CITY</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.city || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">POSTCODE</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.postcode || 'N/A')}</div></div>
                    <div><div class="text-xs font-mono text-gray-500 mb-1">STATE</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.state || 'N/A')}</div></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white border border-black/10 rounded-xl p-6">
                    <h6 class="text-md font-semibold text-[#1a2b4c] mb-4">FATHER'S INFORMATION</h6>
                    <div class="space-y-4">
                        <div><div class="text-xs font-mono text-gray-500 mb-1">NAME</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.father_name || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">IC NUMBER</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.father_ic || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">PHONE</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.father_phone || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">OCCUPATION</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.father_occupation || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">INCOME (RM)</div><div class="font-medium text-[#1a2b4c]">${application.father_income || 'N/A'}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">DEPENDANTS</div><div class="font-medium text-[#1a2b4c]">${application.father_dependants || 'N/A'}</div></div>
                    </div>
                </div>
                <div class="bg-white border border-black/10 rounded-xl p-6">
                    <h6 class="text-md font-semibold text-[#1a2b4c] mb-4">MOTHER'S INFORMATION</h6>
                    <div class="space-y-4">
                        <div><div class="text-xs font-mono text-gray-500 mb-1">NAME</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.mother_name || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">IC NUMBER</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.mother_ic || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">PHONE</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.mother_phone || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">OCCUPATION</div><div class="font-medium text-[#1a2b4c]">${escapeHtml(application.mother_occupation || 'N/A')}</div></div>
                        <div><div class="text-xs font-mono text-gray-500 mb-1">INCOME (RM)</div><div class="font-medium text-[#1a2b4c]">${application.mother_income || 'N/A'}</div></div>
                    </div>
                </div>
            </div>
            <div class="bg-white border border-black/10 rounded-xl p-6">
                <h6 class="text-md font-semibold text-[#1a2b4c] mb-4">PROGRAMME INTEREST</h6>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-[#1a2b4c]/5 rounded-lg p-4"><div class="text-xs font-mono text-gray-500 mb-2">FIRST CHOICE</div><div class="text-[#1a2b4c]">${escapeHtml(application.interest_choice1 || 'Not specified')}</div></div>
                    <div class="bg-[#1a2b4c]/5 rounded-lg p-4"><div class="text-xs font-mono text-gray-500 mb-2">SECOND CHOICE</div><div class="text-[#1a2b4c]">${escapeHtml(application.interest_choice2 || 'Not specified')}</div></div>
                    <div class="bg-[#1a2b4c]/5 rounded-lg p-4"><div class="text-xs font-mono text-gray-500 mb-2">THIRD CHOICE</div><div class="text-[#1a2b4c]">${escapeHtml(application.interest_choice3 || 'Not specified')}</div></div>
                </div>
            </div>
        `;
    },
    buildNoApplicationHTML() {
        return `<div class="bg-yellow-50 border border-yellow-200 rounded-xl p-8 text-center"><i class="bi bi-file-earmark-x text-yellow-600 text-5xl mb-4"></i><h4 class="text-lg font-semibold text-yellow-800 mb-2">No Application Form</h4><p class="text-yellow-700">This attendee hasn't submitted an application form yet.</p><p class="text-yellow-600 text-sm mt-2">They may have checked in via QR code without filling the form.</p></div>`;
    },
    buildErrorHTML(message) { return `<div class="bg-red-50 border border-red-200 rounded-lg p-4"><div class="flex items-center gap-2 text-red-800 mb-2"><i class="bi bi-x-circle"></i><span class="font-medium">Error</span></div><p class="text-red-700">${message}</p></div>`; },
    getProgrammeBadge(programme) {
        const programmeMap = { 'Diploma': { class: 'bg-blue-100 text-blue-800', text: 'Diploma' }, 'DIPLOMA': { class: 'bg-blue-100 text-blue-800', text: 'Diploma' }, 'Pra-Diploma': { class: 'bg-green-100 text-green-800', text: 'Pra-Diploma' }, 'PRA_DIPLOMA': { class: 'bg-green-100 text-green-800', text: 'Pra-Diploma' }, 'TVET': { class: 'bg-yellow-100 text-yellow-800', text: 'TVET' }, 'Smart Tahfiz': { class: 'bg-purple-100 text-purple-800', text: 'Smart Tahfiz' }, 'SMART_TAHFIZ': { class: 'bg-purple-100 text-purple-800', text: 'Smart Tahfiz' } };
        const badge = programmeMap[programme] || { class: 'bg-gray-100 text-gray-800', text: programme || '—' };
        return `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium ${badge.class}">${badge.text}</span>`;
    },
    getAttendedWithBadge(attendedWith) {
        const attendedMap = { 'PARENT': { class: 'bg-blue-100 text-blue-800', text: 'Parent' }, 'GUARDIAN': { class: 'bg-gray-100 text-gray-800', text: 'Guardian' } };
        const badge = attendedMap[attendedWith] || { class: 'bg-gray-100 text-gray-800', text: attendedWith || '—' };
        return `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium ${badge.class}">${badge.text}</span>`;
    },
    getMaritalStatusBadge(status) {
        if (!status) return '<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">-</span>';
        const statusLower = status.toLowerCase();
        const statusMap = { 'single': 'bg-green-100 text-green-800', 'married': 'bg-yellow-100 text-yellow-800', 'divorced': 'bg-red-100 text-red-800', 'widowed': 'bg-purple-100 text-purple-800' };
        for (const [key, className] of Object.entries(statusMap)) { if (statusLower.includes(key)) return `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium ${className}">${status}</span>`; }
        return `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${status}</span>`;
    },
    togglePrintButton(show) { 
        const printBtn = document.getElementById('printAttendeeBtn'); 
        if (printBtn) {
            if (show) {
                printBtn.classList.remove('hidden');
                printBtn.style.display = 'inline-flex';
            } else {
                printBtn.classList.add('hidden');
                printBtn.style.display = 'none';
            }
        }
    }
};

// ============================================
// REGISTRATION FORM MANAGEMENT
// ============================================
const RegistrationForm = {
    async open(attendeeId) {
        state.currentAttendeeId = attendeeId;
        const attendeeIdField = document.getElementById('attendeeId');
        if (attendeeIdField) attendeeIdField.value = attendeeId;
        Modal.open('registrationModal', { 
            onOpen: () => { 
                this.resetForm(); 
                this.loadData(attendeeId); 
            } 
        });
    },
    close() { Modal.close('registrationModal'); },
    resetForm() {
        const form = document.getElementById('registrationForm');
        if (form) form.reset();
        const registerDateField = document.getElementById('register_date');
        const closerField = document.getElementById('closer');
        if (registerDateField) registerDateField.value = new Date().toISOString().split('T')[0];
        if (closerField) closerField.value = "{{ request.user.get_full_name|default:request.user.username }}";
        const alertDiv = document.getElementById('checkoutTimeAlert');
        if (alertDiv) alertDiv.style.display = 'none';
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) modalTitle.textContent = 'REGISTRATION FORM';
    },
    async loadData(attendeeId) {
        try {
            const [attendeeData, regData] = await Promise.all([ApiService.getAttendeeDetails(attendeeId), ApiService.getAttendeeRegistration(attendeeId)]);
            const combinedData = { ...attendeeData, registration: regData.registration };
            this.updatePreview(combinedData);
            if (regData.registration) this.setupUpdateMode(regData.registration);
            this.populateForm(regData.registration, attendeeData.application);
        } catch (error) { console.error('Load data error:', error); Toast.show('Error loading data', 'error'); }
    },
    updatePreview(data) {
        const { attendee, application, registration } = data;
        const previewFields = {
            'previewName': attendee?.name || 'Loading...',
            'previewEmail': attendee?.email || 'Loading...',
            'previewCheckInTime': attendee?.attended_at_display || 'Loading...'
        };
        Object.entries(previewFields).forEach(([id, value]) => { const element = document.getElementById(id); if (element) element.textContent = value; });
        const referralField = document.getElementById('referral_number');
        if (referralField && application?.registration_officer && !referralField.value) referralField.value = application.registration_officer;
    },
    setupUpdateMode(registration) {
        const modalTitle = document.getElementById('modalTitle');
        const alertDiv = document.getElementById('checkoutTimeAlert');
        const timeSpan = document.getElementById('lastUpdatedTime');
        if (modalTitle) modalTitle.textContent = 'UPDATE REGISTRATION';
        if (alertDiv) alertDiv.style.display = 'flex';
        if (timeSpan && registration.created_at) timeSpan.textContent = formatDateTime(registration.created_at, 'datetime');
    },
    populateForm(registration, application) {
        const fields = ['course', 'college', 'register_date', 'pre_registration_fee', 'registration_fee', 'payment_status', 'amount_paid', 'payment_type', 'closer', 'referral_number', 'remark'];
        fields.forEach(fieldName => {
            const element = document.getElementById(fieldName);
            if (!element) return;
            if (fieldName === 'referral_number') element.value = registration?.referral_number || application?.registration_officer || '';
            else if (fieldName === 'register_date') element.value = registration?.register_date || new Date().toISOString().split('T')[0];
            else if (fieldName === 'closer') element.value = registration?.closer || '';
            else if (fieldName === 'amount_paid' && registration?.amount_paid) element.value = parseFloat(registration.amount_paid).toFixed(2);
            else element.value = registration?.[fieldName] || '';
        });
        if (!registration?.amount_paid) this.updateAmountPaidField();
        this.updatePaymentSummary();
    },
    updateAmountPaidField() {
        const preFee = parseFloat($('#pre_registration_fee').value) || 0;
        const regFee = parseFloat($('#registration_fee').value) || 0;
        const total = preFee + regFee;
        const amountPaidInput = $('#amount_paid');
        if (amountPaidInput) amountPaidInput.value = total.toFixed(2);
        this.updatePaymentSummary();
    },
    updatePaymentSummary() {
        const preFee = parseFloat($('#pre_registration_fee').value) || 0;
        const regFee = parseFloat($('#registration_fee').value) || 0;
        const total = preFee + regFee;
        const amountPaid = parseFloat($('#amount_paid').value) || 0;
        const paymentStatus = $('#payment_status').value;
        const paymentPercentage = total > 0 ? (amountPaid / total) * 100 : 0;
        const balance = total - amountPaid;
        const updateElement = (id, value, className = '') => { const element = document.getElementById(id); if (element) { element.textContent = value; if (className) element.className = className; } };
        updateElement('totalFeeDisplay', formatCurrency(total));
        updateElement('displayAmountPaid', formatCurrency(amountPaid));
        let balanceClass = ''; let balanceText = formatCurrency(balance);
        if (balance > 0) { balanceClass = 'color: #b91c1c;'; } else if (balance < 0) { balanceClass = 'color: #166534;'; balanceText = `(${formatCurrency(Math.abs(balance))})`; }
        const balanceEl = document.getElementById('balanceDisplay');
        if (balanceEl) { balanceEl.textContent = balanceText; balanceEl.style.color = balance > 0 ? '#b91c1c' : balance < 0 ? '#166534' : '#1a2b4c'; }
        updateElement('paymentPercentage', `${paymentPercentage.toFixed(1)}%`);
        const progressBar = $('#paymentProgressBar');
        const progressLabel = $('#paymentProgressLabel');
        if (progressBar) {
            progressBar.style.width = `${Math.min(paymentPercentage, 100)}%`;
            progressBar.style.background = paymentStatus === 'DONE' ? 'linear-gradient(90deg, #166534, #22c55e)' : paymentStatus === 'PARTIAL' ? 'linear-gradient(90deg, #b45309, #f59e0b)' : 'linear-gradient(90deg, #1a2b4c, #2c3e5e)';
        }
        if (progressLabel) progressLabel.textContent = `${Math.min(paymentPercentage, 100).toFixed(0)}%`;
    },
    async save() {
        const form = document.getElementById('registrationForm');
        if (!form.checkValidity()) { form.reportValidity(); return; }
        const saveBtn = $('#saveRegistrationBtn'), btnText = $('#saveBtnText'), spinner = $('#saveSpinner');
        saveBtn.disabled = true; 
        if (spinner) spinner.style.display = 'inline-block';
        btnText.textContent = 'Saving...';
        try {
            const formData = new FormData(form);
            const data = await ApiService.saveRegistration(formData);
            if (data.success) {
                Toast.show('Registration saved successfully');
                AttendeeTable.updateRow(state.currentAttendeeId, data.registration);
                await this.updateStats();
                this.close();
            } else Toast.show(data.error || 'Failed to save registration', 'error');
        } catch (error) { console.error('Save error:', error); Toast.show('Error saving registration', 'error'); }
        finally { 
            saveBtn.disabled = false; 
            if (spinner) spinner.style.display = 'none';
            btnText.textContent = 'Save Registration'; 
        }
    },
    async updateStats() {
        try {
            const stats = await ApiService.getRegistrationStats();
            if (stats.success) {
                const updateStat = (id, value) => { const element = document.getElementById(id); if (element) element.textContent = value; };
                updateStat('totalRegistered', stats.total_registered);
                updateStat('totalPaid', stats.total_paid);
                updateStat('totalPartial', stats.total_partial);
                updateStat('totalRevenue', `RM ${stats.total_revenue}`);
            }
        } catch (error) { console.error('Stats update error:', error); }
    },
    initEventListeners() {
        $('#pre_registration_fee')?.addEventListener('input', () => this.updateAmountPaidField());
        $('#registration_fee')?.addEventListener('input', () => this.updateAmountPaidField());
        $('#amount_paid')?.addEventListener('input', () => this.updatePaymentSummary());
        $('#payment_status')?.addEventListener('change', () => this.updatePaymentSummary());
    }
};

// ============================================
// DELETE ATTENDEE MANAGEMENT
// ============================================
const DeleteManager = {
    showConfirmation(attendeeId, attendeeName) {
        state.attendeeToDelete = attendeeId;
        const nameElement = document.getElementById('deleteAttendeeName');
        if (nameElement) nameElement.textContent = `"${attendeeName}"`;
        Modal.open('deleteConfirmModal');
    },
    close() { Modal.close('deleteConfirmModal'); },
    async delete() {
        if (!state.attendeeToDelete) { Toast.show('No attendee selected', 'error'); return; }
        const deleteBtn = $('#confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...'; deleteBtn.disabled = true;
        try {
            const result = await ApiService.deleteAttendee(state.attendeeToDelete);
            if (result.success) {
                AttendeeTable.removeRow(state.attendeeToDelete);
                await RegistrationForm.updateStats();
                Toast.show('Attendee deleted successfully');
                this.close();
            } else Toast.show(result.error || 'Failed to delete', 'error');
        } catch (error) { console.error('Delete error:', error); Toast.show('Error deleting attendee', 'error'); }
        finally { deleteBtn.innerHTML = originalText; deleteBtn.disabled = false; state.attendeeToDelete = null; }
    }
};

// ============================================
// PRINT ATTENDEE FORM - EXACT SAMPLE VERSION
// ============================================

window.printAttendeeForm = async function() {
    if (!state.currentAttendeeData || !state.currentAttendeeData.application) {
        Toast.show('No application data available to print', 'error');
        return;
    }
    
    const app = state.currentAttendeeData.application;
    
    // Generate UNIQUE form number
    const formNumber = await generateUniqueFormNumber(app);
    
    console.log('Printing COMPLETE form with number:', formNumber);
    
    // Create COMPLETE printable form HTML using sample format
    const printHtml = createCompletePrintableFormHTML(app, formNumber);
    
    // Open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHtml);
    printWindow.document.close();
};

// Generate unique form number - from sample
async function generateUniqueFormNumber(application) {
    try {
        // Get event state code
        const eventStateCode = "{{ event.state }}" || 'KUALA_LUMPUR';
        
        // Convert to abbreviation
        let stateAbbr = 'KUL';
        const stateMap = {
            'KUALA_LUMPUR': 'KUL', 'SELANGOR': 'SEL', 'JOHOR': 'JHR', 'PENANG': 'PNG',
            'PERAK': 'PRK', 'SABAH': 'SBH', 'SARAWAK': 'SWK', 'PAHANG': 'PHG',
            'NEGERI_SEMBILAN': 'NSN', 'KEDAH': 'KDH', 'KELANTAN': 'KTN',
            'TERENGGANU': 'TRG', 'MELAKA': 'MLK', 'PERLIS': 'PLS', 'LABUAN': 'LBN',
            'PUTRAJAYA': 'PJY'
        };
        stateAbbr = stateMap[eventStateCode] || eventStateCode.substring(0, 3);
        
        // Get event month
        const eventMonth = "{{ event.date|date:'m' }}" || '01';
        
        // Generate unique sequence
        const now = new Date();
        const timestamp = now.getTime();
        const sequence = timestamp % 1000000;
        const sequenceStr = sequence.toString().slice(-4).padStart(4, '0');
        const random = Math.floor(Math.random() * 100);
        const finalSequence = (parseInt(sequenceStr) + random) % 10000;
        
        return `SES.${stateAbbr}.${eventMonth}.${finalSequence.toString().padStart(4, '0')}`;
        
    } catch (error) {
        console.error('Error generating form number:', error);
        const now = new Date();
        return `SES.${now.getTime().toString().slice(-8)}`;
    }
}

// CREATE COMPLETE PRINTABLE FORM HTML - EXACT SAMPLE FORMAT
function createCompletePrintableFormHTML(app, formNumber) {
    // Get current timestamp for printing
    const printTimestamp = new Date().toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    // Get attended with choices
    const attendedWithChoices = {
        'PARENT': app.attended_with === 'PARENT',
        'GUARDIAN': app.attended_with === 'GUARDIAN',
    };
    
    // Programme checkboxes
    const appliedProgramme = app.applied_programme ? app.applied_programme.trim() : '';
    const programmeCheckboxes = {
        'DIPLOMA': appliedProgramme === 'Diploma' || appliedProgramme === 'DIPLOMA',
        'PRA_DIPLOMA': appliedProgramme === 'Pra-Diploma' || appliedProgramme === 'PRA_DIPLOMA',
        'TVET': appliedProgramme === 'TVET',
        'SMART_TAHFIZ': appliedProgramme === 'Smart Tahfiz' || appliedProgramme === 'SMART_TAHFIZ'
    };
    
    console.log('Programme detection:', {
        original: app.applied_programme,
        trimmed: appliedProgramme,
        checks: programmeCheckboxes
    });
    
    return `
<!DOCTYPE html>
<html>
<head>
    <title>Application Form - ${escapeHtml(app.full_name)}</title>
    <style>
        /* PRINT STYLES - PROFESSIONAL GOVERNMENT THEME - MATCHING SAMPLE */
        * { 
            margin: 0 !important; 
            padding: 0 !important; 
            box-sizing: border-box !important; 
            font-family: "Calibri", "Arial", sans-serif !important; 
        }
        
        body { 
            background: white !important; 
            color: black !important; 
            width: 210mm !important; 
            height: 297mm !important; 
            margin: 0 auto !important; 
            padding: 10mm 15mm !important; 
            font-size: 10.5pt !important;
            line-height: 1.2 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        @page { 
            margin: 10mm 15mm 10mm 15mm !important; 
            size: A4 portrait; 
            
            /* Remove all headers and footers */
            @top-left { content: none !important; }
            @top-center { content: none !important; }
            @top-right { content: none !important; }
            @bottom-left { content: none !important; }
            @bottom-center { content: none !important; }
            @bottom-right { content: none !important; }
        }
        
        .print-form { 
            width: 100% !important;
            min-height: 277mm !important;
            max-height: 277mm !important;
            margin: 0 !important;
            padding: 0 !important;
            position: relative;
            page-break-inside: avoid !important;
            page-break-after: avoid !important;
            background: white !important;
            color: black !important;
            overflow: visible !important;
        }
        
        /* Watermark - Visible but not intrusive */
        .watermark {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.2;
            z-index: 0;
            pointer-events: none;
            text-align: center;
            width: 500px;
            height: 500px;
        }
        
        .watermark-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .print-form-content {
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Header - Matching Sample */
        .print-header { 
            text-align: center; 
            margin-bottom: 12px !important;
            padding: 10px 0 12px 0 !important; 
            border-bottom: 1px solid #000; 
            position: relative;
        }
        
        /* DUAL LOGO CONTAINER - Matching Sample */
        .logo-container {
            position: absolute;
            top: 0;
            left: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 55px;
        }
        
        .print-logo {
            height: 55px;
            width: auto;
        }
        
        /* Ensure logos don't overlap with text */
        .print-header-content {
            position: relative;
            z-index: 1;
            padding-left: 140px;
            padding-right: 10px;
        }
        
        /* FORM NUMBER AND PRINT TIMESTAMP */
        .form-meta-container {
            position: absolute;
            top: 0;
            right: 0;
            text-align: right;
            font-size: 8.5pt !important; 
            color: #666;
            margin-bottom: 3px !important;
        }
        
        .form-number { 
            font-weight: bold;
            color: #333;
        }
        
        .print-timestamp {
            font-size: 8pt !important;
            color: #000;
            margin-top: 1px !important;
        }
        
        .print-title { 
            font-size: 16pt !important; 
            font-weight: bold; 
            color: #000; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 2px 0 !important;
            line-height: 1.1;
        }
        
        .print-subtitle { 
            font-size: 13pt !important; 
            font-weight: bold; 
            color: #000; 
            margin-bottom: 0 !important;
            line-height: 1.1;
        }
        
        /* Main Content - Compact but readable */
        .form-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px !important;
            margin-bottom: 3mm !important;
        }
        
        /* Section Styling */
        .section {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            margin-bottom: 2px !important;
            width: 100%;
        }
        
        .section-title {
            font-weight: bold;
            font-size: 11pt !important;
            margin-bottom: 6px !important;
            padding: 4px 0 !important;
            border-bottom: 1px solid #000;
            line-height: 1.1;
            width: 100%;
            background: transparent !important;
            padding-left: 5px !important;
            color: #000;
        }
        
        /* Field rows - Compact */
        .field-row { 
            display: flex; 
            align-items: flex-start;
            margin-bottom: 5px !important; 
            min-height: 18px !important;
            line-height: 1.2;
            width: 100%; 
        }
        
        /* STANDARDIZED LABEL WIDTH for all fields (160px) */
        .field-label-dual {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-weight: bold; 
            font-size: 10pt !important; 
            width: 160px !important; 
            min-width: 160px !important; 
            max-width: 160px !important; 
            padding-right: 8px !important; 
            flex-shrink: 0; 
            color: #000;
            line-height: 1.1;
            margin-top: 2px !important;
        }
        
        .field-label-malay {
            font-weight: bold;
            font-size: 9.5pt !important;
            color: #000;
        }
        
        .field-label-english {
            font-weight: normal;
            font-size: 9pt !important;
            color: #444;
            font-style: italic;
        }
        
        .field-value { 
            font-size: 10pt !important; 
            flex: 1; 
            min-height: 18px !important; 
            line-height: 1.2;
            word-break: break-word;
            border-bottom: 0.7px solid #999;
            padding-bottom: 2px !important;
            color: #000;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 2px !important;
        }
        
        /* Two-column grid for Referral Number and SPM Credit side by side */
        .referral-spm-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px !important;
            margin-bottom: 6px !important;
        }
        
        .referral-spm-item {
            display: flex;
            align-items: flex-start;
        }
        
        /* Referral Number gets 160px label */
        .referral-label {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-weight: bold; 
            font-size: 10pt !important; 
            width: 160px !important; 
            min-width: 160px !important; 
            max-width: 160px !important; 
            padding-right: 8px !important; 
            flex-shrink: 0; 
            color: #000;
            line-height: 1.1;
            margin-top: 2px !important;
        }
        
        /* SPM Credit gets narrower label since it's on the right side */
        .spm-label {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-weight: bold; 
            font-size: 10pt !important; 
            width: 140px !important; 
            min-width: 140px !important; 
            max-width: 140px !important; 
            padding-right: 8px !important; 
            flex-shrink: 0; 
            color: #000;
            line-height: 1.1;
            margin-top: 2px !important;
        }
        
        .referral-spm-value {
            flex: 1;
            min-height: 18px !important;
            line-height: 1.2;
            word-break: break-word;
            border-bottom: 0.7px solid #999;
            padding-bottom: 2px !important;
            color: #000;
            margin-top: 2px !important;
        }
        
        /* Applied Programme and Attended With - Aligned with Referral Number */
        .applied-programme-section {
            margin-bottom: 8px !important;
            margin-top: 6px !important;
            width: 100%;
        }
        
        .applied-programme-line {
            display: flex;
            align-items: flex-start;
            gap: 10px !important;
            margin-bottom: 5px !important;
        }
        
        .programme-label-dual {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-weight: bold;
            font-size: 10pt !important;
            color: #000;
            margin-right: 6px !important;
            white-space: nowrap;
            line-height: 1.1;
            padding-top: 2px !important;
            width: 160px !important;
            min-width: 160px !important;
            max-width: 160px !important;
        }
        
        .programme-label-malay {
            font-weight: bold;
            font-size: 9.5pt !important;
            color: #000;
        }
        
        .programme-label-english {
            font-weight: normal;
            font-size: 9pt !important;
            color: #444;
            font-style: italic;
        }
        
        .programme-options-inline {
            display: flex;
            gap: 15px !important;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 2px !important;
        }
        
        .programme-option-inline {
            display: flex;
            align-items: center;
            gap: 4px !important;
            font-size: 10pt !important;
            line-height: 1.1;
            cursor: default;
        }
        
        .tickbox-inline {
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8pt !important;
            flex-shrink: 0;
            margin-top: 2px !important;
        }
        
        .tickbox-inline.checked::after {
            content: "✓";
            font-weight: bold;
        }
        
        .programme-text-inline {
            font-size: 10pt !important;
            color: #000;
            line-height: 1.1;
        }
        
        /* Attended With Section */
        .attended-with-section {
            margin-bottom: 8px !important;
            width: 100%;
        }
        
        .attended-with-line {
            display: flex;
            align-items: flex-start;
            gap: 10px !important;
            margin-bottom: 5px !important;
        }
        
        .attended-with-label-dual {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-weight: bold;
            font-size: 10pt !important;
            color: #000;
            margin-right: 6px !important;
            white-space: nowrap;
            line-height: 1.1;
            padding-top: 2px !important;
            width: 160px !important;
            min-width: 160px !important;
            max-width: 160px !important;
        }
        
        .attended-with-label-malay {
            font-weight: bold;
            font-size: 9.5pt !important;
            color: #000;
        }
        
        .attended-with-label-english {
            font-weight: normal;
            font-size: 9pt !important;
            color: #444;
            font-style: italic;
        }
        
        .attended-with-options-inline {
            display: flex;
            gap: 15px !important;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 2px !important;
        }
        
        .attended-with-option-inline {
            display: flex;
            align-items: center;
            gap: 4px !important;
            font-size: 10pt !important;
            line-height: 1.1;
            cursor: default;
        }
        
        /* Address section with Address, Postcode, City, State in 2x2 grid */
        .address-grid-2x2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px 10px !important;
            margin-bottom: 5px !important;
        }
        
        .address-item {
            display: flex;
            align-items: flex-start;
        }
        
        .address-label {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-weight: bold; 
            font-size: 10pt !important; 
            width: 100px !important; 
            min-width: 100px !important; 
            max-width: 100px !important; 
            padding-right: 6px !important; 
            flex-shrink: 0; 
            color: #000;
            line-height: 1.1;
            margin-top: 2px !important;
        }
        
        .address-value {
            flex: 1;
            min-height: 18px !important;
            line-height: 1.2;
            word-break: break-word;
            border-bottom: 0.7px solid #999;
            padding-bottom: 2px !important;
            color: #000;
            margin-top: 2px !important;
        }
        
        /* Grid layouts */
        .grid-2col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px !important;
            margin-bottom: 6px !important;
            width: 100%;
        }
        
        .grid-3col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px !important;
            margin-bottom: 6px !important;
            width: 100%;
        }
        
        /* Interest Boxes Grid */
        .interest-grid-3col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px !important;
            margin-top: 6px !important;
            margin-bottom: 10px !important;
            width: 100%;
        }
        
        .interest-box {
            width: 100%;
            min-height: 60px !important;
            max-height: 60px !important;
            padding: 4px 6px !important;
            font-size: 10pt !important;
            line-height: 1.1;
            word-break: break-word;
            background: transparent !important;
            border: 0.7px solid #bbb;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .interest-box-title {
            font-size: 9pt !important;
            font-weight: bold;
            margin-bottom: 3px !important;
            color: #000;
            text-align: center;
            padding: 1px 0 !important;
            border-bottom: 0.7px solid #aaa;
        }
        
        .interest-content {
            font-size: 10pt !important;
            line-height: 1.1;
            word-break: break-word;
            height: 40px;
            overflow: hidden;
        }
        
        /* Declaration Section */
        .declaration {
            margin-top: -12px !important;
            padding-top: 4px !important;
            border-top: 1px solid #000;
            width: 100%;
        }
        
        .declaration-title {
            font-size: 11pt !important;
            font-weight: bold;
            margin-bottom: 6px !important;
            text-align: center;
            line-height: 1.1;
        }
        
        .declaration-dual {
            margin-bottom: 8px !important;
        }
        
        .declaration-malay {
            margin-bottom: 4px !important;
            text-align: justify;
            font-size: 9pt !important;
            line-height: 1.3;
        }
        
        .declaration-english {
            margin-bottom: 8px !important;
            text-align: justify;
            font-style: italic;
            font-size: 9pt !important;
            line-height: 1.3;
        }
        
        /* Signature Area */
        .signature-area {
            margin-top: 10px !important;
            width: 100%;
        }
        
        .signature-box {
            display: flex;
            justify-content: space-between;
            margin-top: 8px !important;
            width: 100%;
        }
        
        .signature-item {
            width: 48%;
            text-align: center;
        }
        
        .signature-line {
            width: 180px !important;
            height: 40px !important;
            margin: 4px auto 4px auto !important;
            font-weight: bold;
            font-size: 10pt !important;
            line-height: 1.1;
            border-bottom: 1px solid #000;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .signature-label {
            font-size: 9pt !important;
            margin-top: 2px !important;
            color: #000;
            line-height: 1.1;
            min-height: 11px !important;
        }
        
        .signature-label-malay {
            font-weight: bold;
            font-size: 9pt !important;
        }
        
        .signature-label-english {
            font-size: 8.5pt !important;
            color: #444;
            font-style: italic;
        }
        
        .signature-name {
            font-size: 9pt !important;
            margin-top: 2px !important;
            color: #000;
            line-height: 1.1;
            min-height: 11px !important;
        }
        
        .signature-date {
            font-size: 9pt !important;
            text-align: center;
            margin-top: 2px !important;
            color: #000;
            line-height: 1.1;
            min-height: 11px !important;
        }
        
        /* Footer - Office Use Only */
        .form-footer {
            margin-top: 10px !important;
            padding-top: 5px !important;
            border-top: 0.7px solid #666;
            font-size: 9pt !important;
            color: #444;
            line-height: 1;
            width: 99%;
        }
        
        .office-use-section {
            margin-top: 4px !important;
            padding: 4px 6px !important;
            border: 0.7px solid #666;
            min-height: 45px !important;
            font-size: 9pt !important;
            background: transparent !important;
        }
        
        /* Hide browser print headers and footers */
        @media print { 
            @page { 
                margin: 10mm 15mm 10mm 15mm !important; 
                size: A4 portrait;
            } 
            
            body { 
                width: 210mm !important;
                height: 297mm !important;
                margin: 0 !important;
                padding: 10mm 15mm !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            } 
            
            .print-form {
                width: 100% !important;
                min-height: 277mm !important;
                max-height: 277mm !important;
                margin: 0 !important;
                padding: 0 !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            /* Force single page */
            .break-before {
                page-break-before: avoid !important;
            }
            
            .break-after {
                page-break-after: avoid !important;
            }
            
            .break-inside {
                page-break-inside: avoid !important;
            }
            
            /* Hide browser-generated headers/footers */
            header, footer {
                display: none !important;
            }
            
            /* Watermark visibility in print */
            .watermark {
                opacity: 0.2;
            }
        }
    </style>
</head>
<body>
    <div class="print-form">
        <!-- Watermark -->
        <div class="watermark">
            <img src="${CONFIG.LOGO_URL1}" class="watermark-image" alt="SES Watermark" onerror="this.style.display='none'">
        </div>
        
        <div class="print-form-content">
            <!-- Header -->
            <div class="print-header">
                <!-- DUAL LOGOS -->
                <div class="logo-container">
                    <img src="${CONFIG.LOGO_URL}" class="print-logo" alt="SES Logo" onerror="this.style.display='none'">
                    <img src="${CONFIG.UPKB_LOGO_URL}" class="print-logo" alt="UPKB Logo" onerror="this.style.display='none'">
                </div>
                
                <!-- Form Number and Print Timestamp -->
                <div class="form-meta-container">
                    <div class="form-number">${formNumber}</div>
                    <div class="print-timestamp">Printed: ${printTimestamp}</div>
                </div>
                
                <!-- Header Content -->
                <div class="print-header-content">
                    <div class="print-title">BORANG PERMOHONAN & TEMUDUGA</div>
                    <div class="print-subtitle">APPLICATION & INTERVIEW FORM</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="form-content">
                <!-- Section 1: Applicant Information -->
                <div class="section">
                    <div class="section-title">1. MAKLUMAT PEMOHON / APPLICANT INFORMATION</div>
                    
                    <!-- Referral Number and SPM Credit side by side -->
                    <div class="referral-spm-grid">
                        <!-- Referral Number (left side) -->
                        <div class="referral-spm-item">
                            <div class="referral-label">
                                <span class="field-label-malay">Nombor Rujukan</span>
                                <span class="field-label-english">Referral Number</span>
                            </div>
                            <div class="referral-spm-value">${toUpperCase(escapeHtml(app.registration_officer || 'N/A'))}</div>
                        </div>
                        
                        <!-- SPM Credit (right side) -->
                        <div class="referral-spm-item">
                            <div class="spm-label">
                                <span class="field-label-malay">Kredit SPM</span>
                                <span class="field-label-english">SPM Total Credit</span>
                            </div>
                            <div class="referral-spm-value">${app.spm_total_credit || '0'}</div>
                        </div>
                    </div>
                    
                    <!-- APPLIED PROGRAMME - Aligned with Referral Number -->
                    <div class="applied-programme-section">
                        <div class="applied-programme-line">
                            <div class="programme-label-dual">
                                <span class="programme-label-malay">Program Dipilih</span>
                                <span class="programme-label-english">Applied Programme</span>
                            </div>
                            <div class="programme-options-inline">
                                <div class="programme-option-inline">
                                    <div class="tickbox-inline ${programmeCheckboxes.DIPLOMA ? 'checked' : ''}"></div>
                                    <span class="programme-text-inline">Diploma</span>
                                </div>
                                <div class="programme-option-inline">
                                    <div class="tickbox-inline ${programmeCheckboxes.PRA_DIPLOMA ? 'checked' : ''}"></div>
                                    <span class="programme-text-inline">Pra-Diploma</span>
                                </div>
                                <div class="programme-option-inline">
                                    <div class="tickbox-inline ${programmeCheckboxes.TVET ? 'checked' : ''}"></div>
                                    <span class="programme-text-inline">TVET</span>
                                </div>
                                <div class="programme-option-inline">
                                    <div class="tickbox-inline ${programmeCheckboxes.SMART_TAHFIZ ? 'checked' : ''}"></div>
                                    <span class="programme-text-inline">Smart Tahfiz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ATTENDED WITH - Aligned with Referral Number -->
                    <div class="attended-with-section">
                        <div class="attended-with-line">
                            <div class="attended-with-label-dual">
                                <span class="attended-with-label-malay">Hadir Bersama</span>
                                <span class="attended-with-label-english">Attended With</span>
                            </div>
                            <div class="attended-with-options-inline">
                                <div class="attended-with-option-inline">
                                    <div class="tickbox-inline ${attendedWithChoices.PARENT ? 'checked' : ''}"></div>
                                    <span class="programme-text-inline">Ibu Bapa / Parent(s)</span>
                                </div>
                                <div class="attended-with-option-inline">
                                    <div class="tickbox-inline ${attendedWithChoices.GUARDIAN ? 'checked' : ''}"></div>
                                    <span class="programme-text-inline">Penjaga / Guardian</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Personal Details -->
                <div class="section">
                    <div class="section-title">2. MAKLUMAT PERIBADI / PERSONAL DETAILS</div>
                    
                    <!-- Full Name -->
                    <div class="field-row">
                        <div class="field-label-dual">
                            <span class="field-label-malay">Nama Penuh (IC)</span>
                            <span class="field-label-english">Full Name (as per IC)</span>
                        </div>
                        <div class="field-value">${toUpperCase(escapeHtml(app.full_name || 'N/A'))}</div>
                    </div>
                    
                    <div class="grid-2col">
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">No. Kad Pengenalan</span>
                                <span class="field-label-english">IC Number</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.ic_no || 'N/A'))}</div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">Status Perkahwinan</span>
                                <span class="field-label-english">Marital Status</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.marriage_status || 'N/A'))}</div>
                        </div>
                    </div>
                    
                    <div class="grid-2col">
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">Emel</span>
                                <span class="field-label-english">Email</span>
                            </div>
                            <div class="field-value">${escapeHtml(app.email || 'N/A')}</div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">No. Telefon</span>
                                <span class="field-label-english">Phone Number</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.phone_no || 'N/A'))}</div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Address Details -->
                <div class="section">
                    <div class="section-title">3. MAKLUMAT ALAMAT / ADDRESS DETAILS</div>
                    
                    <!-- Address, Postcode, City, State in 2x2 grid -->
                    <div class="address-grid-2x2">
                        <!-- Address -->
                        <div class="address-item">
                            <div class="address-label">
                                <span class="field-label-malay">Alamat</span>
                                <span class="field-label-english">Address</span>
                            </div>
                            <div class="address-value">${toUpperCase(escapeHtml(app.address1 || 'N/A'))}</div>
                        </div>
                        
                        <!-- Postcode -->
                        <div class="address-item">
                            <div class="address-label">
                                <span class="field-label-malay">Poskod</span>
                                <span class="field-label-english">Postcode</span>
                            </div>
                            <div class="address-value">${toUpperCase(escapeHtml(app.postcode || 'N/A'))}</div>
                        </div>
                        
                        <!-- City -->
                        <div class="address-item">
                            <div class="address-label">
                                <span class="field-label-malay">Bandar</span>
                                <span class="field-label-english">City</span>
                            </div>
                            <div class="address-value">${toUpperCase(escapeHtml(app.city || 'N/A'))}</div>
                        </div>
                        
                        <!-- State -->
                        <div class="address-item">
                            <div class="address-label">
                                <span class="field-label-malay">Negeri</span>
                                <span class="field-label-english">State</span>
                            </div>
                            <div class="address-value">${toUpperCase(escapeHtml(app.state || 'N/A'))}</div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Father's Information -->
                <div class="section">
                    <div class="section-title">4. MAKLUMAT BAPA / FATHER'S INFORMATION</div>
                    
                    <div class="field-row">
                        <div class="field-label-dual">
                            <span class="field-label-malay">Nama Penuh</span>
                            <span class="field-label-english">Full Name</span>
                        </div>
                        <div class="field-value">${toUpperCase(escapeHtml(app.father_name || 'N/A'))}</div>
                    </div>
                    
                    <div class="grid-2col">
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">No. Kad Pengenalan</span>
                                <span class="field-label-english">IC Number</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.father_ic || 'N/A'))}</div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">No. Telefon</span>
                                <span class="field-label-english">Phone Number</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.father_phone || 'N/A'))}</div>
                        </div>
                    </div>
                    
                    <!-- OCCUPATION + INCOME -->
                    <div class="grid-2col">
                        ${app.father_occupation ? `
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">Pekerjaan</span>
                                <span class="field-label-english">Occupation</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.father_occupation))}</div>
                        </div>
                        ` : '<div></div>'}
                        
                        ${app.father_income ? `
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">Pendapatan (RM)</span>
                                <span class="field-label-english">Income (RM)</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.father_income))}</div>
                        </div>
                        ` : '<div></div>'}
                    </div>
                    
                    <!-- DEPENDANTS -->
                    ${app.father_dependants ? `
                    <div class="field-row">
                        <div class="field-label-dual">
                            <span class="field-label-malay">Bil. Tanggungan</span>
                            <span class="field-label-english">No. of Dependants</span>
                        </div>
                        <div class="field-value">${toUpperCase(escapeHtml(app.father_dependants))}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Section 5: Mother's Information -->
                <div class="section">
                    <div class="section-title">5. MAKLUMAT IBU / MOTHER'S INFORMATION</div>
                    
                    <div class="field-row">
                        <div class="field-label-dual">
                            <span class="field-label-malay">Nama Penuh</span>
                            <span class="field-label-english">Full Name</span>
                        </div>
                        <div class="field-value">${toUpperCase(escapeHtml(app.mother_name || 'N/A'))}</div>
                    </div>
                    
                    <div class="grid-2col">
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">No. Kad Pengenalan</span>
                                <span class="field-label-english">IC Number</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.mother_ic || 'N/A'))}</div>
                        </div>
                        
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">No. Telefon</span>
                                <span class="field-label-english">Phone Number</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.mother_phone || 'N/A'))}</div>
                        </div>
                    </div>
                    
                    <!-- OCCUPATION + INCOME -->
                    <div class="grid-2col">
                        ${app.mother_occupation ? `
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">Pekerjaan</span>
                                <span class="field-label-english">Occupation</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.mother_occupation))}</div>
                        </div>
                        ` : '<div></div>'}
                        
                        ${app.mother_income ? `
                        <div class="field-row">
                            <div class="field-label-dual">
                                <span class="field-label-malay">Pendapatan (RM)</span>
                                <span class="field-label-english">Income (RM)</span>
                            </div>
                            <div class="field-value">${toUpperCase(escapeHtml(app.mother_income))}</div>
                        </div>
                        ` : '<div></div>'}
                    </div>
                    
                    <!-- DEPENDANTS -->
                    ${app.mother_dependants ? `
                    <div class="field-row">
                        <div class="field-label-dual">
                            <span class="field-label-malay">Bil. Tanggungan</span>
                            <span class="field-label-english">No. of Dependants</span>
                        </div>
                        <div class="field-value">${toUpperCase(escapeHtml(app.mother_dependants))}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Section 6: Programme Interest - 3 separate boxes -->
                <div class="section">
                    <div class="section-title">6. PROGRAM YANG DIMINATI / PROGRAMME INTEREST</div>
                    
                    <div class="interest-grid-3col">
                        <!-- First Choice -->
                        <div class="interest-box">
                            <div class="interest-box-title">Pilihan Pertama / First Choice</div>
                            <div class="interest-content">${app.interest_choice1 ? toUpperCase(escapeHtml(app.interest_choice1)) : ''}</div>
                        </div>
                        
                        <!-- Second Choice -->
                        <div class="interest-box">
                            <div class="interest-box-title">Pilihan Kedua / Second Choice</div>
                            <div class="interest-content">${app.interest_choice2 ? toUpperCase(escapeHtml(app.interest_choice2)) : ''}</div>
                        </div>
                        
                        <!-- Third Choice -->
                        <div class="interest-box">
                            <div class="interest-box-title">Pilihan Ketiga / Third Choice</div>
                            <div class="interest-content">${app.interest_choice3 ? toUpperCase(escapeHtml(app.interest_choice3)) : ''}</div>
                        </div>
                    </div>
                </div>

                <!-- Section 7: Declaration -->
                <div class="declaration">
                    <div class="declaration-title">PENGAKUAN DAN TANDATANGAN / DECLARATION & SIGNATURE</div>
                    
                    <div class="declaration-dual">
                        <div class="declaration-malay">
                            Saya dengan ini mengaku bahawa semua maklumat yang diberikan dalam borang permohonan ini adalah benar, lengkap, dan tepat mengikut pengetahuan saya.
                        </div>
                        
                        <div class="declaration-english">
                            I hereby declare that all information given in this application form is true, complete, and accurate to the best of my knowledge.
                        </div>
                    </div>

                    <div class="signature-area">
                        <div class="signature-box">
                            <div class="signature-item">
                                <div class="signature-line"></div>
                                <div class="signature-label">
                                    <div class="signature-label-malay">Tandatangan Pemohon</div>
                                </div>
                                <div class="signature-name">
                                    Nama / Name: <span style="font-weight: bold;">${toUpperCase(escapeHtml(app.full_name || 'N/A'))}</span><br>
                                    Tarikh / Date: <span style="font-weight: bold;">${new Date().toLocaleDateString('en-GB')}</span>
                                </div>
                            </div>
                            
                            <div class="signature-item">
                                <div class="signature-line"></div>
                                <div class="signature-label">
                                    <div class="signature-label-malay">Tandatangan Pegawai Temuduga</div>
                                </div>
                                <div class="signature-date">
                                    Nama / Name: <br>
                                    Tarikh / Date: <span style="font-weight: bold;">${new Date().toLocaleDateString('en-GB')}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Footer - OFFICE USE ONLY -->
                <div class="form-footer">
                    <div class="office-use-section">
                        <strong>UNTUK KEGUNAAN PEJABAT SAHAJA / FOR OFFICE USE ONLY</strong><br>

                        <!-- ACCEPT/REJECT TICKBOXES -->
                        <div style="margin: 6px 0 4px 0; padding-bottom: 4px; border-bottom: 0.7px solid #ccc;">
                            <div style="display: flex; gap: 25px; margin-left: 5px;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div class="tickbox-inline" style="border: 1.5px solid #000; width: 11px; height: 11px; border-radius: 2px;"></div>
                                    <span style="font-size: 9.5pt;">DITERIMA / ACCEPTED</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div class="tickbox-inline" style="border: 1.5px solid #000; width: 11px; height: 11px; border-radius: 2px;"></div>
                                    <span style="font-size: 9.5pt;">DITOLAK / REJECTED</span>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: -2px;">
                            <br>
                        </div>
                        <div style="margin-top: -2px;">
                            Catatan / Remarks: _____________________________________________________________________________________________________________
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Remove all browser headers and footers
        const style = document.createElement('style');
        style.innerHTML = \`
            @page {
                margin: 10mm 15mm 10mm 15mm !important;
                size: A4 portrait;
                
                @top-left { content: none !important; }
                @top-center { content: none !important; }
                @top-right { content: none !important; }
                @bottom-left { content: none !important; }
                @bottom-center { content: none !important; }
                @bottom-right { content: none !important; }
            }
            
            @media print {
                body {
                    margin: 0 !important;
                    padding: 0 !important;
                }
                
                /* Hide any browser-generated headers/footers */
                header, footer {
                    display: none !important;
                }
            }
        \`;
        document.head.appendChild(style);
        
        window.onload = function() {
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    if (window.opener) window.close();
                }, 500);
            }, 100);
        };
    <\/script>
</body>
</html>
    `;
}

// ============================================
// STATISTICS MANAGEMENT - WITH CHART RENDERING
// ============================================
const StatisticsManager = {
    charts: {},
    
    async showAllStats() {
        Modal.open('statsModal', {
            onOpen: async () => {
                try {
                    // Show loading state
                    this.showChartLoading();
                    
                    const data = await ApiService.getFullRegistrationStats();
                    if (data.success) {
                        this.updateStatsDisplay(data.basic_stats);
                        this.updatePaymentBreakdown(data.basic_stats);
                        this.renderAllCharts(data); // RENDER ALL CHARTS
                    } else {
                        this.resetStatsDisplay();
                        this.showNoDataMessage();
                    }
                } catch (error) {
                    console.error('Stats load error:', error);
                    this.resetStatsDisplay();
                    this.showErrorMessage();
                }
            }
        });
    },
    
    showChartLoading() {
        const chartContainers = [
            'topClosersChart',
            'topCoursesChart',
            'timelineChart',
            'paymentTypesChart',
            'paymentStatusChart'
        ];
        
        chartContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">
                    <div class="w-8 h-8 border-4 border-[#1a2b4c] border-t-transparent rounded-full animate-spin mr-3"></div>
                    <span>Loading chart data...</span>
                </div>`;
            }
        });
    },
    
    showNoDataMessage() {
        const chartContainers = [
            'topClosersChart',
            'topCoursesChart',
            'timelineChart',
            'paymentTypesChart',
            'paymentStatusChart'
        ];
        
        chartContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400">
                    <i class="bi bi-bar-chart text-5xl mb-3"></i>
                    <span>No data available</span>
                </div>`;
            }
        });
    },
    
    showErrorMessage() {
        const chartContainers = [
            'topClosersChart',
            'topCoursesChart',
            'timelineChart',
            'paymentTypesChart',
            'paymentStatusChart'
        ];
        
        chartContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-red-500">
                    <i class="bi bi-exclamation-triangle text-5xl mb-3"></i>
                    <span>Error loading chart data</span>
                </div>`;
            }
        });
    },
    
    renderAllCharts(data) {
        // Destroy existing charts if they exist
        Object.keys(this.charts).forEach(key => {
            if (this.charts[key] && typeof this.charts[key].destroy === 'function') {
                this.charts[key].destroy();
            }
        });
        this.charts = {};
        
        // Wait for Chart.js to be available
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded');
            this.loadChartJSLibrary().then(() => {
                this.renderChartsInternal(data);
            }).catch(() => {
                this.renderFallbackCharts(data);
            });
        } else {
            this.renderChartsInternal(data);
        }
    },
    
    loadChartJSLibrary() {
        return new Promise((resolve, reject) => {
            if (typeof Chart !== 'undefined') {
                resolve();
                return;
            }
            
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    },
    
    renderChartsInternal(data) {
        // Extract chart data
        const { charts = {} } = data;
        const { 
            top_closers = [], 
            top_courses = [], 
            timeline = [],
            payment_types = [],
            payment_statuses = []
        } = charts;
        
        // Render Top Closers Chart
        if (top_closers.length > 0) {
            this.renderTopClosersChart(top_closers);
            this.renderTopClosersList(top_closers);
        }
        
        // Render Top Courses Chart
        if (top_courses.length > 0) {
            this.renderTopCoursesChart(top_courses);
            this.renderTopCoursesList(top_courses);
        }
        
        // Render Payment Types Chart
        if (payment_types.length > 0) {
            this.renderPaymentTypesChart(payment_types);
        }
        
        // Render Payment Status Chart
        if (payment_statuses.length > 0) {
            this.renderPaymentStatusChart(payment_statuses);
        }
    },
    
    renderFallbackCharts(data) {
        // Fallback to simple HTML lists if Chart.js fails to load
        const { charts = {} } = data;
        const { 
            top_closers = [], 
            top_courses = [], 
            timeline = [],
            payment_types = [],
            payment_statuses = []
        } = charts;
        
        if (top_closers.length > 0) {
            this.renderTopClosersList(top_closers);
        }
        
        if (top_courses.length > 0) {
            this.renderTopCoursesList(top_courses);
        }
        
        if (payment_types.length > 0) {
            this.renderPaymentTypesList(payment_types);
        }
        
        if (payment_statuses.length > 0) {
            this.renderPaymentStatusList(payment_statuses);
        }
    },
    
    renderTopClosersChart(closers) {
        const ctx = document.getElementById('topClosersChart');
        if (!ctx) return;
        
        ctx.innerHTML = '<canvas id="topClosersCanvas" class="w-full h-full"></canvas>';
        const canvas = document.getElementById('topClosersCanvas');
        
        const labels = closers.map(c => {
            let label = c.label || 'Unknown';
            return label.length > 15 ? label.substring(0, 12) + '...' : label;
        });
        
        const attendeeCounts = closers.map(c => c.value || 0);
        const revenueAmounts = closers.map(c => (c.total_amount || 0).toFixed(0));
        
        this.charts.topClosers = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Registrations',
                        data: attendeeCounts,
                        backgroundColor: 'rgba(26, 43, 76, 0.8)',
                        borderColor: 'rgba(26, 43, 76, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                const index = context[0].dataIndex;
                                const closer = closers[index];
                                return [
                                    `Revenue: RM ${(closer.total_amount || 0).toFixed(2)}`,
                                    `Completed: ${closer.completed || 0}`,
                                    `Partial: ${closer.partial || 0}`,
                                    `Pending: ${closer.pending || 0}`
                                ];
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(26, 43, 76, 0.05)'
                        }
                    }
                }
            }
        });
    },
    
    renderTopCoursesChart(courses) {
        const ctx = document.getElementById('topCoursesChart');
        if (!ctx) return;
        
        ctx.innerHTML = '<canvas id="topCoursesCanvas" class="w-full h-full"></canvas>';
        const canvas = document.getElementById('topCoursesCanvas');
        
        const labels = courses.map(c => {
            let label = c.label || 'Unknown';
            return label.length > 20 ? label.substring(0, 17) + '...' : label;
        });
        
        const counts = courses.map(c => c.value || 0);
        
        this.charts.topCourses = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        'rgba(26, 43, 76, 0.8)',
                        'rgba(60, 60, 60, 0.8)',
                        'rgba(100, 100, 100, 0.8)',
                        'rgba(140, 140, 140, 0.8)',
                        'rgba(180, 180, 180, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterBody: function(context) {
                                const index = context[0].dataIndex;
                                const course = courses[index];
                                return [
                                    `Revenue: RM ${(course.total_amount || 0).toFixed(2)}`,
                                    `Pre-Reg: RM ${(course.pre_reg_amount || 0).toFixed(2)}`,
                                    `Reg Fee: RM ${(course.reg_amount || 0).toFixed(2)}`
                                ];
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    }
                }
            }
        });
    },
    
    renderPaymentTypesChart(paymentTypes) {
        const ctx = document.getElementById('paymentTypesChart');
        if (!ctx) return;
        
        ctx.innerHTML = '<canvas id="paymentTypesCanvas" class="w-full h-full"></canvas>';
        const canvas = document.getElementById('paymentTypesCanvas');
        
        const labels = paymentTypes.map(pt => {
            const type = pt.type || 'NONE';
            if (type === 'CASH') return 'Cash';
            if (type === 'ONLINE_BANKING') return 'Online Banking';
            if (type === 'QR_PAYMENT') return 'QR Payment';
            return type;
        });
        
        const counts = paymentTypes.map(pt => pt.count || 0);
        
        this.charts.paymentTypes = new Chart(canvas, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        'rgba(26, 43, 76, 0.8)',
                        'rgba(60, 60, 60, 0.8)',
                        'rgba(100, 100, 100, 0.8)',
                        'rgba(140, 140, 140, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                const pt = paymentTypes[context.dataIndex];
                                const revenue = pt.total_amount || 0;
                                return [
                                    `${label}: ${value} transactions`,
                                    `${percentage}% of total`,
                                    `Revenue: RM ${revenue.toFixed(2)}`
                                ];
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    }
                }
            }
        });
    },
    
    renderPaymentStatusChart(paymentStatuses) {
        const ctx = document.getElementById('paymentStatusChart');
        if (!ctx) return;
        
        ctx.innerHTML = '<canvas id="paymentStatusCanvas" class="w-full h-full"></canvas>';
        const canvas = document.getElementById('paymentStatusCanvas');
        
        const statusMap = {
            'DONE': 'Completed',
            'PARTIAL': 'Partially Paid',
            'PENDING': 'Pending'
        };
        
        const labels = paymentStatuses.map(ps => {
            const status = ps.status || 'UNKNOWN';
            return statusMap[status] || status;
        });
        
        const counts = paymentStatuses.map(ps => ps.count || 0);
        
        this.charts.paymentStatus = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',  // Green for Completed
                        'rgba(234, 179, 8, 0.8)',  // Yellow for Partial
                        'rgba(239, 68, 68, 0.8)'   // Red for Pending
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                const ps = paymentStatuses[context.dataIndex];
                                const revenue = ps.total_amount || 0;
                                return [
                                    `${label}: ${value} registrations`,
                                    `${percentage}% of total`,
                                    `Revenue: RM ${revenue.toFixed(2)}`
                                ];
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10
                        }
                    }
                }
            }
        });
    },
    
    // Fallback list renderers
    renderTopClosersList(closers) {
        const container = document.getElementById('topClosersList');
        if (!container) return;
        
        let html = '';
        closers.slice(0, 5).forEach((closer, index) => {
            const revenue = closer.total_amount || 0;
            const percentage = closer.value && closer.value > 0 ? 
                ((closer.completed || 0) / closer.value * 100).toFixed(1) : 0;
            
            html += `
                <div class="flex items-center justify-between p-2 ${index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-[#1a2b4c]">#${index + 1}</span>
                        <span class="text-sm font-medium">${closer.label || 'Unknown'}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-bold">${closer.value || 0}</span>
                        <span class="text-xs text-gray-500 ml-2">RM ${revenue.toFixed(2)}</span>
                        <span class="text-xs text-green-600 ml-2">${percentage}%</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    renderTopCoursesList(courses) {
        const container = document.getElementById('topCoursesList');
        if (!container) return;
        
        let html = '';
        courses.slice(0, 5).forEach((course, index) => {
            const revenue = course.total_amount || 0;
            const preReg = course.pre_reg_amount || 0;
            
            html += `
                <div class="flex items-center justify-between p-2 ${index % 2 === 0 ? 'bg-gray-50' : ''} rounded">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-[#1a2b4c]">#${index + 1}</span>
                        <span class="text-sm font-medium">${course.label || 'Unknown'}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-bold">${course.value || 0}</span>
                        <span class="text-xs text-gray-500 ml-2">RM ${revenue.toFixed(2)}</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    renderPaymentTypesList(paymentTypes) {
        const container = document.getElementById('paymentTypesChart');
        if (!container) return;
        
        let html = '<div class="space-y-3 p-2">';
        
        const total = paymentTypes.reduce((sum, pt) => sum + (pt.count || 0), 0);
        
        paymentTypes.forEach(pt => {
            const type = pt.type || 'NONE';
            const displayType = type === 'CASH' ? 'Cash' : 
                               type === 'ONLINE_BANKING' ? 'Online Banking' : 
                               type === 'QR_PAYMENT' ? 'QR Payment' : type;
            const count = pt.count || 0;
            const revenue = pt.total_amount || 0;
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
            
            html += `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${displayType}</span>
                        <span><span class="font-bold">${count}</span> (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-[#1a2b4c] h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 text-right">
                        Revenue: RM ${revenue.toFixed(2)}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    },
    
    renderPaymentStatusList(paymentStatuses) {
        const container = document.getElementById('paymentStatusChart');
        if (!container) return;
        
        let html = '<div class="space-y-3 p-2">';
        
        const total = paymentStatuses.reduce((sum, ps) => sum + (ps.count || 0), 0);
        const statusMap = {
            'DONE': { name: 'Completed', color: 'bg-green-600' },
            'PARTIAL': { name: 'Partially Paid', color: 'bg-yellow-600' },
            'PENDING': { name: 'Pending', color: 'bg-red-600' }
        };
        
        paymentStatuses.forEach(ps => {
            const status = ps.status || 'UNKNOWN';
            const displayStatus = statusMap[status]?.name || status;
            const colorClass = statusMap[status]?.color || 'bg-gray-600';
            const count = ps.count || 0;
            const revenue = ps.total_amount || 0;
            const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
            
            html += `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${displayStatus}</span>
                        <span><span class="font-bold">${count}</span> (${percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${colorClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 text-right">
                        Revenue: RM ${revenue.toFixed(2)}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    },
    
    close() { 
        Modal.close('statsModal'); 
    },
    
    updateStatsDisplay(stats) {
        const updateElement = (id, value, prefix = '') => { 
            const element = document.getElementById(id); 
            if (element) element.textContent = prefix + value; 
        };
        updateElement('statsTotalRegistered', stats.total_registered || 0);
        updateElement('statsPreRegAmount', formatCurrency(stats.total_pre_reg || 0));
        updateElement('statsRegAmount', formatCurrency(stats.total_reg || 0));
        updateElement('statsTotalRevenue', formatCurrency(stats.total_revenue || 0));
    },
    
    updatePaymentBreakdown(stats) {
        const total = stats.total_registered || 0;
        const completed = stats.total_completed || 0;
        const partial = stats.total_partial || 0;
        const pending = stats.total_pending || 0;
        
        const updateBreakdown = (id, count, percent) => { 
            const countElement = document.getElementById(`${id}Count`); 
            const barElement = document.getElementById(`${id}Bar`); 
            if (countElement) countElement.textContent = count; 
            if (barElement) barElement.style.width = `${percent}%`; 
        };
        
        updateBreakdown('statsCompleted', completed, total > 0 ? (completed / total) * 100 : 0);
        updateBreakdown('statsPartial', partial, total > 0 ? (partial / total) * 100 : 0);
        updateBreakdown('statsPending', pending, total > 0 ? (pending / total) * 100 : 0);
    },
    
    resetStatsDisplay() {
        this.updateStatsDisplay({ 
            total_registered: 0, 
            total_pre_reg: 0, 
            total_reg: 0, 
            total_revenue: 0 
        });
        this.updatePaymentBreakdown({ 
            total_registered: 0, 
            total_completed: 0, 
            total_partial: 0, 
            total_pending: 0 
        });
    },
    
    exportRegistrationCSV() { 
        window.open(`/attsys/api/event/${CONFIG.EVENT_ID}/export-registrations/`, '_blank'); 
        Toast.show('Exporting CSV file...'); 
    },
    
    exportRegistrationPDF() {
        const url = `/attsys/api/event/${CONFIG.EVENT_ID}/export-registrations-pdf/`;
        Toast.show('Generating PDF report... Please wait.');
        const newWindow = window.open(url, '_blank');
        if (!newWindow || newWindow.closed) {
            const link = document.createElement('a'); 
            link.href = url; 
            link.style.display = 'none'; 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link);
            Toast.show('PDF download started. Check your downloads folder.');
        }
    },
    
    refresh() {
        Toast.show('Refreshing statistics...');
        this.showAllStats();
    }
};

// ============================================
// PAGE INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('✅ ATTSYS Event Detail Initializing - Enhanced Transitions Edition with Dark Blue Accents');
    
    // Wait for modals to be injected
    setTimeout(() => {
        QRManager.init();
        AttendeeTable.initSearch();
        AttendeeTable.initFilters();
        RegistrationForm.initEventListeners();
        
        const deleteBtn = $('#confirmDeleteBtn');
        if (deleteBtn) deleteBtn.addEventListener('click', () => DeleteManager.delete());
        
        // Attach global functions
        window.showAttendeeDetails = (id) => AttendeeDetails.show(id);
        window.openRegistrationModal = (id) => RegistrationForm.open(id);
        window.saveRegistration = () => RegistrationForm.save();
        window.confirmDeleteAttendee = (id, name) => DeleteManager.showConfirmation(id, name);
        window.showAllRegistrationStats = () => StatisticsManager.showAllStats();
        window.filterAttendees = (type) => AttendeeTable.applyFilter(type);
        
        window.closeAttendeeModal = () => AttendeeDetails.close();
        window.closeRegistrationModal = () => RegistrationForm.close();
        window.closeQRModal = () => Modal.close('qrModal');
        window.closeStatsModal = () => StatisticsManager.close();
        window.closeDeleteConfirmModal = () => DeleteManager.close();
        
        window.openQRModal = () => QRManager.openModal();
        window.copyToClipboard = () => QRManager.copyUrl();
        window.showDownloadToast = () => Toast.show('QR Code download started');
        
        window.exportRegistrationCSV = () => StatisticsManager.exportRegistrationCSV();
        window.exportRegistrationPDF = () => StatisticsManager.exportRegistrationPDF();
        
        window.updateAmountPaidField = () => RegistrationForm.updateAmountPaidField();
        window.updatePaymentSummary = () => RegistrationForm.updatePaymentSummary();
        
        // Initial stats update
        RegistrationForm.updateStats();
        setInterval(() => RegistrationForm.updateStats(), 30000);
        
        // Reveal animations
        const reveals = document.querySelectorAll('.reveal');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
        }, { threshold: 0.1 });
        reveals.forEach(el => observer.observe(el));
        
        console.log('✅ All systems initialized successfully with dark blue accents');
    }, 100);
});
</script>
{% endblock %}