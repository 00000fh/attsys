{% extends 'base.html' %}

{% block content %}
<h2>{{ event.title }}</h2>
<p class="text-muted">{{ event.venue }}</p>

<a href="{% url 'export_attendees_csv' event.id %}"
   class="btn btn-outline-primary mb-3">
   Export CSV
</a>

<p>
    Status:
    {% if event.is_active %}
        <span class="badge bg-success">ACTIVE</span>
    {% else %}
        <span class="badge bg-secondary">INACTIVE</span>
    {% endif %}
</p>

{% if user.role == 'ADMIN' %}
<a href="{% url 'assign_staff' event.id %}" class="btn btn-warning mb-3">
    Assign Staff
</a>
{% endif %}

{% if request.user.role == 'STAFF' %}
<form method="post" action="{% url 'toggle_event' event.id %}">
    {% csrf_token %}
    {% if event.is_active %}
        <button class="btn btn-danger">Stop Event</button>
    {% else %}
        <button class="btn btn-success">Start Event</button>
    {% endif %}
</form>
{% endif %}

{% if event.is_active and qr_image %}
<div class="alert alert-info text-center">
    <p><strong>Scan to Check In</strong></p>
    <img src="data:image/png;base64,{{ qr_image }}" alt="QR Code">
    <p class="mt-2 small text-muted">
        {{ request.scheme }}://{{ request.get_host }}{% url 'check_in' event.id event.check_in_token %}
    </p>
</div>
{% endif %}

<p>Last Check-in:
{% if attendees.first %}
    {{ attendees.first.attended_at }}
{% else %}
    No one yet
{% endif %}
</p>

<hr>

<h4>Attendees ({{ attendees.count }})</h4>
<ul class="list-group">
    {% for a in attendees %}
        <li class="list-group-item">
            {{ a.name }} — {{ a.email }}
        </li>
    {% empty %}
        <li class="list-group-item text-muted">No attendees yet</li>
    {% endfor %}
</ul>
{% endblock %}

<hr>
<h4>Feedback</h4>

<p>
  Average Rating:
  <strong>{{ avg_rating|default:"No ratings yet" }}</strong>
</p>

{% for f in feedbacks %}
<div class="card mb-2">
  <div class="card-body">
    <strong>{{ f.name }}</strong> — {{ f.rating }}★<br>
    <small>{{ f.submitted_at }}</small>
    <p class="mt-2">{{ f.comment }}</p>
  </div>
</div>
{% empty %}
<p>No feedback yet.</p>
{% endfor %}


<canvas id="attendanceChart" height="100"></canvas>

<script>
const ctx = document.getElementById('attendanceChart');

new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for row in attendance_by_hour %}
                "{{ row.hour|date:'H:i' }}",
            {% endfor %}
        ],
        datasets: [{
            label: 'Check-ins',
            data: [
                {% for row in attendance_by_hour %}
                    {{ row.count }},
                {% endfor %}
            ],
            borderWidth: 2,
            fill: false
        }]
    }
});
</script>